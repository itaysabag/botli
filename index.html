<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>

    <meta charset="UTF-8">
    <title>BotLi</title>
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MCA4MCI+PHJlY3QgeD0iMTgiIHk9IjE4IiB3aWR0aD0iNDQiIGhlaWdodD0iNDAiIHJ4PSI4IiBmaWxsPSIjZmY0ZDRkIi8+PHJlY3QgeD0iOCIgeT0iMzAiIHdpZHRoPSI4IiBoZWlnaHQ9IjE2IiByeD0iMiIgZmlsbD0iI2ZmNGQ0ZCIvPjxyZWN0IHg9IjY0IiB5PSIzMCIgd2lkdGg9IjgiIGhlaWdodD0iMTYiIHJ4PSIyIiBmaWxsPSIjZmY0ZDRkIi8+PHJlY3QgeD0iMzYiIHk9IjgiIHdpZHRoPSI4IiBoZWlnaHQ9IjEwIiByeD0iMiIgZmlsbD0iI2ZmNGQ0ZCIvPjxjaXJjbGUgY3g9IjMwIiBjeT0iMzUiIHI9IjUiIGZpbGw9IiMxMzEzMTQiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjM1IiByPSI1IiBmaWxsPSIjMTMxMzE0Ii8+PHJlY3QgeD0iMjgiIHk9IjQ4IiB3aWR0aD0iNiIgaGVpZ2h0PSIzIiBmaWxsPSIjMTMxMzE0Ii8+PHJlY3QgeD0iMzciIHk9IjQ4IiB3aWR0aD0iNiIgaGVpZ2h0PSIzIiBmaWxsPSIjMTMxMzE0Ii8+PHJlY3QgeD0iNDYiIHk9IjQ4IiB3aWR0aD0iNiIgaGVpZ2h0PSIzIiBmaWxsPSIjMTMxMzE0Ii8+PC9zdmc+" type="image/svg+xml">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src='https://meet.jit.si/external_api.js'></script>

    <style>
        * {
            scrollbar-width: thin;
            scrollbar-color: #444746 #131314;
            box-sizing: border-box;
        }


        /* --- עיצוב סוויץ' מקצועות משודרג (מתוקן) --- */
        .subject-toggle-container {
            display: flex;
            justify-content: center; /* מבטיח שהכפתורים יהיו ממורכזים בתוך המסגרת */
            background-color: transparent;
            border: 1px solid #444746;
            border-radius: 20px;
            padding: 3px;
            margin: 10px 12px 12px 12px;
            align-items: center;
            gap: 2px;
        }

        .subject-btn {
            flex: 1; /* רוחב שווה לכולם */
            background: transparent;
            border: none; /* ביטול מסגרת לכפתור עצמו */
            color: #8e918f; /* צבע אפור כבוי */
            padding: 6px 0;
            font-size: 12px;
            font-weight: 600;
            border-radius: 16px; /* פינות עגולות פנימיות */
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            white-space: nowrap;
            /* יישור לאייקונים אם נוסיף בעתיד */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

            .subject-btn:hover {
                color: #e3e3e3;
                background-color: rgba(255, 255, 255, 0.05);
            }

            .subject-btn.active {
                background-color: #a8c7fa; /* הכחול הבהיר של הבוט */
                color: #000000; /* טקסט שחור */
                font-weight: 700;
                box-shadow: 0 1px 3px rgba(0,0,0,0.2); /* צל עדין */
            }

        /* כשאנחנו במצב קיוסק (on) - הסתרת כפתור מסך מלא */
        body.kiosk-mode #fs-global-btn {
            display: none !important;
        }

        /* הסתרת כפתור הסגירה של הדפדפן (לא תמיד עובד בכל הדפדפנים, אבל ננסה) */
        ::-webkit-scrollbar {
            display: none;
        }
        /* במצב קיוסק לפעמים רוצים להסתיר גלילה */

        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #131314;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            color: #e3e3e3;
            display: flex;
            flex-direction: row;
            user-select: none;
        }

        #ai-panel {
            display: none !important; /* חסימה לבוטלי */
            width: 350px;
            min-width: 360px;
            height: 100%;
            background-color: #131314;
            display: flex;
            flex-direction: column;
            position: relative;
            flex-shrink: 0;
            transition: opacity 0.3s;
        }

            #ai-panel.disabled-mode {
                opacity: 0.3;
                pointer-events: none;
                filter: grayscale(100%);
            }

        #resizer-v {
            display: none !important;
        }

        .resizer-vertical {
            
            width: 6px;
            height: 100%;
            background: #131314;
            cursor: col-resize;
            border-left: 1px solid #2d2e30;
            border-right: 1px solid #2d2e30;
        }

        #ide-panel {
            flex: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: #131314;
            min-width: 300px;
        }

        header, .ai-header {
            height: 50px;
            background-color: #131314;
            border-bottom: 1px solid #2d2e30;
            display: flex;
            align-items: center;
            padding: 0 15px;
            flex-shrink: 0;
        }

        header {
            justify-content: space-between;
            direction: ltr;
        }

        .ai-header {
            color: #e3e3e3;
            font-size: 16px;
            font-weight: 500;
            gap: 12px;
            justify-content: space-between;
        }

        .exam-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            color: #ff4d4d;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 14px;
            margin-right: 20px;
        }

        .exam-dot {
            width: 12px;
            height: 12px;
            background-color: red;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(255, 0, 0, 0.8);
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0.3;
            }
        }

        button {
            border: none;
            cursor: pointer;
            font-weight: 500;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
            font-family: inherit;
            color: #c4c7c5;
            background: none;
        }

            button:hover {
                background-color: #333537;
                color: white;
            }

        #runBtn {
            background-color: #2da042;
            color: white;
            padding: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

            #runBtn:disabled {
                background-color: #2d2e30;
                color: #555;
                cursor: not-allowed;
            }

        #examBtn {
            border: 1px solid #444746;
            padding: 5px 15px;
        }

            #examBtn.active {
                background-color: rgba(255, 0, 0, 0.2);
                color: #ff8080;
                border-color: #ff4d4d;
            }

        #submitBtn {
            border: 1px solid #444746;
            color: #c4c7c5;
            padding: 5px 15px;
            margin-right: 10px;
        }

        #learningBtn {
            border: 1px solid #444746;
            padding: 5px 15px;
            margin-left: 10px;
        }

            #learningBtn.active-mode {
                background-color: #a8c7fa;
                color: #000;
                border-color: #a8c7fa;
            }

        .lesson-category {
            background: #131314;
            padding: 12px 15px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 1px solid #2d2e30;
            user-select: none;
            display: flex;
            justify-content: space-between;
            direction: rtl;
            text-align: right;
        }

            .lesson-category:hover {
                background: #2d2e30;
            }

        .lesson-items {
            display: none;
            background: #1e1f20;
            direction: rtl;
        }

            .lesson-items.open {
                display: block;
            }

        .lesson-item {
            padding: 10px 20px;
            font-size: 14px;
            color: #c4c7c5;
            cursor: pointer;
            border-right: 3px solid transparent;
            transition: 0.2s;
            text-align: right;
        }

            .lesson-item:hover {
                background: #2d2e30;
                color: white;
            }

            .lesson-item.active-lesson {
                background: #26292b;
                color: #a8c7fa;
                border-right: 3px solid #a8c7fa;
            }

        .ide-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #tabs-container {
            height: 40px;
            background-color: #131314;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #2d2e30;
            overflow-x: auto;
            overflow-y: hidden;
            direction: ltr;
            padding-left: 10px;
            gap: 5px;
        }

        .tab {
            padding: 0 15px;
            height: 30px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #c4c7c5;
            background-color: transparent;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 13px;
            user-select: none;
            white-space: nowrap;
            transition: 0.2s;
        }

            .tab:hover {
                background-color: #2d2e30;
            }

            .tab.active {
                background-color: #1e1f20;
                color: #a8c7fa;
                border-bottom: 2px solid #a8c7fa;
            }

        #editor-wrapper {
            height: 60%;
            min-height: 100px;
            position: relative;
            direction: ltr;
            text-align: left;
            background-color: #1e1f20;
        }

        #editor {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .editor-controls {
            position: absolute;
            bottom: 20px;
            right: 25px;
            z-index: 20;
            display: flex;
            gap: 8px;
        }

        .zoom-btn {
            background: #2d2e30;
            border: 1px solid #444746;
            color: #e3e3e3;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        *

        .resizer-horizontal {
            height: 6px;
            width: 100%;
            background: #131314;
            cursor: row-resize;
            border-top: 1px solid #2d2e30;
            border-bottom: 1px solid #2d2e30;
        }

        #bottom-panel {
            flex: 1;
            display: flex;
            flex-direction: row;
            background-color: #131314;
            min-height: 50px;
            overflow: hidden;
        }

        #input-container {
            width: 30%;
            min-width: 100px;
            background-color: #131314;
            display: flex;
            flex-direction: column;
        }

        #output-wrapper {
            flex: 1;
            min-width: 100px;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            height: 30px;
            background: #131314;
            color: #8e918f;
            padding: 0 15px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            direction: ltr;
            border-bottom: 1px solid #2d2e30;
        }

        #stdin-input {
            flex: 1;
            background-color: #131314;
            color: #e3e3e3;
            border: none;
            padding: 10px 15px;
            resize: none;
            font-family: 'Consolas', monospace;
            outline: none;
            font-size: 14px;
            direction: ltr;
            text-align: left;
            user-select: text;
        }

        #output-container {
            flex: 1;
            background-color: #131314;
            padding: 10px 15px;
            direction: ltr;
            overflow: auto;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            color: #e3e3e3;
            white-space: pre-wrap;
            user-select: text;
        }

        #chat-window {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: #131314;
            user-select: text;
        }

        .chat-msg {
            max-width: 90%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.6;
            word-wrap: break-word;
            position: relative;
        }

        .msg-user {
            align-self: flex-start;
            background-color: #282a2c;
            color: #e3e3e3;
            border-bottom-right-radius: 4px;
        }

        .msg-ai {
            background-color: transparent;
            border-left: 2px solid #2d2e30;
            padding-left: 12px;
        }

        .msg-system {
            align-self: center;
            background-color: transparent;
            color: #8e918f;
            font-size: 12px;
            border-radius: 4px;
            padding: 5px 15px;
            text-align: center;
            width: 90%;
            border: 1px dashed #444746;
        }

        .clickable-link {
            color: #a8c7fa;
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
        }

            .clickable-link:hover {
                text-decoration: underline;
            }

        .code-block {
            position: relative;
            direction: ltr !important;
            text-align: left !important;
            background: #2b2b2b;
            padding: 15px;
            padding-top: 35px;
            margin: 10px 0;
            border-radius: 12px;
            border: 1px solid #444;
            font-family: 'Consolas', monospace;
            white-space: pre-wrap;
            color: #a8c7fa;
            display: block;
            font-size: 13px;
            unicode-bidi: isolate;
        }

        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #444;
            border: 1px solid #555;
            color: #ccc;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            padding: 4px 10px;
            font-family: sans-serif;
            transition: 0.2s;
            z-index: 10;
        }

            .copy-btn:hover {
                background: #555;
                color: white;
            }

        .chat-input-area {
            padding: 15px;
            background: #131314;
            border-top: 1px solid #2d2e30;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #ai-input {
            flex: 1;
            background: #1e1f20;
            border: 1px solid #444746;
            color: #e3e3e3;
            padding: 12px 15px;
            border-radius: 24px;
            outline: none;
            text-align: right;
            direction: rtl;
            transition: 0.2s;
            user-select: text;
        }

            #ai-input:focus {
                border-color: #a8c7fa;
            }

        #send-ai-btn, #exercises-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            justify-content: center;
        }

        #send-ai-btn {
            background: #a8c7fa;
            color: #000;
        }

        #exercises-btn {
            background: #2d2e30;
            color: #c4c7c5;
        }

            #exercises-btn:hover {
                background: #444746;
                color: white;
            }

        .typing-indicator {
            display: none;
            padding: 10px 20px;
            background: transparent;
            color: #a8c7fa;
            font-size: 12px;
            font-weight: 600;
            text-align: right;
            border-top: 1px solid #444;
            border-bottom: 1px solid #1e1e1e;
            align-items: center;
            gap: 10px;
        }

        .error-text {
            color: #f2b8b5;
        }

        .output-text {
            color: #e3e3e3;
        }

        .success-msg {
            color: #6dd58c;
        }

        #context-menu {
            display: none;
            position: absolute;
            z-index: 2000;
            background: #252526;
            border: 1px solid #454545;
            width: 150px;
            border-radius: 8px;
            padding: 5px 0;
            direction: ltr;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .ctx-item {
            padding: 8px 15px;
            color: #ccc;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .ctx-item:hover {
                background-color: #004a77;
                color: white;
            }

        #modal-overlay, #rename-overlay, #exercise-overlay, #submit-overlay, #login-overlay, #universal-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 21000;
            justify-content: center;
            align-items: center;
            direction: ltr;
            backdrop-filter: blur(4px);
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            direction: ltr;
        }

        .btn-create-small {
            background: #a8c7fa;
            color: #000;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            font-size: 13px;
            height: 42px;
        }

            .btn-create-small:hover {
                opacity: 0.9;
            }

        .btn-login-centered {
            width: 150px;
            margin: 20px auto 0 auto;
            display: block;
        }

        .modal-box {
            background: #1e1f20;
            padding: 25px;
            border-radius: 12px;
            width: 320px;
            border: 1px solid #444746;
            color: #e0e0e0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-align: right;
            direction: rtl;
            position: relative;
            overflow: visible !important;
            margin-top: 40px;
        }

            .modal-box h3 {
                margin-top: 0;
                color: #fff;
                font-weight: 500;
                text-align: center;
            }

        .modal-input, .modal-select {
            width: 100%;
            padding: 10px;
            margin: 15px 0;
            background: #131314;
            border: 1px solid #444746;
            color: white;
            box-sizing: border-box;
            border-radius: 6px;
            outline: none;
            text-align: right;
            direction: rtl;
        }

            .modal-input:focus, .modal-select:focus {
                border-color: #a8c7fa;
            }

            .modal-input:disabled {
                background: #2d2e30;
                color: #8e918f;
                border-color: #444;
                cursor: not-allowed;
            }

        .modal-btns {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .modal-btn-ok {
            background: #a8c7fa;
            color: #000;
            border-radius: 18px;
            padding: 8px 24px;
            border: none;
            font-weight: 500;
            cursor: pointer;
        }

        .modal-btn-cancel {
            background: transparent;
            color: #a8c7fa;
            border-radius: 18px;
            padding: 8px 24px;
            border: 1px solid #444746;
            cursor: pointer;
        }

        #login-overlay {
            display: flex;
            z-index: 22000;
        }

        #exam-lockdown-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 19000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: red;
            text-align: center;
        }

            #exam-lockdown-overlay h1 {
                font-size: 40px;
                margin-bottom: 20px;
            }

            #exam-lockdown-overlay p {
                font-size: 20px;
                color: #ccc;
            }

        #remote-lock-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000;
            z-index: 21000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .exercise-list-box {
            background: #1e1f20;
            border-radius: 12px;
            width: 500px;
            max-height: 80%;
            border: 1px solid #444746;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            direction: rtl;
            text-align: right;
        }

        .ex-header {
            padding: 20px;
            background: #131314;
            color: white;
            font-weight: bold;
            border-bottom: 1px solid #2d2e30;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ex-content {
            overflow-y: auto;
            padding: 10px;
            flex: 1;
        }

        details {
            margin-bottom: 10px;
            border: 1px solid #2d2e30;
            border-radius: 8px;
            overflow: hidden;
            background: #131314;
        }

        summary {
            background: #1e1f20;
            color: #e3e3e3;
            padding: 12px;
            cursor: pointer;
            font-weight: 500;
            user-select: none;
            outline: none;
        }

            summary:hover {
                background: #2d2e30;
            }

        .ex-item {
            background: #131314;
            padding: 12px 15px;
            border-bottom: 1px solid #2d2e30;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

            .ex-item:last-child {
                border-bottom: none;
            }

            .ex-item:hover {
                background: #1e1f20;
                border-right: 3px solid #a8c7fa;
                border-left: none;
            }

        .ex-title {
            font-size: 14px;
            color: #e3e3e3;
            font-weight: 500;
        }

        .ex-desc {
            font-size: 12px;
            color: #8e918f;
        }

        .ai-tools {
            display: flex;
            gap: 10px;
        }

        .project-list-container {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #444746;
            background: #131314;
            border-radius: 6px;
            margin-top: 5px;
        }

        .project-item {
            padding: 12px 15px;
            border-bottom: 1px solid #2d2e30;
            cursor: pointer;
            color: #e3e3e3;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
        }

            .project-item:hover {
                background-color: #2d2e30;
                color: #a8c7fa;
            }

            .project-item i {
                margin-left: 10px;
                color: #a8c7fa;
            }

        .status-loading {
            color: #a8c7fa;
        }

        .status-success {
            color: #6dd58c;
            font-weight: bold;
        }

        .status-error {
            color: #f2b8b5;
        }

        .delete-btn {
            color: #ff4d4d;
            padding: 5px 10px;
            border-radius: 4px;
            transition: 0.2s;
        }

            .delete-btn:hover {
                background: rgba(255, 77, 77, 0.2);
            }

        #universal-modal {
            z-index: 99999 !important;
        }

        header button:disabled {
            color: #444746 !important;
            cursor: not-allowed;
            opacity: 0.5;
        }

            header button:disabled:hover {
                background-color: transparent !important;
                color: #444746 !important;
            }

        #stdin-input:disabled {
            background-color: #0b0b0c;
            color: #555;
            cursor: not-allowed;
        }

        .list-busy {
            pointer-events: none;
            opacity: 0.4;
            filter: grayscale(1);
            transition: 0.3s;
        }

        .lib-link {
            color: #8ab4f8;
            font-size: 13px;
            cursor: pointer;
            text-decoration: none;
            margin-top: 10px;
            display: inline-block;
            transition: 0.2s;
        }

            .lib-link:hover {
                text-decoration: underline;
                color: #aecbfa;
            }

        #lesson-body {
            line-height: 1.6;
            font-size: 16px;
            color: #e0e0e0;
            max-width: 900px;
            white-space: normal;
        }

            #lesson-body h1 {
                color: #a8c7fa;
                font-size: 2.2em;
                margin: 0 0 10px 0;
                line-height: 1.2;
                font-weight: 700;
            }

            #lesson-body h3 {
                font-size: 1.3em;
                color: #e3e3e3;
                border-bottom: 1px solid #2d2e30;
                padding-bottom: 5px;
                margin-top: 15px;
                margin-bottom: 5px;
                font-weight: 600;
            }

            #lesson-body hr {
                border: 0;
                border-top: 1px solid #444;
                margin: 15px 0;
            }

            #lesson-body p {
                margin: 5px 0;
            }

            #lesson-body strong {
                color: #fff;
                font-weight: 700;
            }

            #lesson-body ul {
                padding-right: 25px;
                margin: 10px 0;
            }

            #lesson-body li {
                margin-bottom: 6px;
            }

            #lesson-body code {
                display: inline;
                vertical-align: baseline;
                background-color: rgba(168, 199, 250, 0.1);
                border: 1px solid rgba(168, 199, 250, 0.2);
                color: #a8c7fa;
                padding: 0 4px;
                border-radius: 4px;
                font-family: 'Consolas', 'Courier New', monospace;
                font-size: 0.95em;
                direction: ltr;
                unicode-bidi: isolate;
            }

        /* עיצוב עבור iframe של גוגל דוקס עם מצב לילה */
        .doc-frame {
            width: 100%;
            height: 800px;
            min-height: 60vh;
            border: none;
            border-radius: 8px;
            /* הטריק: הופך צבעים (אינוורסיה) ושומר על גוונים הגיוניים */
            filter: invert(1) hue-rotate(180deg);
            /* מונע הבהוב לבן בטעינה */
            background: #fff;
        }
        /* --- עיצוב למצב מכווץ של הבוט --- */
        #ai-panel.collapsed {
            width: 60px !important; /* רוחב הפס הצר */
            min-width: 60px !important;
            transition: width 0.3s ease;
        }

            /* הסתרת התוכן הרגיל כשהפאנל מכווץ */
            #ai-panel.collapsed .ai-header .ai-tools,
            #ai-panel.collapsed .ai-header span, /* מסתיר את המילה בוטלי */
            #ai-panel.collapsed #chat-window,
            #ai-panel.collapsed .chat-input-area,
            #ai-panel.collapsed .typing-indicator {
                display: none !important;
            }

            /* התאמת ההדר במצב מכווץ */
            #ai-panel.collapsed .ai-header {
                justify-content: center;
                padding: 0;
            }

                #ai-panel.collapsed .ai-header i {
                    font-size: 24px;
                    cursor: pointer;
                    padding: 10px;
                }

        /* תפריט הצד המכווץ (הספר) */
        .collapsed-tools {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
        }

        #ai-panel.collapsed .collapsed-tools {
            display: flex;
        }

        .side-icon-btn {
            background: none;
            border: none;
            color: #c4c7c5;
            font-size: 20px;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: 0.2s;
        }

            .side-icon-btn:hover {
                background: #2d2e30;
                color: #a8c7fa;
            }
        /* --- תיקון סימטריה לכפתורי הדר --- */

        /* הגדרה משותפת לכל הכפתורים בהדר לקבלת גובה אחיד */
        #submitBtn, #examBtn, #fs-global-btn {
            height: 36px !important; /* גובה קבוע וזהה לכולם */
            min-height: 36px; /* מניעת כיווץ */
            display: inline-flex; /* שימוש בפלקס ליישור התוכן */
            align-items: center;
            justify-content: center;
            border: 1px solid #444746;
            background-color: transparent;
            color: #c4c7c5;
            transition: all 0.2s ease;
            box-sizing: border-box;
            margin: 0 5px; /* רווח אחיד ביניהם */
        }

        /* עיצוב לכפתורים עם טקסט (הגשה, מצב מבחן) - צורת "גלולה" */
        #submitBtn, #examBtn {
            border-radius: 18px; /* פינות עגולות (חצי מהגובה) */
            padding: 0 16px !important; /* ריפוד אחיד בצדדים */
            gap: 8px; /* רווח קבוע בין האייקון לטקסט */
        }

        /* עיצוב לכפתור האייקון (מסך מלא) - צורת עיגול מושלם */
        #fs-global-btn {
            width: 36px !important; /* רוחב שווה לגובה */
            padding: 0 !important; /* ביטול ריפוד כדי למרכז */
            border-radius: 50%; /* עיגול מלא */
        }

            /* אפקט מעבר עכבר אחיד */
            #submitBtn:hover, #examBtn:hover, #fs-global-btn:hover {
                background-color: #333537;
                color: white;
                border-color: #888;
            }

        /* עיצוב כפתור הודעות פעיל */
        #msg-btn.active {
            background-color: #a8c7fa !important;
            color: #000000 !important;
            border-color: #a8c7fa !important;
        }

        /* סימון כפתור מבחן פעיל */
        #examBtn.active {
            background-color: rgba(255, 77, 77, 0.15);
            color: #ff8080;
            border-color: #ff4d4d;
        }

        /* מחלקה למצב מסך מלא של השיעור בלבד */
        #lesson-panel.lesson-fullscreen {
            position: fixed !important;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 20000; /* מעל הכל */
        }

        /* מצב מסך מלא לעורך + לשוניות */
        .ide-body.editor-fullscreen {
            position: fixed !important;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 20000;
            background: #131314;
            display: flex !important;
            flex-direction: column;
        }

            /* במצב מסך מלא - העורך יתפוס את כל הגובה שנותר מתחת ללשוניות */
            .ide-body.editor-fullscreen #editor-wrapper {
                flex: 1 !important;
                height: auto !important;
            }

            /* הסתרת הקונסול והמפריד בזמן מסך מלא של העורך */
            .ide-body.editor-fullscreen .resizer-horizontal,
            .ide-body.editor-fullscreen #bottom-panel {
                display: none !important;
            }

        /* --- עיצוב מתג מצבים (עורך / שיעורים) --- */
        .mode-toggle-container {
            display: flex;
            background-color: transparent; /* רקע שקוף */
            border: 1px solid #444746;
            border-radius: 18px; /* רדיוס חיצוני */
            padding: 2px; /* רווח קטן בין המסגרת לכפתורים */
            height: 36px; /* גובה קבוע זהה לשאר הכפתורים */
            box-sizing: border-box;
            align-items: center;
        }

        .mode-btn {
            border: none;
            background: transparent;
            color: #8e918f;
            padding: 0 15px;
            height: 100%; /* תופס את כל הגובה הפנימי */
            border-radius: 16px; /* רדיוס פנימי קטן ב-2px מהחיצוני */
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

            .mode-btn:hover {
                color: #e3e3e3;
            }

            /* המצב הפעיל */
            .mode-btn.active {
                background-color: #a8c7fa; /* כחול בהיר */
                color: #000000; /* טקסט שחור */
                font-weight: 700;
                box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            }

            /* ביטול מצב פעיל כשהכפתור מושבת (במבחן) */
            .mode-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

        /* במצב מסך מלא - הסתר את תפריט הצד */
        #lesson-panel.lesson-fullscreen #lesson-sidebar {
            display: none !important;
        }

        /* במצב מסך מלא - הרקע של התוכן */
        #lesson-panel.lesson-fullscreen #lesson-content {
            background-color: #131314;
        }

        /* --- עיצוב אחיד לכפתורים עגולים בהדר --- */
        .header-circle-btn {
            width: 36px !important;
            height: 36px !important;
            min-width: 36px !important;
            border-radius: 50% !important;
            padding: 0 !important;
            display: flex !important;
            justify-content: center;
            align-items: center;
            border: 1px solid #444746 !important;
            background: transparent !important;
            color: #c4c7c5 !important;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 0 !important; /* המרווח ינוהל ע"י הקונטיינר */
            position: relative; /* עבור תגית ההתראה */
        }

            .header-circle-btn:hover {
                background-color: #333537 !important;
                color: white !important;
                border-color: #888 !important;
            }


        /* יצירת המשולש החיצוני (המסגרת התכולה) */
        #msg-bubble::before {
            content: "";
            position: absolute;
            top: -11px;
            right: 250px; /* שיניתי מ-55px ל-220px כדי להזיז שמאלה */
            border-width: 0 11px 11px 11px;
            border-style: solid;
            border-color: transparent transparent #a8c7fa transparent;
            z-index: 30001;
        }

        /* יצירת המשולש הפנימי (הרקע הכהה - לכיסוי) */
        #msg-bubble::after {
            content: "";
            position: absolute;
            top: -9px;
            right: 250px; /* חייב להיות זהה ל-right של הלמעלה */
            border-width: 0 11px 11px 11px;
            border-style: solid;
            border-color: transparent transparent #1e1f20 transparent;
            z-index: 30002;
        }

        /* עיצוב כפתור ה-X בחלון ההודעות */
        .msg-close-x {
            position: absolute;
            top: 12px;
            left: 15px;
            font-size: 18px;
            color: #888;
            cursor: pointer;
            transition: color 0.2s;
            z-index: 50; /* שיהיה מעל הכל */
        }

            .msg-close-x:hover {
                color: #ff4d4d; /* הופך לאדום במעבר עכבר */
            }


        #runBtn {
            box-shadow: none !important;
        }

        /* --- CSS חדש עבור כפתור הלוויין --- */

        /* עוטף בגודל הכפתורים הסטנדרטי שלך */
        .run-group-wrapper {
            position: relative;
            width: 36px; /* תואם ל-header-circle-btn */
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* הלוויין - כפתור העין */
        #visualizeBtn {
            position: absolute !important;
            bottom: -4px !important; /* בולט מעט החוצה */
            right: -4px !important;
            width: 18px !important; /* קטן ועדין */
            height: 18px !important;
            min-width: 0 !important;
            padding: 0 !important;
            background-color: #1e1f20 !important; /* רקע כהה תואם */
            border: 1px solid #a8c7fa !important; /* מסגרת תכולה עדינה */
            color: #a8c7fa !important;
            border-radius: 50% !important;
            z-index: 10;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

            #visualizeBtn i {
                font-size: 10px !important;
            }

            #visualizeBtn:hover {
                background-color: #a8c7fa !important;
                color: #000 !important;
                transform: scale(1.1);
            }


        /* עיצוב בועות תגובה בפורום */
        .forum-comment {
            background: #2d2e30;
            color: #e3e3e3;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            border-right: 3px solid #a8c7fa;
            margin-bottom: 8px;
            direction: rtl;
        }

        /* --- אנימציית פעימה מאוזנת (גרסה סופית) --- */
        @keyframes pulse-red-dot {
            0% {
                transform: scale(1);
                opacity: 1;
                text-shadow: 0 0 0 rgba(255, 0, 0, 0);
            }

            50% {
                transform: scale(1.35);
                opacity: 0.85;
                text-shadow: 0 0 5px rgba(255, 0, 0, 0.6);
            }
            /* גדל ל-135% עם זוהר עדין */
            100% {
                transform: scale(1);
                opacity: 1;
                text-shadow: 0 0 0 rgba(255, 0, 0, 0);
            }
        }

        .pulse-dot {
            display: inline-block;
            animation: pulse-red-dot 1.5s infinite ease-in-out; /* קצב בינוני: 1.5 שניות */
            vertical-align: middle;
            margin-left: 5px;
            margin-right: 2px;
        }

        /* דף מחברת משבצות לצייר */
        /* דף מחברת משבצות לצייר */
        #canvas-container {
            background-color: #1e1f20 !important;
            background-image: linear-gradient(to right, #2d2e30 1px, transparent 1px), linear-gradient(to bottom, #2d2e30 1px, transparent 1px) !important;
            background-size: 25px 25px !important;
        }

        #paint-canvas {
            background: transparent !important;
            touch-action: none; /* מונע מהדפדפן לגלול את הדף כשמנסים לצייר */
        }

        .zoom-btn.active-tool {
            background-color: #a8c7fa !important;
            color: #131314 !important;
        }

    </style>
</head>
<body>

    <div id="teacher-chat-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 25000; justify-content: center; align-items: center; backdrop-filter: blur(2px);">
        <div class="modal-box" style="width: 400px; height: 500px; display: flex; flex-direction: column; padding: 0; overflow: hidden;">
            <div style="background: #131314; padding: 15px; border-bottom: 1px solid #2d2e30; display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: bold; color: #a8c7fa;"><i class="fa-solid fa-chalkboard-user"></i> צ'אט עם המורה</span>
                <i class="fa-solid fa-xmark" onclick="document.getElementById('teacher-chat-overlay').style.display='none'" style="cursor: pointer; color: #888;"></i>
            </div>

            <div id="t-chat-msgs" style="flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #1e1f20;"></div>

            <div style="padding: 10px; background: #131314; border-top: 1px solid #2d2e30; display: flex; gap: 10px; border-radius: 0 0 12px 12px;">
                <input type="text" id="t-chat-input" placeholder="כתוב הודעה למורה..." style="flex: 1; background: #2d2e30; border: none; color: white; padding: 10px; border-radius: 20px; outline: none;">
                <button onclick="sendTeacherMsg()" style="background: #a8c7fa; color: black; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0;"><i class="fa-solid fa-paper-plane" style="margin-right: 2px;"></i></button>
            </div>
        </div>
    </div>

    <div id="forum-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 27000; justify-content: center; align-items: center; backdrop-filter: blur(4px);">

        <div class="modal-box" style="width: 90%; max-width: 800px; height: 85vh; display: flex; flex-direction: column; padding: 0; overflow: hidden; border-radius: 12px;">
            <div style="background: #131314; padding: 10px 15px; border-bottom: 1px solid #2d2e30; display: flex; justify-content: space-between; align-items: center; border-radius: 4px 4px 0 0;">
                <span style="font-weight: bold; color: #a8c7fa; font-size: 16px;"><i class="fa-solid fa-users"></i> פורום כיתתי</span>

                <div style="display: flex; gap: 12px; align-items: center;">
                    <button id="new-thread-btn" onclick="window.openNewThreadModal()"
                            style="height: 32px; border: 1px solid #444746; background: transparent; color: #c4c7c5; border-radius: 16px; padding: 0 15px; font-size: 13px; font-weight: 500; transition: 0.2s; display: flex; align-items: center; gap: 8px;">
                        <i class="fa-solid fa-plus" style="color: #a8c7fa;"></i> נושא חדש
                    </button>

                    <div style="width: 1px; height: 20px; background: #2d2e30; margin: 0 5px;"></div>

                    <i class="fa-solid fa-xmark" onclick="closeForum()" style="cursor: pointer; color: #888; font-size: 20px; transition: 0.2s;" onmouseover="this.style.color='#ff4d4d'" onmouseout="this.style.color='#888'"></i>
                </div>
            </div>

            <div id="forum-content" style="flex: 1; overflow-y: auto; padding: 20px; background: #1e1f20; display: flex; flex-direction: column; gap: 15px; border-radius: 0 0 12px 12px;">
            </div>
        </div>
    </div>

    <div id="new-thread-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 28000; justify-content: center; align-items: center; backdrop-filter: blur(4px);">
        <div class="modal-box" style="width: 380px; padding: 0; overflow: visible; background: #1e1f20; border: 1px solid #444746; border-radius: 4px;">

            <div style="background: #131314; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2d2e30;">
                <span style="font-weight: bold; color: #a8c7fa; font-size: 16px;">פתיחת נושא חדש</span>
                <i class="fa-solid fa-xmark" onclick="document.getElementById('new-thread-overlay').style.display='none'" style="cursor: pointer; color: #ccc; font-size: 18px;"></i>
            </div>

            <div style="padding: 25px; text-align: center;">
                <input type="text" id="thread-title" class="modal-input" placeholder="כותרת השאלה / נושא" style="margin-top: 0;">
                <textarea id="thread-desc" class="modal-input" placeholder="פירוט נוסף..." style="height: 120px; resize: none; font-family: inherit; margin-top: 10px;"></textarea>

                <div class="modal-btns" style="justify-content: center; margin-top: 20px;">
                    <button onclick="window.submitNewThread()"
                            style="width: 100%; background: #a8c7fa; color: #000; border: none; padding: 12px; font-weight: bold; font-size: 16px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s;">
                        <i class="fa-solid fa-paper-plane"></i> פרסם בפורום
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="universal-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 99999; justify-content: center; align-items: center; backdrop-filter: blur(4px);">
        <div class="modal-box" style="width: 350px; padding: 0; overflow: visible; background: #1e1f20; border: 1px solid #444746; border-radius: 4px; text-align: center;">

            <div style="background: #131314; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2d2e30;">
                <h3 id="u-modal-title" style="margin: 0; font-weight: bold; color: #a8c7fa; font-size: 16px;">הודעת מערכת</h3>
                <i class="fa-solid fa-xmark" onclick="document.getElementById('u-modal-cancel').click()" style="cursor: pointer; color: #ccc; font-size: 18px;"></i>
            </div>

            <div style="padding: 25px;">
                <p id="u-modal-text" style="font-size:15px; color:#e0e0e0; white-space:pre-wrap; text-align:center; direction:rtl; margin-bottom: 20px; margin-top: 0;"></p>

                <input type="text" id="u-modal-input" class="modal-input" style="display:none; margin-bottom: 20px;">

                <div class="modal-btns" style="justify-content: center; gap: 10px;">
                    <button id="u-modal-cancel" class="modal-btn-cancel" style="display:none;">ביטול</button>
                    <button id="u-modal-ok" class="modal-btn-ok" style="min-width: 80px;">אישור</button>
                </div>
            </div>
        </div>
    </div>


    <div id="painter-ctx-menu" style="display: none; position: absolute; z-index: 30000; background: #252526; border: 1px solid #454545; width: 120px; border-radius: 8px; padding: 5px 0; direction: rtl; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
        <div class="ctx-item" onclick="window.copyPainter()"><i class="fa-solid fa-copy"></i> העתק</div>
        <div class="ctx-item" onclick="window.cutPainter()"><i class="fa-solid fa-scissors"></i> גזור</div>
    </div>

    <div id="remote-lock-overlay">
        <div style="text-align: center;">
            <i class="fa-solid fa-cloud-lock" style="font-size: 60px; color: #ff4d4d; margin-bottom: 20px;"></i>
            <h1 style="color: white; margin: 0 0 10px 0;">המערכת בהשהיה</h1>
            <p style="color: #aaa; font-size: 18px;">המורה נעל את הגישה למערכת כרגע.<br>המסך ייפתח אוטומטית כשהנעילה תוסר.</p>
            <div style="margin-top: 20px; color: #a8c7fa; font-size: 12px;">
                <i class="fa-solid fa-sync fa-spin"></i> ממתין לשחרור...
            </div>
        </div>
    </div>

    <div id="login-overlay" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 22000; justify-content: center; align-items: center; backdrop-filter: blur(4px);">
        <div class="modal-box" style="width: 320px; padding: 0; overflow: visible; background: #1e1f20; border: 1px solid #444746; border-radius: 4px;">

            <div style="background: #131314; padding: 15px; border-bottom: 1px solid #2d2e30; text-align: center;">
                <h3 style="margin: 0; font-weight: bold; color: #a8c7fa; font-size: 18px;"><i class="fa-solid fa-user-lock"></i> כניסה למערכת</h3>
            </div>

            <div style="padding: 25px;">
                <label style="font-size: 12px; color: #aaa; display:block; text-align:right;">שם משתמש:</label>
                <input type="text" id="login-user" class="modal-input" placeholder="שם משתמש" style="margin-top:5px;">
                <label style="font-size: 12px; color: #aaa; display:block; text-align:right;">סיסמה:</label>
                <input type="password" id="login-pass" class="modal-input" placeholder="סיסמה" style="margin-top:5px;">

                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; min-height: 20px;">
                    <div id="login-msg" style="color: #ff4d4d; font-size: 13px; max-width: 70%;"></div>

                    <a href="https://forms.gle/KsvNkkHprYXxxKWTA" target="_blank"
                       style="color: #a8c7fa; font-size: 13px; text-decoration: none; border-bottom: 1px solid #a8c7fa; transition: opacity 0.2s; white-space: nowrap;"
                       onmouseover="this.style.opacity='0.7'"
                       onmouseout="this.style.opacity='1'">
                        הרשמה
                    </a>
                </div>

                <button id="login-btn" class="modal-btn-ok btn-login-centered">התחבר</button>
            </div>


        </div>
    </div>

    <div id="exam-lockdown-overlay">
        <h1><i class="fa-solid fa-lock"></i> המבחן ננעל</h1>
        <p>זוהתה יציאה מהחלון יותר מ-3 פעמים.<br>אנא קרא למורה לשחרור הנעילה.</p>
        <button id="unlock-btn" style="margin-top:20px; border:1px solid #555; padding:10px 20px; background:transparent; color:#ccc; cursor:pointer;">שחרור נעילה (מורה)</button>
    </div>

    <div id="submit-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 21000; justify-content: center; align-items: center; backdrop-filter: blur(4px);">
        <div class="modal-box" style="width: 380px; padding: 0; overflow: visible; background: #1e1f20; border: 1px solid #444746; border-radius: 4px;">

            <div style="background: #131314; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2d2e30;">
                <span style="font-weight: bold; color: #a8c7fa; font-size: 16px;">הגשת תרגיל</span>
                <i class="fa-solid fa-xmark" onclick="document.getElementById('submit-cancel-btn').click()" style="cursor: pointer; color: #ccc; font-size: 18px;"></i>
            </div>

            <div style="padding: 25px; text-align: center;">
                <p id="modal-title-submit" style="font-size: 16px; color: #e0e0e0; margin-top: 0; margin-bottom: 25px; font-weight: 500;"></p>

                <div id="submit-status" style="font-size:14px; margin-bottom:20px; min-height:20px;"></div>
                <input type="hidden" id="submit-student-name">

                <button id="submit-confirm-btn"
                        style="width: 100%; background: #a8c7fa; color: #000; border: none; padding: 12px; font-weight: bold; font-size: 16px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s;"
                        onmouseover="this.style.opacity='0.9'"
                        onmouseout="this.style.opacity='1'">
                    <i class="fa-solid fa-paper-plane"></i> הגש את התרגיל לבדיקה
                </button>

                <button id="submit-cancel-btn" style="display: none;"></button>
            </div>
        </div>
    </div>

    <div id="exam-start-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 21000; justify-content: center; align-items: center; backdrop-filter: blur(4px);">
        <div class="modal-box" style="width: 380px; padding: 0; overflow: visible; background: #1e1f20; border: 1px solid #444746; border-radius: 4px;">

            <div style="background: #131314; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2d2e30;">
                <span style="font-weight: bold; color: #a8c7fa; font-size: 16px;">מצב מבחן</span>
                <i class="fa-solid fa-xmark" onclick="document.getElementById('exam-start-overlay').style.display='none'" style="cursor: pointer; color: #ccc; font-size: 18px;"></i>
            </div>

            <div style="padding: 25px; text-align: center;">
                <p id="exam-start-title" style="font-size: 16px; color: #e0e0e0; margin-top: 0; margin-bottom: 15px; font-weight: 500;"></p>

                <p style="font-size: 13px; color: #aaa; margin-bottom: 25px;">
                    שים לב: המערכת תינעל, העתק-הדבק יחסם, וכל יציאה מהמסך תדווח למורה.
                </p>

                <button onclick="confirmExamStart()"
                        style="width: 100%; background: #a8c7fa; color: #000; border: none; padding: 12px; font-weight: bold; font-size: 16px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s;"
                        onmouseover="this.style.opacity='0.9'"
                        onmouseout="this.style.opacity='1'">
                    <i class="fa-solid fa-lock"></i> התחל מבחן כעת
                </button>
            </div>
        </div>
    </div>

    <div id="ai-panel" class="collapsed">
        <div class="ai-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <i class="fa-solid fa-robot" style="color: #ff4d4d; cursor: pointer;" onclick="toggleAiCollapse()" title="כווץ/הרחב"></i>
                <span>בּוֹט·לִי</span>
            </div>
            <div class="ai-tools">
                <button id="clear-chat-btn" title="נקה שיחה"><i class="fa-solid fa-trash"></i></button>
            </div>
        </div>

        <div class="collapsed-tools">
            <button id="side-book-btn" class="side-icon-btn" title="ספר תרגילים" onclick="openExerciseModal()">
                <i class="fa-solid fa-book"></i>
            </button>
        </div>

        <div id="chat-window">
            <div class="chat-msg msg-ai">
                שלום! אני בּוֹט·לִי. 👋<br>
                אפשר לבחור תרגיל <span id="open-ex-link" class="clickable-link">מספריית התרגילים <i class="fa-solid fa-book"></i></span>, או לשאול שאלות על הקוד.<br>
                טיפ: השתמש במילים <b>"רמז"</b> או <b>"הסבר"</b> כדי לקבל עזרה ממוקדת.
            </div>
        </div>
        <div class="typing-indicator" id="ai-loading">
            <i class="fa-solid fa-circle-notch fa-spin"></i> חושב...
        </div>
        <div class="chat-input-area">
            <button id="exercises-btn" title="בחר תרגיל"><i class="fa-solid fa-book"></i></button>
            <input type="text" id="ai-input" placeholder="כתוב כאן...">
            <button id="send-ai-btn"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <div class="resizer-vertical" id="resizer-v"></div>

    <div id="ide-panel">

        <header>
            <div id="left-header-group" style="display: flex; align-items: center; gap: 20px;">

                <div id="editor-tools" style="display: flex; gap: 10px; align-items: center;">

                    <div class="run-group-wrapper">
                        <button id="runBtn" class="header-circle-btn" title="הרצה"><i id="btnIcon" class="fa-solid fa-play"></i></button>

                        <button id="visualizeBtn" onclick="openVisualizer()" title="המחשת זיכרון (Python Tutor)">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                    </div>

                    <button id="btn-save" class="header-circle-btn" title="שמור פרויקט"><i class="fa-solid fa-floppy-disk"></i></button>
                    <button id="btn-load" class="header-circle-btn" title="טען פרויקט"><i class="fa-solid fa-folder-open"></i></button>
                </div>

                <div style="width: 1px; height: 18px; background: #2d2e30;"></div>
				
                <div id="exam-tools" style="display: flex; align-items: center; gap: 10px;">
				
                    <button id="submitBtn" title="הגשת עבודה"><i class="fa-solid fa-paper-plane"></i> הגשה</button>
					
                    <button id="examBtn" title="מצב מבחן"><i class="fa-solid fa-lock"></i> מצב מבחן</button>
					
                    <div class="exam-indicator" id="examIndicator"><div class="exam-dot"></div>מצב מבחן</div>
					
                </div>
				
            </div>

            <div id="right-header-group" style="display: flex; align-items: center; gap: 10px; position: relative;">

                <button id="calc-btn" class="header-circle-btn" onclick="toggleCalculator()" title="מחשבון מדעי">
                    <i class="fa-solid fa-calculator"></i>
                </button>

                <button id="scratchpad-btn" class="header-circle-btn" onclick="toggleScratchpad()" title="דף טיוטה">
                    <i class="fa-solid fa-pen-to-square"></i>
                </button>
                <!--
    <button id="video-class-btn" class="header-circle-btn" onclick="toggleVideoClass()" title="שיעור וידאו חי">
        <i class="fa-solid fa-video"></i>
    </button>
    -->
                <!--
    <button id="forum-btn" class="header-circle-btn" onclick="openForum()" title="פורום כיתתי">
        <i class="fa-solid fa-users"></i>
    </button>
    -->
                <button id="teacher-chat-btn" class="header-circle-btn" onclick="openTeacherChat()" title="צ'אט עם המורה">
                    <i class="fa-solid fa-comments"></i>
                    <span id="t-chat-badge" style="display: none; position: absolute; top: 0; right: 0; width: 10px; height: 10px; background: #ff4d4d; border-radius: 50%; border: 2px solid #131314;"></span>
                </button>

                <div id="msg-bubble" style="display: none; position: absolute; top: 50px; right: 0; width: 300px; background: #1e1f20; border: 1px solid #a8c7fa; padding: 15px; border-radius: 8px; z-index: 30000; text-align: right; direction: rtl; box-shadow: 0 5px 20px rgba(0,0,0,0.5); color: #e3e3e3; font-size: 14px; line-height: 1.5;">
                    <i class="fa-solid fa-xmark msg-close-x" onclick="toggleMessageBubble()" title="סגור"></i>

                    <div style="font-weight: bold; color: #a8c7fa; margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 5px;">הודעה מהמורה:</div>
                    <div id="msg-bubble-content"></div>
                </div>

                <button id="msg-btn" class="header-circle-btn" onclick="toggleMessageBubble()" title="הודעות מהמורה">
                    <i class="fa-solid fa-envelope"></i>
                </button>

                <button id="fs-global-btn" class="header-circle-btn" onclick="toggleGlobalFullScreen()" title="מסך מלא (F11)">
                    <i class="fa-solid fa-expand"></i>
                </button>

                <div class="mode-toggle-container" style="margin-right: 5px;">
                    <button id="mode-editor-btn" class="mode-btn active" onclick="switchViewMode('editor')">
                        <i class="fa-solid fa-code"></i> עורך
                    </button>
                    <button id="mode-lesson-btn" class="mode-btn" onclick="switchViewMode('lesson')">
                        <i class="fa-solid fa-graduation-cap"></i> שיעורים
                    </button>
                </div>
            </div>
        </header>



        <div id="lesson-panel" style="display: none; flex: 1; overflow: hidden; background-color: #131314; flex-direction: row-reverse; position: relative;">

            <div id="lesson-sidebar" style="width: 250px; background: #1e1f20; border-left: 1px solid #2d2e30; display: flex; flex-direction: column;">

                <div style="padding: 15px; font-weight: bold; border-bottom: 1px solid #2d2e30; text-align: right;">תוכן עניינים</div>

                <div class="subject-toggle-container">
                    <button id="btn-subj-cs" class="subject-btn active" onclick="setSubjectMode('CS')">
                        <i class="fa-solid fa-code"></i> מדמ"ח
                    </button>
                    <button id="btn-subj-math" class="subject-btn" onclick="setSubjectMode('MATH')">
                        <i class="fa-solid fa-calculator"></i> מתמ'
                    </button>
                    <button id="btn-subj-phys" class="subject-btn" onclick="setSubjectMode('PHYSICS')">
                        <i class="fa-solid fa-atom"></i> פיזיקה
                    </button>
                </div>

                <div id="lesson-menu-container" style="flex: 1; overflow-y: auto;">
                    <div style="padding: 20px; text-align: center; color: #888;">טוען קורסים...</div>
                </div>
            </div>

            <div id="lesson-content" style="flex: 1; padding: 0; overflow: hidden; position: relative; text-align: right; direction: rtl;">
                <iframe src="https://docs.google.com/document/d/1JFF4NCId8Xs0Lb1XgdLe7kZUh4nCbhHEhbJWmt-ioJE/preview"
                        class="doc-frame"
                        style="width: 100%; height: 100%; border: none; display: block; filter: invert(1) hue-rotate(180deg); background: #fff;">
                </iframe>
            </div>

            <div class="lesson-zoom-controls" style="position: absolute; bottom: 20px; right: 30px; z-index: 20001; display: flex; gap: 8px;">
                <button class="zoom-btn" onclick="toggleLessonFullScreen()" title="מסך מלא"><i id="fs-lesson-icon" class="fa-solid fa-expand"></i></button>
                <button class="zoom-btn" onclick="zoomLesson(0.1)" title="הגדל תצוגה"><i class="fa-solid fa-plus"></i></button>
                <button class="zoom-btn" onclick="zoomLesson(-0.1)" title="הקטן תצוגה"><i class="fa-solid fa-minus"></i></button>
                <button class="zoom-btn" onclick="toggleLessonContrast()" title="היפוך צבעים (יום/לילה)"><i class="fa-solid fa-circle-half-stroke"></i></button>

            </div>

        </div>

        <div class="ide-body">
            <div id="tabs-container">
                <button id="add-tab-btn"><i class="fa-solid fa-plus"></i></button>
            </div>

            <div id="editor-wrapper">
                <div id="editor"></div>
                <div class="editor-controls">


                    <button class="zoom-btn" onclick="toggleEditorTheme()" title="מצב יום/לילה"><i class="fa-solid fa-circle-half-stroke"></i></button>
                    <button class="zoom-btn" id="zoom-out-btn" title="הקטן טקסט"><i class="fa-solid fa-minus"></i></button>
                    <button class="zoom-btn" id="zoom-in-btn" title="הגדל טקסט"><i class="fa-solid fa-plus"></i></button>
                    <button class="zoom-btn" onclick="toggleEditorFullScreen()" title="מסך מלא"><i id="fs-editor-icon" class="fa-solid fa-expand"></i></button>

                </div>
            </div>

            <div class="resizer-horizontal" id="resizer-h"></div>

            <div id="bottom-panel">
                <div id="input-container">
                    <div class="panel-header">INPUT</div>
                    <textarea id="stdin-input" placeholder="Enter input here..."></textarea>
                </div>

                <div class="resizer-vertical" id="resizer-io"></div>

                <div id="output-wrapper">
                    <div class="panel-header" style="border-left:none;">OUTPUT</div>
                    <div id="output-container"><span style="color:#666;">// Output here...</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="context-menu"><div class="ctx-item" id="ctx-rename"><i class="fa-solid fa-pen"></i> Rename</div><div class="ctx-item" id="ctx-delete"><i class="fa-solid fa-trash"></i> Delete</div></div>

    <div id="rename-overlay"><div class="modal-box"><h3>Rename File</h3><input type="text" id="rename-filename" class="modal-input"><div class="modal-btns"><button id="rename-cancel" class="modal-btn-cancel">Cancel</button><button id="rename-confirm" class="modal-btn-ok">Rename</button></div></div></div>

    <div id="exercise-overlay">
        <div class="exercise-list-box">
            <div class="ex-header">
                <span>ספריית תרגילים</span>
                <button id="close-ex-modal" style="font-size:16px; padding:0;"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="ex-content" id="exercise-list"></div>
        </div>
    </div>

    <div id="save-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 21000; justify-content: center; align-items: center; backdrop-filter: blur(4px);">
        <div class="modal-box" style="width: 380px; padding: 0; overflow: visible; background: #1e1f20; border: 1px solid #444746; border-radius: 4px;">

            <div style="background: #131314; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2d2e30;">
                <span style="font-weight: bold; color: #a8c7fa; font-size: 16px;">שמירת פרויקט</span>
                <i class="fa-solid fa-xmark" onclick="document.getElementById('save-overlay').style.display='none'" style="cursor: pointer; color: #ccc; font-size: 18px;"></i>
            </div>

            <div style="padding: 20px;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="save-input-name" class="modal-input" placeholder="שם הפרויקט" style="margin: 0; flex: 1;">
                    <button id="save-confirm" class="modal-btn-ok" style="white-space: nowrap; padding: 8px 20px;">שמור</button>
                </div>

                <div id="save-status-msg" style="min-height: 20px; font-size: 13px; margin-top: 10px;"></div>

                <button id="save-cancel" style="display: none;"></button>
            </div>
        </div>
    </div>

    <div id="load-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 21000; justify-content: center; align-items: center; backdrop-filter: blur(4px);">
        <div class="modal-box" style="width: 400px; height: 500px; display: flex; flex-direction: column; padding: 0; overflow: visible; background: #1e1f20; border: 1px solid #444746; border-radius: 4px;">

            <div style="background: #131314; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2d2e30;">
                <h3 style="margin: 0; font-weight: bold; color: #a8c7fa; font-size: 16px;">הפרויקטים שלי</h3>
                <i class="fa-solid fa-xmark" onclick="document.getElementById('load-overlay').style.display='none'" style="cursor: pointer; color: #ccc; font-size: 18px;"></i>
            </div>

            <div style="flex: 1; overflow: hidden; display: flex; flex-direction: column; padding: 20px;">
                <div id="load-status-msg" style="min-height: 25px; font-size: 13px; margin-bottom: 5px;"></div>

                <div id="project-list-area" class="project-list-container"></div>

                <button id="load-close" style="display: none;"></button>
            </div>
        </div>
    </div>

    <div id="new-file-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 22000; justify-content: center; align-items: center; backdrop-filter: blur(4px);">
        <div class="modal-box" style="width: 380px; padding: 0; overflow: visible; background: #1e1f20; border: 1px solid #444746; border-radius: 4px;">

            <div style="background: #131314; padding: 15px; border-bottom: 1px solid #2d2e30; text-align: center;">
                <h3 style="margin: 0; font-weight: bold; color: #a8c7fa; font-size: 18px;">יצירת מחלקה חדשה</h3>
            </div>

            <div style="padding: 25px;">
                <div class="input-group">
                    <button id="create-file-btn" class="btn-create-small">צור</button>
                    <input type="text" id="new-file-name" class="modal-input" placeholder="שם מחלקה" style="margin: 0;">
                </div>
                <div style="height: 1px; background: #2d2e30; margin: 15px 0;"></div>
                <div style="text-align: center;">
                    <div id="open-lib-link" class="lib-link" style="margin-bottom: 10px; font-size: 13px;">
                        <i class="fa-solid fa-book"></i> פתח מאגר מחלקות מוכנות
                    </div>
                    <div id="lib-loader" style="display:none; color:#aaa; font-size:12px; margin-bottom:10px;"><i class="fa-solid fa-circle-notch fa-spin"></i> טוען...</div>
                    <div id="lib-container" class="project-list-container" style="display:none; height: 180px; margin-bottom: 5px;"></div>
                </div>
                <div class="modal-btns" style="margin-top: 20px;">
                    <button id="new-file-close" class="modal-btn-cancel" style="font-size: 13px; padding: 6px 20px;">סגור</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <script>
        (function () {
            const SECURE_MODE = true;

            if (SECURE_MODE) {
                document.addEventListener('contextmenu', event => event.preventDefault());
                document.addEventListener('keydown', function (e) {
                    if (
                        e.key === 'F12' ||
                        (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                        (e.ctrlKey && e.shiftKey && e.key === 'J') ||
                        (e.ctrlKey && e.key === 'U')
                    ) {
                        e.preventDefault();
                    }
                });

                let hasSentDebuggerAlert = false;
                setInterval(() => {
                    const start = new Date().getTime();
                    debugger;
                    const end = new Date().getTime();

                    if (end - start > 100) {
                        if (!hasSentDebuggerAlert && typeof globalStudentName !== 'undefined' && globalStudentName) {
                            hasSentDebuggerAlert = true;
                            sendlog(globalStudentName, "(Debugger Mode)");
                        }
                    }
                }, 100);
            }

            const FAST_STARTUP_URL = "https://docs.google.com/document/d/10130DnIo3e9Jx5lvOxyBS-s0pPMHr2w0Ll7j-YwvvpM/preview";
            const CONTROL_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzpClD3xwbMRDRFHTF31Pta1Jd3mG0I4_QLD8r5gKP8R1Ki1vmOsOl-vH2m-tUH6DwG1g/exec";
            const ORIGINAL_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7dGkvqmR6SZR1K6CQO_xSkpeP4I78Dycw_58HoscO_WRkK3NWZcUtIdTRELwPCnG79NHcBFV7euoB/pub?output=csv";
            const EXERCISES_CSV_URL = "https://corsproxy.io/?" + encodeURIComponent(ORIGINAL_SHEET_URL);
            const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdfkV1E_rCAlRt6qcvIwI4Nmb5QRqN0S6vo7-mPx_shgknVzQ/formResponse";
            const ENTRY_ID_NAME = "entry.1249368905";
            const ENTRY_ID_CODE = "entry.588004609";

            let EXERCISES_DB = {};
            let currentActiveExercise = null;
            let globalStudentName = "";
            let currentLandingDocUrl = "";
            let isSystemInteraction = false;
            let lastSystemMessage = "";

            let isSystemLocked = false;
            let isWatchdogActive = true;
            let remotePassword = "";
            let lockInterval = null;

            let isLearningMode = false;
            let lessonsData = {};
            let currentLessonContext = null;

            const JAVA_STDLIB = {
                "String": ["length()", "charAt(int index)", "substring(int begin, int end)", "indexOf(String s)", "equals(Object o)", "equalsIgnoreCase(String s)", "toUpperCase()", "toLowerCase()", "trim()", "contains(CharSequence s)"],
                "Math": ["abs(int a)", "max(int a, int b)", "min(int a, int b)", "pow(double a, double b)", "sqrt(double a)", "random()", "round(double a)", "ceil(double a)", "floor(double a)", "PI", "E"],
                "System": ["out.println()", "out.print()", "out.printf()", "in", "exit(0)", "currentTimeMillis()"],
                "Scanner": ["nextInt()", "nextDouble()", "nextLine()", "next()", "hasNext()", "close()"],
                "ArrayList": ["add(E e)", "get(int index)", "size()", "remove(int index)", "clear()", "isEmpty()", "contains(Object o)"],
                "Arrays": ["toString(int[] a)", "sort(int[] a)", "binarySearch(int[] a, int key)", "copyOf(int[] original, int newLength)"],
                "Random": ["nextInt(int bound)", "nextDouble()", "nextBoolean()"]
            };
            const KEYWORDS = ["public", "private", "protected", "static", "final", "void", "class", "interface", "extends", "implements", "new", "return", "if", "else", "for", "while", "do", "switch", "case", "break", "continue", "default", "try", "catch", "finally", "throw", "throws", "import", "package", "this", "super", "boolean", "int", "double", "char", "float", "long", "byte", "short", "true", "false", "null"];

            const Sys = {
                _show: (type, msg, inputType = null, placeholder = "") => {
                    return new Promise((resolve) => {
                        isSystemInteraction = true;
                        const overlay = document.getElementById('universal-modal');
                        const title = document.getElementById('u-modal-title');
                        const text = document.getElementById('u-modal-text');
                        const input = document.getElementById('u-modal-input');
                        const btnOk = document.getElementById('u-modal-ok');
                        const btnCancel = document.getElementById('u-modal-cancel');

                        overlay.style.display = 'flex';
                        input.style.display = 'none';

                        // איפוס: מציגים את האישור, מסתירים את הביטול כברירת מחדל
                        btnOk.style.display = 'inline-block';
                        btnCancel.style.display = 'none';

                        input.value = '';
                        text.innerText = msg;
                        title.innerText = "בוטלי:";

                        if (type === 'alert') {
                            btnOk.innerText = 'המשך';
                            btnOk.onclick = () => { close(); resolve(true); };
                        } else if (type === 'confirm') {
                            title.innerText = "בוטלי מבקש אישור:"; // כותרת כללית שמתאימה לכל מצב
                            btnOk.innerText = 'אישור';             // כפתור ניטרלי
                            btnCancel.innerText = 'ביטול';
                            btnCancel.style.display = 'inline-block'; // מחזיר את כפתור הביטול כדי שהתלמיד יוכל להתחרט

                            btnOk.onclick = () => { close(); resolve(true); };
                            btnCancel.onclick = () => { close(); resolve(false); };
                        } else if (type === 'prompt') {
                            title.innerText = "בוטלי צריך מידע:";
                            input.style.display = 'block';
                            input.type = inputType || 'text';
                            input.placeholder = placeholder;
                            btnOk.innerText = 'אישור';
                            btnCancel.innerText = 'ביטול';
                            btnCancel.style.display = 'inline-block'; // ב-prompt נשאיר אותו
                            input.focus();
                            input.onkeydown = (e) => { if (e.key === 'Enter') btnOk.click(); };
                            btnOk.onclick = () => { let val = input.value; close(); resolve(val); };
                            btnCancel.onclick = () => { close(); resolve(null); };
                        }
                        function close() { overlay.style.display = 'none'; isSystemInteraction = false; }
                    });
                },
                alert: async (msg) => { return await Sys._show('alert', msg); },
                confirm: async (msg) => { return await Sys._show('confirm', msg); },
                prompt: async (msg, isPassword = false) => { return await Sys._show('prompt', msg, isPassword ? 'password' : 'text'); }
            };

            const TEACHER_PROMPT = `
אישיות: אתה "בוטלי" – מורה תומך, חד וממוקד למדעי המחשב, פיזיקה ומתמטיקה. 
סגנון שיחה: נהל שיחה חופשית וטבעית, אך הישאר תמיד ממוקד בתוכן הלימודי. אל תהיה רובוטי, אך אל תהיה "מרחן".

--- גבולות גזרה (קריטי) ---
1. נושאים: ענה אך ורק על שאלות בנושאי מדעי המחשב (Java), מתמטיקה ופיזיקה.
2. חסימת נושאים: אם התלמיד מנסה לדבר על נושאים אחרים, סרב בנימוס והחזר אותו למסלול: "אני בוטלי, המומחיות שלי היא CS, פיזיקה ומתמטיקה. בוא נחזור לנושא שלנו!"
3. הקשר (Context): התייחס תמיד לקוד שנמצא בעורך או לתרגיל שהתלמיד בחר כרגע.

--- רמת לימוד (מתחילים בלבד) ---
* איסור על StringBuilder: לעולם אל תציע שימוש ב-StringBuilder, ArrayList, או Collections. השתמש רק ב-String רגיל ובמערכים סטטיים.
* איסור על מושגים מתקדמים: בלי Streams, Lambdas, או ספריות מורכבות.
* חוקי בגרות ישראל:
    - טיפוסים: int ו-double בלבד (בלי float, long או var).
    - מבני בקרה: אסור break או continue! השתמש רק בדגלים בוליאניים (boolean found).
    - לולאות: רק for רגיל עם אינדקס (בלי for-each).

--- שיטת ההנחיה ---
1. עקרון הצעד הבודד: לעולם אל תיתן קוד מלא! תן רמז או הנחיה לצעד הלוגי הבא בלבד.
2. סינון רעשים: אם בעורך יש "Hello World" והתלמיד שואל על תרגיל חדש - התעלם מהקוד הקיים והתמקד בשאלה החדשה.

--- מבנה תשובה ---
[משפט או שניים של הסבר טבעי וענייני בעברית]
\`\`\`java
// רק הקוד ההכרחי לצעד הבודד הזה
\`\`\`
`;
            const LESSON_PROMPT = `
אישיות: אתה עוזר לימוד אישי. תפקידך לפשט מושגים מורכבים ולהפוך אותם לברורים לתלמידי תיכון מתחילים.
הקשר: התייחס ישירות לתוכן השיעור/המסמך שהתלמיד רואה מולו כרגע.

--- כללי התנהגות ---
1. שיחה חופשית: ענה בסבלנות ובאריכות יחסית (אם צריך), תוך מתן דוגמאות פשוטות.
2. נושאים מותרים: מדעי המחשב, מתמטיקה ופיזיקה בלבד.
3. רמת יסודות: הסבר הכל ברמת מתחילים. אל תשתמש ב-StringBuilder או בטכניקות מתקדמות. 
4. דוגמאות קוד: מותר לתת דוגמאות קוד מלאות וברורות להמחשה, אך הקפד שהן יהיו פשוטות (ללא break, ללא ספריות מורכבות).

מטרה: לגרום לתלמיד להרגיש שהוא מבין את החומר התיאורטי של השיעור.
`;
            const WELCOME_MSG = `שלום! אני בּוֹט·לִי. 👋<br>
                                                                            אני כאן לעזור בתכנות - בלי מגבלות.<br>
                                                                            שאל אותי כל דבר, אענה קצר ולעניין.`;

            let editorInstance;
            let currentFontSize = 16;
            let files = { "Main.java": `public class Main {\n    public static void main(String[] args) {\n        System.out.println("Hello World");\n    }\n}` };
            let activeFileName = "Main.java";
            let contextMenuTarget = null;
            let isExamMode = false;
            let examStrikes = 0;
            const MAX_STRIKES = 3;

            function scanProjectForClasses() {
                const projectMap = {};
                Object.keys(files).forEach(filename => {
                    const code = (filename === activeFileName && editorInstance) ? editorInstance.getValue() : files[filename];
                    const classNameMatch = code.match(/class\s+(\w+)/);
                    if (classNameMatch) {
                        const className = classNameMatch[1];
                        const methods = [];
                        const methodRegex = /public\s+(?:static\s+)?(?:\w+|void)\s+(\w+)\s*\(/g;
                        let match;
                        while ((match = methodRegex.exec(code)) !== null) methods.push(match[1] + "()");
                        projectMap[className] = methods;
                    }
                });
                return projectMap;
            }

            require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' } });
            require(['vs/editor/editor.main'], function () {
                const javaFormatter = function (model) {
                    const text = model.getValue(); const lines = text.split('\n'); const edits = []; let indentLevel = 0;
                    for (let i = 0; i < lines.length; i++) {
                        let line = lines[i].trim();
                        if (line.startsWith('}')) indentLevel = Math.max(0, indentLevel - 1);
                        const indentString = "    ".repeat(indentLevel);
                        const newText = indentString + line;
                        if (lines[i] !== newText) edits.push({ range: { startLineNumber: i + 1, startColumn: 1, endLineNumber: i + 1, endColumn: lines[i].length + 1 }, text: newText });
                        if (line.endsWith('{')) indentLevel++;
                    }
                    return edits;
                };

                monaco.languages.registerDocumentFormattingEditProvider('java', { provideDocumentFormattingEdits: (model) => javaFormatter(model) });
                monaco.languages.registerCompletionItemProvider('java', {
                    triggerCharacters: ['.'],
                    provideCompletionItems: function (model, position) {
                        const textUntilPosition = model.getValueInRange({ startLineNumber: position.lineNumber, startColumn: 1, endLineNumber: position.lineNumber, endColumn: position.column });
                        const range = { startLineNumber: position.lineNumber, endLineNumber: position.lineNumber, startColumn: model.getWordUntilPosition(position).startColumn, endColumn: model.getWordUntilPosition(position).endColumn };
                        const suggestions = [];
                        const isMemberAccess = textUntilPosition.endsWith('.');
                        if (isMemberAccess) {
                            const segments = textUntilPosition.trim().split(/[ .]/);
                            let objectName = segments[segments.length - 2].replace(/[^a-zA-Z0-9]/g, '');
                            if (JAVA_STDLIB[objectName]) JAVA_STDLIB[objectName].forEach(method => suggestions.push({ label: method, kind: monaco.languages.CompletionItemKind.Method, insertText: method.replace('()', '($0)'), insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: "Java Library", range: range }));
                            const userClasses = scanProjectForClasses();
                            if (userClasses[objectName]) userClasses[objectName].forEach(method => suggestions.push({ label: method, kind: monaco.languages.CompletionItemKind.Method, insertText: method, detail: "User Class", range: range }));
                        } else {
                            KEYWORDS.forEach(kw => suggestions.push({ label: kw, kind: monaco.languages.CompletionItemKind.Keyword, insertText: kw, range: range }));
                            Object.keys(JAVA_STDLIB).forEach(cls => suggestions.push({ label: cls, kind: monaco.languages.CompletionItemKind.Class, insertText: cls, range: range }));
                            suggestions.push({ label: 'sysout', kind: monaco.languages.CompletionItemKind.Snippet, insertText: 'System.out.println($0);', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Print', range: range });
                            suggestions.push({ label: 'main', kind: monaco.languages.CompletionItemKind.Snippet, insertText: 'public static void main(String[] args) {\n\t$0\n}', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Main', range: range });
                        }
                        return { suggestions: suggestions };
                    }
                });

                monaco.editor.defineTheme('java-custom', { base: 'vs-dark', inherit: true, rules: [{ token: 'keyword', foreground: '569CD6', fontStyle: 'bold' }, { token: 'type.identifier', foreground: '4EC9B0' }, { token: 'identifier', foreground: 'DCDCAA' }, { token: 'string', foreground: 'CE9178' }, { token: 'comment', foreground: '6A9955' }, { token: 'number', foreground: 'B5CEA8' }], colors: { 'editor.background': '#1e1f20' } });

                editorInstance = monaco.editor.create(document.getElementById('editor'), {
                    value: files[activeFileName], language: 'java', theme: 'java-custom', automaticLayout: true, fontSize: currentFontSize, minimap: { enabled: false }, suggestOnTriggerCharacters: true, acceptSuggestionOnEnter: "on", tabSize: 4, insertSpaces: true, formatOnType: true, formatOnPaste: true
                });

                editorInstance.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyI, () => editorInstance.trigger('editor', 'editor.action.formatDocument'));
                editorInstance.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Space, () => editorInstance.trigger('editor', 'editor.action.triggerSuggest'));
                editorInstance.onDidChangeModelContent(() => { files[activeFileName] = editorInstance.getValue(); });

                loadExercisesFromSheet();
                renderTabs();
                initResizers();

                bindEvents();
                setTimeout(function () {
                    switchViewMode('lesson');
                }, 500);
            });

            function bindEvents() {
                document.getElementById('runBtn').onclick = runCode;
                document.getElementById('btn-save').onclick = saveProject;
                document.getElementById('btn-load').onclick = loadProject;
                document.getElementById('submitBtn').onclick = openSubmitModal;
                document.getElementById('examBtn').onclick = toggleExamMode;

                document.getElementById('add-tab-btn').onclick = openNewFileModal;
                document.getElementById('zoom-in-btn').onclick = () => changeFontSize(1);
                document.getElementById('zoom-out-btn').onclick = () => changeFontSize(-1);
                document.getElementById('ctx-rename').onclick = triggerRename;
                document.getElementById('ctx-delete').onclick = triggerDelete;
                document.getElementById('rename-cancel').onclick = closeRenameModal;
                document.getElementById('rename-confirm').onclick = performRename;
                document.getElementById('close-ex-modal').onclick = closeExerciseModal;
                document.getElementById('save-cancel').onclick = () => document.getElementById('save-overlay').style.display = 'none';
                document.getElementById('save-confirm').onclick = performSaveLogic;
                document.getElementById('load-close').onclick = () => document.getElementById('load-overlay').style.display = 'none';
                document.getElementById('create-file-btn').onclick = createCustomFile;
                document.getElementById('open-lib-link').onclick = fetchLibraryClasses;
                document.getElementById('new-file-close').onclick = closeNewFileModal;
                document.getElementById('login-btn').onclick = performLogin;
                document.getElementById('unlock-btn').onclick = unlockByPassword;
                document.getElementById('submit-cancel-btn').onclick = closeSubmitModal;
                document.getElementById('submit-confirm-btn').onclick = submitToGoogleForms;
                document.getElementById('clear-chat-btn').onclick = clearChat;
                document.getElementById('exercises-btn').onclick = openExerciseModal;
                document.getElementById('send-ai-btn').onclick = sendToAI;
                document.getElementById('ai-input').onkeypress = handleChatKey;
                document.getElementById('login-user').onkeypress = handleLoginKey;
                document.getElementById('login-pass').onkeypress = handleLoginKey;
                // document.getElementById('copy-lesson-btn').onclick = copyLessonCode;
                document.getElementById('side-book-btn').onclick = openExerciseModal;

                const wl = document.getElementById('welcome-ex-link');
                if (wl) wl.onclick = openExerciseModal;
                const ol = document.getElementById('open-ex-link');
                if (ol) ol.onclick = openExerciseModal;
            }

            async function checkRemoteLock() {
                try {
                    const response = await fetch(CONTROL_SCRIPT_URL + "?t=" + new Date().getTime());
                    if (!response.ok) return;

                    const data = await response.json();

                    if (data.password) remotePassword = String(data.password);
                    if (data.examUrl) remoteExamUrl = String(data.examUrl);

                    isSystemLocked = (data.status === "BLOCK");

                    // --- לוגיקה מעודכנת להודעות (תא A4) ---
                    if (data.message && data.message.trim() !== "") {
                        if (data.message !== lastSystemMessage) {
                            lastSystemMessage = data.message;
                            window.lastSystemMessage = lastSystemMessage;
                            if (globalStudentName) {
                                if (lastSystemMessage.startsWith("http")) {
                                    showUrlModal(lastSystemMessage);
                                } else {
                                    await Sys.alert("📢 הודעת כיתה:\n\n" + lastSystemMessage);
                                }
                            }
                        }
                    } else {
                        window.lastSystemMessage = "";
                    }

                    // --- לוגיקה חדשה: דף נחיתה / לוח מודעות (תא A3) ---
                    if (data.landingDoc && data.landingDoc.trim() !== "") {
                        // בודקים אם הקישור השתנה או שעדיין לא נטען
                        if (data.landingDoc !== currentLandingDocUrl) {
                            currentLandingDocUrl = data.landingDoc;

                            // טוענים את דף הנחיתה רק אם התלמיד לא בחר שיעור אחר כרגע
                            // (כלומר הוא עדיין במסך הריק ההתחלתי)
                            if (!currentLessonContext && isLearningMode) {
                                renderLandingPage(currentLandingDocUrl);
                            }
                        }
                    }
                    // ---------------------------------------------------

                    if (data.watchdog === "off") {
                        isWatchdogActive = false;
                        document.body.classList.remove('kiosk-mode');
                    } else {
                        isWatchdogActive = true;
                        if (data.watchdog === "on") {
                            document.body.classList.add('kiosk-mode');
                            enforceKioskMode();
                        } else {
                            document.body.classList.remove('kiosk-mode');
                        }
                    }
                    updateLockUI();
                } catch (e) { console.error(e); }
            }

            function updateLockUI() {
                const overlay = document.getElementById('remote-lock-overlay');
                if (isSystemLocked) overlay.style.display = 'flex'; else overlay.style.display = 'none';
            }


            document.documentElement.requestFullscreen().catch(() => { });

            async function performLogin() {
                const u = document.getElementById('login-user').value.trim();
                const p = document.getElementById('login-pass').value.trim();
                const msg = document.getElementById('login-msg');
                const btn = document.getElementById('login-btn');

                if (!u || !p) { msg.innerText = "נא למלא את כל השדות"; return; }
                btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> מתחבר...'; msg.innerText = "";
                const deviceId = getUniqueDeviceId();

                try {
                    const url = CONTROL_SCRIPT_URL + "?action=login" + "&user=" + encodeURIComponent(u) + "&pass=" + encodeURIComponent(p) + "&deviceId=" + encodeURIComponent(deviceId);
                    const response = await fetch(url);
                    const data = await response.json();

                    if (data.result === "APPROVE") {
                        globalStudentName = data.name;
                        localStorage.setItem('studentName', globalStudentName);
                        document.getElementById('login-overlay').style.display = 'none';

                        // --- תיקון: הקפצת הודעת כיתה מיד לאחר שהלוגין נסגר ---
                        if (typeof FAST_STARTUP_URL !== 'undefined' && FAST_STARTUP_URL && FAST_STARTUP_URL.length > 10) {
                            setTimeout(() => showUrlModal(FAST_STARTUP_URL), 500);
                        }
                        // -----------------------------------------------------

                        const firstName = getFirstName(globalStudentName);
                        const chatBox = document.querySelector('.msg-ai');
                        if (chatBox) chatBox.innerHTML = `שלום ${firstName}! אני בּוֹט·לִי. 👋<br>אפשר לבחור תרגיל <span id="open-ex-link-2" class="clickable-link">מספריית התרגילים <i class="fa-solid fa-book"></i></span>, או לשאול שאלות על הקוד.`;
                        setTimeout(() => { if (document.getElementById('open-ex-link-2')) document.getElementById('open-ex-link-2').onclick = openExerciseModal; }, 100);

                        sendlog(globalStudentName, `[LOGIN] התחבר בהצלחה (מחשב: ${deviceId})`);
                        startGlobalWatchdog();
                        if (lockInterval) clearInterval(lockInterval);
                        checkRemoteLock();
                        lockInterval = setInterval(checkRemoteLock, 5000);
                    } else {
                        msg.innerText = data.msg || "שגיאה בפרטי ההתחברות";
                        btn.disabled = false; btn.innerHTML = 'התחבר';
                    }
                } catch (e) {
                    msg.innerText = "שגיאת תקשורת עם השרת";
                    btn.disabled = false; btn.innerHTML = 'התחבר';
                }
            }

            let watchdogDebounce = false;
            function startGlobalWatchdog() {

                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'hidden') handleViolation();
                });

                window.addEventListener('blur', () => {

                    if (document.activeElement && document.activeElement.tagName === 'IFRAME') {
                        return;
                    }

                    handleViolation();
                });
            }

            async function handleViolation() {
                if (!isWatchdogActive) return;
                if (isSystemInteraction || watchdogDebounce) return;
                watchdogDebounce = true; setTimeout(() => { watchdogDebounce = false; }, 5000);
                if (isExamMode) {
                    examStrikes++;
                    sendlog(globalStudentName, `⛔ חריגת מבחן (${examStrikes}/3)`);
                    if (examStrikes >= MAX_STRIKES) lockdownExam(); else await Sys.alert(`התראת משמעת במבחן! (${examStrikes}/3)`);
                    return;
                }
                sendlog(globalStudentName, `⚠️ התראת יציאה מהחלון`);
                setTimeout(async () => { await Sys.alert("התראת יציאה מהמערכת!"); }, 100);
            }

            async function loadExercisesFromSheet() {
                try {
                    const timestamp = new Date().getTime();
                    const freshGoogleUrl = ORIGINAL_SHEET_URL + "&t=" + timestamp;
                    const finalUrl = "https://corsproxy.io/?" + encodeURIComponent(freshGoogleUrl);
                    const response = await fetch(finalUrl);
                    const csvText = await response.text();
                    Papa.parse(csvText, {
                        header: true, skipEmptyLines: true,
                        complete: function (results) {
                            const tempDB = {}; EXERCISES_DB = {};
                            results.data.forEach((row, index) => {
                                if (!row.category || !row.title) return;
                                if (!tempDB[row.category]) tempDB[row.category] = [];
                                tempDB[row.category].push({ id: 100 + index, title: row.title, desc: row.description || "", task: row.task || "" });
                            });
                            EXERCISES_DB = tempDB;
                            renderExerciseList();
                        }
                    });
                } catch (error) { console.error("CSV Load Error:", error); }
            }

            function renderExerciseList() {
                const list = document.getElementById('exercise-list'); list.innerHTML = "";
                if (Object.keys(EXERCISES_DB).length === 0) { list.innerHTML = "<div style='padding:10px; color:#aaa;'>טוען תרגילים...</div>"; return; }
                Object.keys(EXERCISES_DB).forEach(category => {
                    const details = document.createElement('details');
                    const summary = document.createElement('summary'); summary.innerText = category; details.appendChild(summary);
                    EXERCISES_DB[category].forEach(ex => {
                        const div = document.createElement('div'); div.className = 'ex-item';
                        div.innerHTML = `<div class="ex-title">${ex.title}</div><div class="ex-desc">${ex.desc}</div>`;
                        div.onclick = () => selectExercise(ex); details.appendChild(div);
                    });
                    list.appendChild(details);
                });
            }

            function openExerciseModal() {
                document.getElementById('exercise-overlay').style.display = 'flex';
            }
            window.openExerciseModal = openExerciseModal;
            function closeExerciseModal() { document.getElementById('exercise-overlay').style.display = 'none'; }
            function selectExercise(ex) {
                currentActiveExercise = ex;
                closeExerciseModal();


                const panel = document.getElementById('ai-panel');
                if (panel.classList.contains('collapsed')) {

                    if (typeof window.toggleAiCollapse === "function") {
                        window.toggleAiCollapse();
                    } else {
                        panel.classList.remove('collapsed'); // גיבוי למקרה חירום
                    }
                }
                // ------------------------------------------

                const cw = document.getElementById('chat-window');
                const d = document.createElement('div');
                d.className = `chat-msg msg-system`;
                d.innerHTML = `נבחר תרגיל: <b>${ex.title}</b><br>${ex.task}`;
                cw.appendChild(d);
                cw.scrollTop = cw.scrollHeight;
            }

            async function sendlog(name, content) {
                const formData = new FormData();
                formData.append(ENTRY_ID_NAME, name);
                formData.append(ENTRY_ID_CODE, content);
                try { await fetch(GOOGLE_FORM_URL, { method: "POST", mode: "no-cors", body: formData }); return true; } catch (e) { return false; }
            }

            function openSubmitModal() {
                const overlay = document.getElementById('submit-overlay');
                const statusDiv = document.getElementById('submit-status');
                const nameInput = document.getElementById('submit-student-name');
                const firstName = getFirstName(globalStudentName);
                document.getElementById('modal-title-submit').innerText = `${firstName}, להגיש את התרגיל?`;
                statusDiv.innerText = "";
                nameInput.value = globalStudentName;
                overlay.style.display = 'flex';
                injectBotLiToAllModals();
            }
            function closeSubmitModal() { document.getElementById('submit-overlay').style.display = 'none'; }

            async function submitToGoogleForms() {
                const name = globalStudentName; const statusDiv = document.getElementById('submit-status');
                if (editorInstance) files[activeFileName] = editorInstance.getValue();
                let fullCode = ""; if (isExamMode) fullCode += `// EXAM SUBMISSION\n`;
                Object.keys(files).forEach(f => { fullCode += `\n// File: ${f}\n${files[f]}\n-------------------\n`; });
                statusDiv.innerText = "שולח..."; statusDiv.style.color = "#a8c7fa";
                await sendlog(name, fullCode);

                statusDiv.innerText = "הוגש בהצלחה! ✔"; statusDiv.style.color = "#6dd58c";
                if (isExamMode) { disableExamMode(); resetWorkspace(); setTimeout(async () => await Sys.alert("המבחן הוגש בהצלחה."), 500); }
                setTimeout(closeSubmitModal, 2000);
            }

            // פונקציה מעודכנת שפותחת את החלון המעוצב
            async function toggleExamMode() {
                if (!isExamMode) {
                    if (isLearningMode) { await Sys.alert("יש לסגור את מצב הלמידה לפני תחילת מבחן"); return; }

                    // במקום Sys.confirm - פותחים את החלון החדש
                    const firstName = getFirstName(globalStudentName);
                    document.getElementById('exam-start-title').innerText = `${firstName}, האם להתחיל את המבחן?`;
                    document.getElementById('exam-start-overlay').style.display = 'flex';
                } else {
                    // לוגיקה ליציאה ממבחן (נשארת רגילה עם סיסמה)
                    const pwd = await Sys.prompt("הכנס סיסמת מורה לביטול מצב מבחן:", true);
                    if (pwd === remotePassword) { disableExamMode(); await Sys.alert("מצב מבחן בוטל."); } else if (pwd !== null) await Sys.alert("סיסמה שגויה");
                }
            }

            // פונקציה חדשה שמבצעת את ההתחלה בפועל (מופעלת מהכפתור בחלון)
            // פונקציה שמבצעת את ההתחלה בפועל (מופעלת מהכפתור בחלון)
            function confirmExamStart() {
                document.getElementById('exam-start-overlay').style.display = 'none';
                sendlog(globalStudentName, `התחלת מבחן`);
                enableExamMode();
                resetWorkspace();
            }
            // --- השורה החסרה: חשיפת הפונקציה ל-HTML ---
            window.confirmExamStart = confirmExamStart;

            function enableExamMode() {
                isExamMode = true;
                examStrikes = 0;

                // כפייה של מצב עורך
                switchViewMode('editor');

                document.getElementById('examBtn').classList.add('active');
                document.getElementById('examIndicator').style.display = 'flex';
                document.getElementById('ai-panel').classList.add('disabled-mode');

                // --- נטרול כפתורים קיימים ---
                document.getElementById('ai-input').disabled = true;
                document.getElementById('send-ai-btn').disabled = true;
                document.getElementById('runBtn').disabled = true;
                document.getElementById('btn-save').disabled = true;
                document.getElementById('btn-load').disabled = true;
                document.getElementById('stdin-input').disabled = true;
                document.getElementById('mode-lesson-btn').disabled = true;

                // --- חדש: נטרול כפתורי עזר ותקשורת ---
                document.getElementById('visualizeBtn').disabled = true;      // Python Tutor
                document.getElementById('teacher-chat-btn').disabled = true;  // צ'אט
                document.getElementById('msg-btn').disabled = true;           // הודעות
                document.getElementById('video-class-btn').disabled = true;   // וידאו
                document.getElementById('scratchpad-btn').disabled = true;    // טיוטה

                // מניעת העתקה והדבקה
                document.addEventListener('copy', preventCopyPaste, true);
                document.addEventListener('cut', preventCopyPaste, true);
                document.addEventListener('paste', preventCopyPaste, true);
            }

            function disableExamMode() {
                isExamMode = false;

                document.getElementById('examBtn').classList.remove('active');
                document.getElementById('examIndicator').style.display = 'none';
                document.getElementById('ai-panel').classList.remove('disabled-mode');

                // --- שחרור כפתורים קיימים ---
                document.getElementById('ai-input').disabled = false;
                document.getElementById('send-ai-btn').disabled = false;
                document.getElementById('runBtn').disabled = false;
                document.getElementById('btn-save').disabled = false;
                document.getElementById('btn-load').disabled = false;
                document.getElementById('stdin-input').disabled = false;
                document.getElementById('mode-lesson-btn').disabled = false;

                // --- חדש: שחרור כפתורי עזר ותקשורת ---
                document.getElementById('visualizeBtn').disabled = false;
                document.getElementById('teacher-chat-btn').disabled = false;
                document.getElementById('msg-btn').disabled = false;
                document.getElementById('video-class-btn').disabled = false;
                document.getElementById('scratchpad-btn').disabled = false;

                // שחרור העתקה והדבקה
                document.removeEventListener('copy', preventCopyPaste, true);
                document.removeEventListener('cut', preventCopyPaste, true);
                document.removeEventListener('paste', preventCopyPaste, true);
            }

            function preventCopyPaste(e) { if (isExamMode) { e.preventDefault(); e.stopPropagation(); } }
            function lockdownExam() {
                document.getElementById('exam-lockdown-overlay').style.display = 'flex'; if (editorInstance) editorInstance.updateOptions({ readOnly: true });
                sendlog(globalStudentName, `❌ המבחן ננעל עקב הפרת נהלים`);
            }
            async function unlockByPassword() {
                const pwd = await Sys.prompt("הכנס סיסמת מורה לשחרור:", true);
                if (pwd === remotePassword) {
                    document.getElementById('exam-lockdown-overlay').style.display = 'none'; if (editorInstance) editorInstance.updateOptions({ readOnly: false }); examStrikes = 0; await Sys.alert("המבחן שוחרר.");
                } else if (pwd !== null) await Sys.alert("סיסמה שגויה");
            }

            async function clearChat() {
                if (await Sys.confirm("האם לנקות את הצ'אט?")) document.getElementById('chat-window').innerHTML = `<div class="chat-msg msg-ai">${WELCOME_MSG}</div>`;
            }

            async function sendToAI() {
                if (isExamMode) return;
                const inputField = document.getElementById('ai-input');
                const userText = inputField.value.trim();
                if (!userText) return;

                const loading = document.getElementById('ai-loading');

                try {
                    addMessage(userText, 'user');
                    inputField.value = '';
                    loading.style.display = 'flex';

                    if (editorInstance && !isLearningMode) files[activeFileName] = editorInstance.getValue();

                    let fullCode = "";
                    Object.keys(files).forEach(f => { fullCode += `\n// File: ${f}\n${files[f]}`; });

                    const chatMsgs = document.querySelectorAll('.chat-msg');
                    let recentChat = "";
                    for (let i = Math.max(0, chatMsgs.length - 4); i < chatMsgs.length; i++) {
                        recentChat += `${chatMsgs[i].classList.contains('msg-ai') ? "AI" : "User"}: ${chatMsgs[i].innerText}\n`;
                    }

                    let currentSystemPrompt = "";
                    let contextInfo = "";

                    if (isLearningMode && currentLessonContext) {
                        currentSystemPrompt = LESSON_PROMPT;
                        contextInfo = `CURRENT LESSON CONTEXT:\nTitle: ${currentLessonContext.title}\nContent: ${currentLessonContext.text}\nCode Snippet: ${currentLessonContext.code}`;
                    } else {
                        currentSystemPrompt = TEACHER_PROMPT;
                        const activeTaskDescription = currentActiveExercise ? currentActiveExercise.task : "General Help";
                        contextInfo = `EXERCISE CONTEXT:\nTask: ${activeTaskDescription}`;
                    }

                    const fullPrompt = `${currentSystemPrompt}\n\n${contextInfo}\n\nRECENT CHAT:\n${recentChat}\n\nSTUDENT CODE:\n${fullCode}\n\nSTUDENT QUESTION: ${userText}`;

                    const response = await fetch('https://text.pollinations.ai/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            messages: [{ role: 'user', content: fullPrompt }],
                            model: 'openai',
                            jsonMode: false
                        })
                    });

                    let aiText = await response.text();
                    aiText = aiText.replace(/"error"/i, "Error").replace(/(\n\s*---\s*\n[\s\S]*?(Pollinations|Support|mission|kofi)[\s\S]*$)/i, "").replace(/🌸 \*\*Ad\*\* 🌸/g, "").trim();

                    addMessage(aiText, 'ai');
                } catch (error) {
                    console.error(error);
                    addMessage("⚠️ שגיאת תקשורת.", 'ai');
                }
                finally {
                    loading.style.display = 'none';
                }
            }

            function addMessage(text, sender) {
                const cw = document.getElementById('chat-window'); const d = document.createElement('div'); d.className = `chat-msg msg-${sender}`;
                if (sender === 'ai') {
                    const codeMap = [];
                    const hiddenText = text.replace(/```([\s\S]*?)```/g, (match, rawCode) => {
                        let cleanCode = rawCode.trim().replace(/^(?:java|Java|text)\s+/i, "");
                        const safeCode = cleanCode.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        codeMap.push(safeCode);
                        return `___CODE_BLOCK_${codeMap.length - 1}___`;
                    });
                    let formattedText = hiddenText.replace(/\n/g, '<br>').replace(/___CODE_BLOCK_(\d+)___/g, (m, i) => `<div class="code-block"><button class="copy-btn" onclick="copyCode(this)">Copy</button>${codeMap[i]}</div>`);
                    d.innerHTML = formattedText;
                } else { d.innerHTML = text.replace(/\n/g, '<br>'); }
                cw.appendChild(d); cw.scrollTop = cw.scrollHeight;
            }

            function handleChatKey(e) { if (e.key === 'Enter') sendToAI(); }
            function renderTabs() { const c = document.getElementById('tabs-container'), b = document.getElementById('add-tab-btn'); c.innerHTML = ''; Object.keys(files).forEach(f => { const t = document.createElement('div'); t.className = `tab ${f === activeFileName ? 'active' : ''}`; t.innerHTML = `<span>${f}</span>`; t.onclick = () => switchTab(f); t.oncontextmenu = (e) => openContextMenu(e, f); c.appendChild(t); }); c.appendChild(b); }
            function switchTab(f) { files[activeFileName] = editorInstance.getValue(); activeFileName = f; editorInstance.setValue(files[activeFileName]); renderTabs(); }
            function openContextMenu(e, f) { e.preventDefault(); if (f === "Main.java") return; contextMenuTarget = f; const m = document.getElementById('context-menu'); m.style.display = 'block'; m.style.left = e.pageX + 'px'; m.style.top = e.pageY + 'px'; }
            function closeContextMenu() { document.getElementById('context-menu').style.display = 'none'; }
            async function triggerDelete() { if (!contextMenuTarget) return; if (await Sys.confirm(`Delete ${contextMenuTarget}?`)) { delete files[contextMenuTarget]; if (activeFileName === contextMenuTarget) { activeFileName = "Main.java"; editorInstance.setValue(files[activeFileName]); } renderTabs(); } }
            function triggerRename() { if (!contextMenuTarget) return; document.getElementById('rename-overlay').style.display = 'flex'; document.getElementById('rename-filename').value = contextMenuTarget; }
            async function performRename() { let n = document.getElementById('rename-filename').value.trim(); if (!n.endsWith('.java')) n += '.java'; if (files[n]) { await Sys.alert('Exists!'); return; } files[n] = files[contextMenuTarget]; delete files[contextMenuTarget]; if (activeFileName === contextMenuTarget) activeFileName = n; document.getElementById('rename-overlay').style.display = 'none'; renderTabs(); }
            function closeRenameModal() { document.getElementById('rename-overlay').style.display = 'none'; }

            function openNewFileModal() {
                document.getElementById('new-file-name').value = '';
                document.getElementById('lib-container').style.display = 'none';
                document.getElementById('lib-container').innerHTML = '';
                document.getElementById('new-file-overlay').style.display = 'flex';
                document.getElementById('new-file-name').focus();
            }
            function closeNewFileModal() { document.getElementById('new-file-overlay').style.display = 'none'; }

            async function fetchLibraryClasses() {
                const container = document.getElementById('lib-container'); const loader = document.getElementById('lib-loader');
                container.style.display = 'block'; if (container.children.length > 0) return; loader.style.display = 'block';
                try {
                    const url = `${CONTROL_SCRIPT_URL}?action=getLibraryClasses`; const res = await fetch(url); const data = await res.json();
                    loader.style.display = 'none';
                    if (data.classes && Object.keys(data.classes).length > 0) {
                        Object.keys(data.classes).forEach(className => {
                            const item = document.createElement('div'); item.className = 'project-item';
                            item.innerHTML = `<div style="display:flex; align-items:center; gap:10px;"><i class="fa-solid fa-code" style="color: #a8c7fa;"></i><span style="font-family: monospace; font-size: 14px;">${className}.java</span></div><i class="fa-solid fa-plus" style="color: #666; font-size: 12px;"></i>`;
                            item.onclick = () => addLibraryFile(className, data.classes[className]);
                            container.appendChild(item);
                        });
                    } else container.innerHTML = '<div style="padding:15px; text-align:center; color:#aaa; font-size:13px;">המאגר ריק</div>';
                } catch (e) { loader.style.display = 'none'; container.innerHTML = '<div style="padding:15px; text-align:center; color:#ff4d4d; font-size:13px;">שגיאה בטעינה</div>'; }
            }
            async function addLibraryFile(name, code) {
                const fileName = name + ".java";
                if (files[fileName]) { if (!await Sys.confirm(`הקובץ ${fileName} כבר קיים. האם לדרוס?`)) return; }
                files[fileName] = code; finalizeFileAdd(fileName);
            }
            async function createCustomFile() {
                let name = document.getElementById('new-file-name').value.trim().replace(".java", ""); if (!name) return;
                const fileName = name + ".java"; if (files[fileName]) { await Sys.alert("קיים!"); return; }
                files[fileName] = `public class ${name} {\n    \n}`; finalizeFileAdd(fileName);
            }
            function finalizeFileAdd(fileName) {
                closeNewFileModal();
                activeFileName = fileName;
                editorInstance.setValue(files[activeFileName]);
                renderTabs();
                // שינוי: מחקתי את שורת ה-Sys.alert שהיתה כאן
            }
            async function runCode() {
                if (isExamMode) { await Sys.alert("ההרצה חסומה במצב מבחן."); return; }
                if (!editorInstance) return; files[activeFileName] = editorInstance.getValue();
                const btn = document.getElementById('runBtn'), icon = document.getElementById('btnIcon'), out = document.getElementById('output-container'), stdin = document.getElementById('stdin-input').value;
                let fullCode = ""; Object.values(files).forEach(c => fullCode += c);
                btn.disabled = true; icon.className = "fa-solid fa-circle-notch fa-spin"; out.innerHTML = '<span class="success-msg">Compiling...</span><br>';
                let allImports = new Set(), mainContent = "", otherContent = "", importRegex = /^\s*import\s+.*;/gm;
                if (files["Main.java"]) { let c = files["Main.java"], i = c.match(importRegex); if (i) i.forEach(x => allImports.add(x.trim())); mainContent = c.replace(importRegex, "").trim(); }
                Object.keys(files).forEach(f => { if (f === "Main.java") return; let c = files[f], i = c.match(importRegex); if (i) i.forEach(x => allImports.add(x.trim())); let clean = c.replace(importRegex, "").trim().replace(/public\s+class/g, "class"); otherContent += "\n\n" + clean; });
                const merged = Array.from(allImports).join("\n") + "\n\n" + mainContent + otherContent;
                try {
                    const res = await fetch('https://emkc.org/api/v2/piston/execute', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ language: "java", version: "15.0.2", files: [{ name: "Main.java", content: merged }], stdin: stdin }) });
                    const data = await res.json(); out.innerHTML = "";
                    if (data.run) {
                        if (data.run.stdout) out.appendChild(Object.assign(document.createElement('span'), { className: 'output-text', innerText: data.run.stdout }));
                        if (data.run.stderr) out.appendChild(Object.assign(document.createElement('span'), { className: 'error-text', innerText: "\n" + data.run.stderr }));
                    } else out.innerHTML = '<span class="error-text">Error: No response.</span>';
                } catch (e) { out.innerHTML += `<br><span class="error-text">Net Error: ${e.message}</span>`; }
                finally { btn.disabled = false; icon.className = "fa-solid fa-play"; }
            }

            // --- Python Tutor Integration Start ---

            window.openVisualizer = function () {
                // 1. עדכון המידע מהעורך
                if (editorInstance) {
                    files[activeFileName] = editorInstance.getValue();
                }

                // -- עיבוד הקוד (זהה לקודם) --
                let mainContent = "";
                let otherContent = "";
                let allImports = new Set();
                const importRegex = /^\s*import\s+.*;/gm;

                if (files["Main.java"]) {
                    let c = files["Main.java"];
                    let i = c.match(importRegex);
                    if (i) i.forEach(x => allImports.add(x.trim()));
                    mainContent = c.replace(importRegex, "").trim();
                } else {
                    Sys.alert("לא נמצא קובץ Main.java");
                    return;
                }

                Object.keys(files).forEach(f => {
                    if (f === "Main.java") return;
                    let c = files[f];
                    let i = c.match(importRegex);
                    if (i) i.forEach(x => allImports.add(x.trim()));
                    let clean = c.replace(importRegex, "").trim().replace(/public\s+class/g, "class").replace(/public\s+interface/g, "interface").replace(/public\s+enum/g, "enum");
                    //let clean = c.replace(importRegex, "").replace(/\/\/.*/g, "").replace(/\r?\n/g, " ").replace(/\s+/g, " ").trim().replace(/public\s+class/g, "class").replace(/public\s+interface/g, "interface").replace(/public\s+enum/g, "enum");
                    otherContent += "\n" + clean;
                });

                const mergedCode = Array.from(allImports).join("\n") + "\n\n" + otherContent + "\n\n" + mainContent;
                // -- סוף עיבוד הקוד --

                // 2. טיפול בתצוגה
                const overlay = document.getElementById('visualizer-overlay');
                const vizContainer = document.getElementById('viz-container'); // ה-div הפנימי החדש
                const loader = document.getElementById('visualizer-loader');

                // ניקוי המכולה (הפתרון הגרעיני)
                vizContainer.innerHTML = '';

                // הצגת הטוען מיד
                loader.style.display = 'flex';
                overlay.style.display = 'flex';

                // יצירת ה-iframe
                const newIframe = document.createElement('iframe');
                newIframe.id = 'visualizer-iframe';
                // הוספתי border-radius כדי לשמור על הפינות העגולות שביקשת
                newIframe.style.cssText = "width: 100%; height: 100%; border: none; filter: invert(1) hue-rotate(180deg); background-color: #fff; border-radius: 0 0 12px 12px;";

                // כתובת + פרמטרים
                const baseUrl = "https://pythontutor.com/iframe-embed.html#";
                const params = `code=${encodeURIComponent(mergedCode)}&py=java&curInstr=0&origin=opt-frontend.js&cumulative=false&heapPrimitives=nevernest&textReferences=false&rawInputLstJSON=%5B%5D`;

                // הטריק: ברגע שהטעינה מסתיימת -> העלם את הטוען
                newIframe.onload = function () {
                    // טריק: מחכים 2 שניות נוספות כדי לתת לסקריפט של Python Tutor לסיים לצייר
                    // זה מונע את הבהוב המסך השחור
                    setTimeout(function () {
                        loader.style.display = 'none';
                    }, 2000);
                };

                newIframe.src = baseUrl + params;
                vizContainer.appendChild(newIframe);
            };
            // --- Python Tutor Integration End ---

            function resetWorkspace() { files = { "Main.java": `public class Main {\n    public static void main(String[] args) {\n        \n    }\n}` }; activeFileName = "Main.java"; editorInstance.setValue(files[activeFileName]); renderTabs(); }

            window.copyCode = function (btn) { const cb = btn.parentElement.cloneNode(true); cb.querySelector('.copy-btn').remove(); navigator.clipboard.writeText(cb.textContent.trim()).then(() => { const o = btn.innerText; btn.innerText = "Copied!"; btn.style.color = "#4EC9B0"; setTimeout(() => { btn.innerText = o; btn.style.color = "#ccc"; }, 1500); }); };

            function changeFontSize(d) { currentFontSize = Math.max(10, Math.min(30, currentFontSize + d)); if (editorInstance) editorInstance.updateOptions({ fontSize: currentFontSize }); document.getElementById('output-container').style.fontSize = currentFontSize + 'px'; document.getElementById('stdin-input').style.fontSize = currentFontSize + 'px'; }

            function switchViewMode(mode) {
                // בדיקות מקדימות
                if (isExamMode && mode === 'lesson') {
                    Sys.alert("לא ניתן לעבור לשיעורים בזמן מבחן");
                    return;
                }

                // עדכון משתנה המצב הגלובלי
                isLearningMode = (mode === 'lesson');

                const btnEditor = document.getElementById('mode-editor-btn');
                const btnLesson = document.getElementById('mode-lesson-btn');

                const ideBody = document.querySelector('.ide-body');
                const lessonPanel = document.getElementById('lesson-panel');
                const leftGroup = document.getElementById('left-header-group');

                if (mode === 'lesson') {
                    // --- כניסה למצב שיעור ---
                    btnLesson.classList.add('active');
                    btnEditor.classList.remove('active');

                    // שינוי קריטי: שומר על המקום הריק כדי שהכפתור לא יקפוץ
                    leftGroup.style.visibility = 'hidden';

                    ideBody.style.display = 'none';   // הסתרת העורך
                    lessonPanel.style.display = 'flex'; // הצגת השיעור

                    // טעינת שיעורים אם טרם נטענו
                    if (Object.keys(lessonsData).length === 0) fetchLessons();

                } else {
                    // --- כניסה למצב עורך ---
                    btnEditor.classList.add('active');
                    btnLesson.classList.remove('active');

                    leftGroup.style.visibility = 'visible'; // החזרה למצב נראה

                    ideBody.style.display = 'flex';   // הצגת העורך
                    lessonPanel.style.display = 'none'; // הסתרת השיעור

                    // רענון העורך (חשוב כשחוזרים ממצב מוסתר)
                    if (editorInstance) editorInstance.layout();
                }
            }
            window.switchViewMode = switchViewMode;

            async function fetchLessons() {
                const menuContainer = document.getElementById('lesson-menu-container');
                menuContainer.innerHTML = '<div style="padding:20px; text-align:center;"><i class="fa-solid fa-circle-notch fa-spin"></i> טוען...</div>';
                try {
                    const timestamp = new Date().getTime();
                    const url = `${CONTROL_SCRIPT_URL}?action=getLessons&t=${timestamp}`;

                    const res = await fetch(url);
                    const data = await res.json();

                    if (data.lessons) {
                        lessonsData = data.lessons;
                        renderLessonMenu();
                    }
                    else {
                        menuContainer.innerHTML = 'לא נמצאו שיעורים';
                    }
                } catch (e) {
                    menuContainer.innerHTML = 'שגיאה בטעינה';
                }
            }

            // --- התחלת מקטע חדש: סינון שיעורים לפי מקצוע ---

            // 1. משתנה גלובלי למקצוע הנוכחי
            let currentSubjectMode = 'CS'; // ברירת מחדל: מדעי המחשב

            // 2. פונקציה להחלפת מקצוע (מופעלת בלחיצה על הכפתורים)
            window.setSubjectMode = function (mode) {
                currentSubjectMode = mode;

                // עדכון ויזואלי של הכפתורים
                document.querySelectorAll('.subject-btn').forEach(btn => btn.classList.remove('active'));

                if (mode === 'CS') {
                    const btn = document.getElementById('btn-subj-cs');
                    if (btn) btn.classList.add('active');
                }
                if (mode === 'MATH') {
                    const btn = document.getElementById('btn-subj-math');
                    if (btn) btn.classList.add('active');
                }
                if (mode === 'PHYSICS') {
                    const btn = document.getElementById('btn-subj-phys');
                    if (btn) btn.classList.add('active');
                }

                // רינדור מחדש של התפריט עם הסינון החדש
                renderLessonMenu();
            }

            // 3. הפונקציה המעודכנת לרינדור התפריט (כולל סינון מקצועות + אנימציה לנקודות)
            function renderLessonMenu() {
                const container = document.getElementById('lesson-menu-container');
                if (!container) return;

                container.innerHTML = '';

                // הגדרת התגיות לחיפוש
                const TAG_CS = "מדמח - ";
                const TAG_MATH = "מתמטיקה - ";
                const TAG_PHYS = "פיזיקה - ";

                let hasItems = false;

                Object.keys(lessonsData).forEach((rawMainCat) => {

                    // --- לוגיקת סינון המקצועות ---
                    let displayMainCat = "";
                    let shouldShow = false;

                    if (currentSubjectMode === 'CS') {
                        if (rawMainCat.startsWith(TAG_CS)) {
                            displayMainCat = rawMainCat.replace(TAG_CS, "");
                            shouldShow = true;
                        } else if (!rawMainCat.startsWith(TAG_MATH) && !rawMainCat.startsWith(TAG_PHYS)) {
                            displayMainCat = rawMainCat;
                            shouldShow = true;
                        }
                    }
                    else if (currentSubjectMode === 'MATH') {
                        if (rawMainCat.startsWith(TAG_MATH)) {
                            displayMainCat = rawMainCat.replace(TAG_MATH, "");
                            shouldShow = true;
                        }
                    }
                    else if (currentSubjectMode === 'PHYSICS') {
                        if (rawMainCat.startsWith(TAG_PHYS)) {
                            displayMainCat = rawMainCat.replace(TAG_PHYS, "");
                            shouldShow = true;
                        }
                    }

                    if (!shouldShow) return;
                    hasItems = true;

                    // --- יצירת הקטגוריה הראשית ---
                    const mainCatDiv = document.createElement('div');
                    mainCatDiv.className = 'lesson-category';
                    mainCatDiv.innerHTML = `<span style="color: #a8c7fa; font-size:15px;">${displayMainCat}</span> <i class="fa-solid fa-chevron-down"></i>`;
                    mainCatDiv.style.borderBottom = "1px solid #444";
                    mainCatDiv.style.backgroundColor = "#252627";

                    const mainItemsDiv = document.createElement('div');
                    mainItemsDiv.className = 'lesson-items';

                    mainCatDiv.onclick = () => {
                        mainItemsDiv.classList.toggle('open');
                        const icon = mainCatDiv.querySelector('i');
                        if (mainItemsDiv.classList.contains('open')) {
                            icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
                        } else {
                            icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
                        }
                    };

                    const subCategories = lessonsData[rawMainCat];
                    Object.keys(subCategories).forEach(subCat => {
                        const subWrapper = document.createElement('div');
                        subWrapper.style.borderBottom = "1px solid #2d2e30";

                        // --- זיהוי נקודה אדומה בקטגוריה משנית ---
                        let subCatDisplay = subCat;
                        if (subCat.includes("🔴")) {
                            subCatDisplay = subCat.replace("🔴", '<span class="pulse-dot">🔴</span>');
                        }
                        // ----------------------------------------

                        const subHeader = document.createElement('div');
                        subHeader.style.padding = "10px 15px";
                        subHeader.style.fontSize = "13px";
                        subHeader.style.color = "#e3e3e3";
                        subHeader.style.fontWeight = "bold";
                        subHeader.style.backgroundColor = "#1e1f20";
                        subHeader.style.cursor = "pointer";
                        subHeader.style.display = "flex";
                        subHeader.style.justifyContent = "space-between";
                        subHeader.style.alignItems = "center";
                        subHeader.style.userSelect = "none";

                        subHeader.innerHTML = `
                                    <div style="display:flex; align-items:center; gap:8px;">
                                        <i class="fa-solid fa-chevron-left" style="font-size:10px; color:#888; transition: transform 0.2s;"></i>
                                        <span>${subCatDisplay}</span>
                                    </div>
                                `;

                        const lessonsContainer = document.createElement('div');
                        lessonsContainer.style.display = "none";
                        lessonsContainer.style.backgroundColor = "#131314";

                        subHeader.onclick = (e) => {
                            e.stopPropagation();
                            const isOpen = lessonsContainer.style.display === "block";
                            const icon = subHeader.querySelector('i');

                            if (isOpen) {
                                lessonsContainer.style.display = "none";
                                icon.style.transform = "rotate(0deg)";
                            } else {
                                lessonsContainer.style.display = "block";
                                icon.style.transform = "rotate(-90deg)";
                            }
                        };

                        subCategories[subCat].forEach(lesson => {
                            const lDiv = document.createElement('div');
                            lDiv.className = 'lesson-item';

                            // --- זיהוי נקודה אדומה בשם השיעור ---
                            if (lesson.title.includes("🔴")) {
                                lDiv.innerHTML = lesson.title.replace("🔴", '<span class="pulse-dot">🔴</span>');
                            } else {
                                lDiv.innerText = lesson.title;
                            }
                            // ------------------------------------

                            lDiv.style.paddingRight = "35px";
                            lDiv.style.fontSize = "13px";
                            lDiv.style.color = "#aaa";

                            lDiv.onclick = (e) => {
                                e.stopPropagation();
                                loadLessonContent(lDiv, lesson);
                            };
                            lessonsContainer.appendChild(lDiv);
                        });

                        subWrapper.appendChild(subHeader);
                        subWrapper.appendChild(lessonsContainer);
                        mainItemsDiv.appendChild(subWrapper);
                    });

                    container.appendChild(mainCatDiv);
                    container.appendChild(mainItemsDiv);
                });

                if (!hasItems) {
                    container.innerHTML = `<div style="padding:20px; text-align:center; color:#666; font-size:13px;">אין שיעורים בקטגוריה זו</div>`;
                }
            }
            // --- סוף מקטע סינון שיעורים ---
            function loadLessonContent(element, lesson) {
                lessonScale = 1.0;
                isLessonDark = true;

                // 1. סימון הפריט הפעיל בתפריט הצד
                document.querySelectorAll('.lesson-item').forEach(el => el.classList.remove('active-lesson'));
                element.classList.add('active-lesson');

                currentLessonContext = lesson;

                // 2. תפיסת אזור התוכן וניקוי מוחלט שלו
                const lessonContentDiv = document.getElementById('lesson-content');
                lessonContentDiv.innerHTML = ''; // מוחק הכל: כותרות, נגנים, קוד ישן

                // 3. ביטול ריפודים כדי לנצל את כל השטח (Full Screen בתוך החלון)
                lessonContentDiv.style.padding = "0";
                lessonContentDiv.style.overflow = "hidden"; // ביטול גלילה חיצונית (רק הפנימית תעבוד)

                const content = lesson.text ? lesson.text.trim() : "";
                let contentElement;

                // --- אפשרות א': אם זה קישור (גוגל דוקס, דרייב או PDF) ---
                if (content.startsWith("http") && (content.includes("docs.google.com") || content.includes("drive.google.com") || content.trim().toLowerCase().endsWith(".pdf"))) {
                    let embedUrl = content.trim();

                    // 1. טיפול בקישורי גוגל (הפיכה לתצוגה מקדימה + ניקוי סרגל כלים)
                    if (embedUrl.includes("google.com")) {
                        // המרה ל-preview
                        if (embedUrl.includes("/edit")) embedUrl = embedUrl.replace(/\/edit.*/, "/preview");
                        else if (embedUrl.includes("/view")) embedUrl = embedUrl.replace(/\/view.*/, "/preview");

                        // --- התוספת החדשה: הסתרת ה-Toolbar ---
                        // rm=minimal הוא הפרמטר של גוגל שמסתיר את התפריטים
                        if (!embedUrl.includes("rm=minimal")) {
                            embedUrl += (embedUrl.includes('?') ? '&' : '?') + "rm=minimal";
                        }
                    }

                    // 2. אם זה PDF (בגוגל או בחוץ) - התאמה לרוחב המסך
                    if (embedUrl.toLowerCase().endsWith(".pdf") || embedUrl.includes("/preview")) {
                        // מוסיף view=FitH רק אם זה לא קיים כבר
                        if (!embedUrl.includes("view=")) {
                            embedUrl += (embedUrl.includes('#') ? '&' : '#') + "view=FitH";
                        }
                    }

                    // יצירת iframe שתופס 100% מהגובה והרוחב
                    contentElement = document.createElement('iframe');
                    contentElement.src = embedUrl;
                    contentElement.className = 'doc-frame';

                    contentElement.style.width = "100%";
                    contentElement.style.height = "100%";
                    contentElement.style.border = "none";
                    contentElement.style.display = "block";

                    // פילטר צבעים (למצב לילה)
                    contentElement.style.filter = "invert(1) hue-rotate(180deg)";
                    contentElement.style.background = "#fff";

                } else {
                    // ... (קוד הטקסט הרגיל נשאר ללא שינוי) ...
                    contentElement = document.createElement('div');
                    contentElement.id = 'lesson-body';
                    contentElement.style.padding = "30px";
                    contentElement.style.width = "100%";
                    contentElement.style.height = "100%";
                    contentElement.style.overflowY = "auto";
                    contentElement.style.boxSizing = "border-box";
                    contentElement.innerHTML = parseMarkdown(content);
                }

                // 4. הוספת האלמנט הסופי למסך
                lessonContentDiv.appendChild(contentElement);

                // הודעה קטנה במערכת (לא מפריעה למשתמש)
                addMessage(`פתחת את השיעור: <b>${lesson.title}</b>.`, 'system');
            }

            function renderLandingPage(url) {
                const lessonContentDiv = document.getElementById('lesson-content');
                if (!lessonContentDiv) return;

                // ניקוי המסך (מוחק את הטקסט "בחרו שיעור...")
                lessonContentDiv.innerHTML = '';
                lessonContentDiv.style.padding = "0";
                lessonContentDiv.style.overflow = "hidden";

                let embedUrl = url;
                // המרה ל-Preview כמו בשיעורים רגילים
                if (embedUrl.includes("/edit")) embedUrl = embedUrl.replace(/\/edit.*/, "/preview");
                else if (embedUrl.includes("/view")) embedUrl = embedUrl.replace(/\/view.*/, "/preview");

                const iframe = document.createElement('iframe');
                iframe.src = embedUrl;
                iframe.className = 'doc-frame'; // שימוש באותה מחלקה כדי לקבל את הפילטרים (מצב לילה)
                iframe.style.width = "100%";
                iframe.style.height = "100%";
                iframe.style.border = "none";
                iframe.style.display = "block";

                // הגדרת מצב לילה כברירת מחדל (תואם לשאר המערכת)
                iframe.style.filter = "invert(1) hue-rotate(180deg)";
                iframe.style.background = "#fff";

                lessonContentDiv.appendChild(iframe);
            }

            async function copyLessonCode() {
                if (!currentLessonContext || !currentLessonContext.code) return;
                if (await Sys.confirm("האם להעתיק את הקוד לעורך?\n(שים לב: הקוד הנוכחי יידרס)")) {
                    toggleLearningMode();
                    editorInstance.setValue(currentLessonContext.code);
                    files[activeFileName] = currentLessonContext.code;
                }
            }

            function initResizers() {
                const resizerV = document.getElementById('resizer-v'), aiPanel = document.getElementById('ai-panel'), resizerH = document.getElementById('resizer-h'), editorWrapper = document.getElementById('editor-wrapper'), resizerIO = document.getElementById('resizer-io'), inputContainer = document.getElementById('input-container'), bottomPanel = document.getElementById('bottom-panel');

                resizerV.addEventListener('mousedown', function (e) { e.preventDefault(); document.addEventListener('mousemove', resizeX); document.addEventListener('mouseup', stopResizeX); resizerV.classList.add('active'); });


                function resizeX(e) {
                    aiPanel.style.width = Math.max(360, Math.min(window.innerWidth - e.clientX, window.innerWidth * 0.4)) + 'px';
                    if (editorInstance) editorInstance.layout();
                }


                function stopResizeX() { document.removeEventListener('mousemove', resizeX); document.removeEventListener('mouseup', stopResizeX); resizerV.classList.remove('active'); }

                resizerH.addEventListener('mousedown', function (e) { e.preventDefault(); document.addEventListener('mousemove', resizeY); document.addEventListener('mouseup', stopResizeY); resizerH.classList.add('active'); });
                function resizeY(e) { editorWrapper.style.height = Math.max(100, Math.min(e.clientY - document.getElementById('ide-panel').offsetTop - 90, document.getElementById('ide-panel').offsetHeight - 150)) + 'px'; if (editorInstance) editorInstance.layout(); }
                function stopResizeY() { document.removeEventListener('mousemove', resizeY); document.removeEventListener('mouseup', stopResizeY); resizerH.classList.remove('active'); }

                resizerIO.addEventListener('mousedown', function (e) { e.preventDefault(); document.addEventListener('mousemove', resizeIO); document.addEventListener('mouseup', stopResizeIO); resizerIO.classList.add('active'); });
                function resizeIO(e) { inputContainer.style.width = Math.max(100, Math.min(bottomPanel.getBoundingClientRect().right - e.clientX, bottomPanel.getBoundingClientRect().width - 100)) + 'px'; }
                function stopResizeIO() { document.removeEventListener('mousemove', resizeIO); document.removeEventListener('mouseup', stopResizeIO); resizerIO.classList.remove('active'); }
            }

            function saveProject() { document.getElementById('save-input-name').value = ''; document.getElementById('save-status-msg').innerHTML = ''; document.getElementById('save-overlay').style.display = 'flex'; document.getElementById('save-input-name').focus(); }
            async function performSaveLogic() {
                const nameInput = document.getElementById('save-input-name'); const statusDiv = document.getElementById('save-status-msg'); const projectName = nameInput.value.trim();
                if (!projectName) { statusDiv.innerHTML = '<span class="status-error">שם חסר</span>'; return; }
                statusDiv.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> שומר...'; nameInput.disabled = true;
                try {
                    const payload = encodeURIComponent(JSON.stringify(files));
                    const url = `${CONTROL_SCRIPT_URL}?action=saveProject&user=${encodeURIComponent(globalStudentName)}&project=${encodeURIComponent(projectName)}&files=${payload}&t=${new Date().getTime()}`;
                    const res = await fetch(url); const data = await res.json();
                    if (data.result === "OK") { statusDiv.innerHTML = '<span class="status-success">נשמר!</span>'; setTimeout(() => { document.getElementById('save-overlay').style.display = 'none'; nameInput.disabled = false; }, 1500); }
                    else if (data.result === "EXISTS") { statusDiv.innerHTML = '<span class="status-error">השם קיים</span>'; nameInput.disabled = false; }
                    else { statusDiv.innerHTML = `<span class="status-error">${data.error}</span>`; nameInput.disabled = false; }
                } catch (e) { statusDiv.innerHTML = '<span class="status-error">שגיאה</span>'; nameInput.disabled = false; }
            }

            async function loadProject() {
                const overlay = document.getElementById('load-overlay');
                const titleElement = overlay.querySelector('h3');
                const firstName = getFirstName(globalStudentName);

                if (titleElement) titleElement.innerText = `הפרויקטים של ${firstName}`;

                const listArea = document.getElementById('project-list-area');
                const statusDiv = document.getElementById('load-status-msg');

                listArea.classList.remove('list-busy');
                overlay.style.display = 'flex';
                injectBotLiToAllModals();

                // --- שינוי: במקום טקסט "טוען" קטן, הזרקת אנימציה למרכז המסך ---
                statusDiv.innerHTML = ''; // ניקוי שורת הסטטוס הקטנה
                listArea.innerHTML = `
                                        <div style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                            <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 40px; color: #a8c7fa; margin-bottom: 15px;"></i>
                                            <span style="font-size: 14px; color: #aaa;">טוען רשימת פרויקטים...</span>
                                        </div>
                                    `;
                // -----------------------------------------------------------

                try {
                    const listUrl = `${CONTROL_SCRIPT_URL}?action=listProjects&user=${encodeURIComponent(globalStudentName)}&t=${new Date().getTime()}`;
                    const listRes = await fetch(listUrl);
                    const listData = await listRes.json();

                    statusDiv.innerHTML = '';
                    listArea.innerHTML = ''; // מחיקת האנימציה לפני טעינת הרשימה

                    if (!listData.projects || listData.projects.length === 0) {
                        listArea.innerHTML = '<div style="padding:20px; text-align:center; color:#aaa;">אין פרויקטים</div>';
                        return;
                    }

                    listData.projects.reverse().forEach(projName => {
                        const item = document.createElement('div'); item.className = 'project-item';
                        item.innerHTML = `<div style="display:flex; align-items:center; gap:10px;"><i class="fa-solid fa-folder"></i><span>${projName}</span></div><div class="delete-btn" onclick="deleteProject(event, '${projName}')"><i class="fa-solid fa-trash"></i></div>`;

                        item.querySelector('.delete-btn').addEventListener('click', (e) => deleteProject(e, projName));
                        item.addEventListener('click', (e) => { if (e.target.closest('.delete-btn')) return; loadSpecificProject(projName); });

                        item.removeAttribute('onclick');
                        item.querySelector('.delete-btn').removeAttribute('onclick');

                        listArea.appendChild(item);
                    });
                } catch (e) {
                    listArea.innerHTML = '<div style="padding:20px; text-align:center; color:#f2b8b5;">שגיאה בטעינה</div>';
                }
            }

            async function deleteProject(e, name) {
                e.stopPropagation(); if (await Sys.confirm(`למחוק את "${name}"?`)) {
                    const statusDiv = document.getElementById('load-status-msg'); const listArea = document.getElementById('project-list-area');
                    listArea.classList.add('list-busy'); statusDiv.innerHTML = 'מוחק...';
                    try {
                        const url = `${CONTROL_SCRIPT_URL}?action=deleteProject&user=${encodeURIComponent(globalStudentName)}&project=${encodeURIComponent(name)}`;
                        const res = await fetch(url); const data = await res.json();
                        if (data.result === "OK") { loadProject(); setTimeout(() => Sys.alert("נמחק"), 200); } else { listArea.classList.remove('list-busy'); statusDiv.innerHTML = 'שגיאה'; }
                    } catch (err) { listArea.classList.remove('list-busy'); statusDiv.innerHTML = 'שגיאה'; }
                }
            }

            async function loadSpecificProject(name) {
                const statusDiv = document.getElementById('load-status-msg'); const listArea = document.getElementById('project-list-area');
                listArea.classList.add('list-busy'); statusDiv.innerHTML = `טוען את: <b>${name}</b>...`;
                try {
                    const loadUrl = `${CONTROL_SCRIPT_URL}?action=loadProject&user=${encodeURIComponent(globalStudentName)}&project=${encodeURIComponent(name)}&t=${new Date().getTime()}`;
                    const res = await fetch(loadUrl); const data = await res.json();
                    if (data.files) {
                        files = JSON.parse(data.files); activeFileName = Object.keys(files)[0]; editorInstance.setValue(files[activeFileName]); renderTabs();
                        statusDiv.innerHTML = `נטען!`; setTimeout(() => { document.getElementById('load-overlay').style.display = 'none'; listArea.classList.remove('list-busy'); }, 500);
                    } else { statusDiv.innerHTML = `שגיאה`; listArea.classList.remove('list-busy'); }
                } catch (e) { statusDiv.innerHTML = 'שגיאה'; listArea.classList.remove('list-busy'); }
            }

            function getFirstName(fullName) {
                if (!fullName) return "תלמיד";
                return fullName.trim().split(/\s+/)[0];
            }

            function getUniqueDeviceId() {
                let deviceId = localStorage.getItem('school_device_id');
                if (!deviceId) {
                    const randomPart = Math.random().toString(36).substring(2, 10).toUpperCase();
                    deviceId = "DEV-" + randomPart;
                    localStorage.setItem('school_device_id', deviceId);
                }
                return deviceId;
            }

            function injectBotLiToAllModals() {
                const botliHeadHTML = `
                                                                            <div class="botli-head" style="position: absolute; top: -45px; left: 50%; transform: translateX(-50%); z-index: 10000; pointer-events: none;">
                                                                                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MCA4MCI+PHJlY3QgeD0iMTgiIHk9IjE4IiB3aWR0aD0iNDQiIGhlaWdodD0iNDAiIHJ4PSI4IiBmaWxsPSIjZmY0ZDRkIi8+PHJlY3QgeD0iOCIgeT0iMzAiIHdpZHRoPSI4IiBoZWlnaHQ9IjE2IiByeD0iMiIgZmlsbD0iI2ZmNGQ0ZCIvPjxyZWN0IHg9IjY0IiB5PSIzMCIgd2lkdGg9IjgiIGhlaWdodD0iMTYiIHJ4PSIyIiBmaWxsPSIjZmY0ZDRkIi8+PHJlY3QgeD0iMzYiIHk9IjgiIHdpZHRoPSI4IiBoZWlnaHQ9IjEwIiByeD0iMiIgZmlsbD0iI2ZmNGQ0ZCIvPjxjaXJjbGUgY3g9IjMwIiBjeT0iMzUiIHI9IjUiIGZpbGw9IiMxMzEzMTQiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjM1IiByPSI1IiBmaWxsPSIjMTMxMzE0Ii8+PHJlY3QgeD0iMjgiIHk9IjQ4IiB3aWR0aD0iNiIgaGVpZ2h0PSIzIiBmaWxsPSIjMTMxMzE0Ii8+PHJlY3QgeD0iMzciIHk9IjQ4IiB3aWR0aD0iNiIgaGVpZ2h0PSIzIiBmaWxsPSIjMTMxMzE0Ii8+PHJlY3QgeD0iNDYiIHk9IjQ4IiB3aWR0aD0iNiIgaGVpZ2h0PSIzIiBmaWxsPSIjMTMxMzE0Ii8+PC9zdmc+"
                                                                                style="width: 75px; height: 75px; background: #1e1f20; border-radius: 50%; padding: 5px; border: 3px solid #ff4d4d; box-shadow: 0 5px 15px rgba(0,0,0,0.5);">
                                                                            </div>
                                                                        `;
                document.querySelectorAll('.modal-box').forEach(box => {
                    // --- התיקון כאן: אם המחשבון ממוזער, אל תשנה לו את המיקום ---
                    if (box.id === 'calc-window' && isCalcMinimized) return;
                    if (box.id === 'calc-window' && typeof isCalcMinimized !== 'undefined' && isCalcMinimized) {
                        return;
                    }
                    box.querySelectorAll('.botli-head').forEach(el => el.remove());
                    box.querySelectorAll('img').forEach(img => {
                        if (img.src.includes('PHN2ZyB4bWx')) {
                            const wrapper = img.closest('div');
                            if (wrapper && wrapper !== box) wrapper.remove();
                            else img.remove();
                        }
                    });
                    box.insertAdjacentHTML('afterbegin', botliHeadHTML);
                    box.style.overflow = "visible";
                    box.style.position = "relative";
                    if (!box.style.paddingTop || parseInt(box.style.paddingTop) < 40) {
                        box.style.paddingTop = "45px";
                    }
                });
            }

            document.body.addEventListener('click', closeContextMenu);

            window.addEventListener('load', () => setTimeout(injectBotLiToAllModals, 500));
            document.addEventListener('click', (e) => {
                if (e.target.closest('button')) {
                    setTimeout(injectBotLiToAllModals, 50);
                }
            });
            setTimeout(injectBotLiToAllModals, 500);

            window.toggleAiCollapse = function () {
                const panel = document.getElementById('ai-panel');
                panel.classList.toggle('collapsed');

                // אם יש עורך קוד, צריך לעדכן את הגודל שלו כדי שיתפוס את המקום שהתפנה
                if (typeof editorInstance !== 'undefined') {
                    setTimeout(() => editorInstance.layout(), 300);
                }
            };

            function parseMarkdown(text) {
                if (!text) return "";
                text = text.trim();
                const codeBlocks = [];
                text = text.replace(/`([^`\n]+)`/g, (match, code) => {
                    codeBlocks.push(`<code>${code}</code>`);
                    return `___CODE_${codeBlocks.length - 1}___`;
                });
                text = text.replace(/^### (.*$)/gim, '<h3>$1</h3>');
                text = text.replace(/^## (.*$)/gim, '<h2>$1</h2>');
                text = text.replace(/^# (.*$)/gim, '<h1>$1</h1>');
                text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                text = text.replace(/^\* (.*$)/gim, '<li>$1</li>');
                text = text.replace(/((<li>.*<\/li>\s*)+)/gim, '<ul>$1</ul>');
                text = text.replace(/^---$/gim, '<hr>');
                text = text.replace(/___CODE_(\d+)___/g, (match, index) => codeBlocks[index]);
                text = text.replace(/\r\n/g, '\n');
                text = text.replace(/\n{3,}/g, '\n\n');
                text = text.replace(/(<\/h[1-6]>)\n+/g, '$1');
                text = text.replace(/(<\/ul>)\n+/g, '$1');
                text = text.replace(/\n+(<ul>)/g, '$1');
                text = text.replace(/(<hr>)\n+/g, '$1');
                text = text.replace(/\n/g, '<br>');
                return text;
            }

            // --- לוגיקה לצ'אט מורה (בתוך הבלוק הראשי) ---
            let tChatInterval = null;

            function openTeacherChat() {
                if (!globalStudentName) { Sys.alert("יש להתחבר תחילה כדי לדבר עם המורה."); return; }

                document.getElementById('t-chat-badge').style.display = 'none';
                document.getElementById('teacher-chat-overlay').style.display = 'flex';

                // --- שינוי: הצגת טוען + דיליי של 2 שניות ---
                const container = document.getElementById('t-chat-msgs');

                // 1. ניקוי והצגת אנימציית טעינה במרכז
                container.innerHTML = `
                                    <div style="height:100%; display:flex; justify-content:center; align-items:center; flex-direction:column; color:#888;">
                                        <i class="fa-solid fa-circle-notch fa-spin" style="font-size:30px; margin-bottom:10px;"></i>
                                        <span style="font-size:14px;">טוען הודעות...</span>
                                    </div>
                                `;

                // 2. המתנה של 2000ms (שתי שניות) לפני הטעינה האמיתית
                setTimeout(() => {
                    fetchTeacherChat(); // משיכת הנתונים

                    // התחלת הריענון האוטומטי רק אחרי הדיליי
                    if (tChatInterval) clearInterval(tChatInterval);
                    tChatInterval = setInterval(() => {
                        if (document.getElementById('teacher-chat-overlay').style.display === 'none') {
                            clearInterval(tChatInterval);
                        } else {
                            fetchTeacherChat();
                        }
                    }, 5000);
                }, 2000);
                // ---------------------------------------------
            }

            async function fetchTeacherChat() {
                try {
                    const url = `${CONTROL_SCRIPT_URL}?action=teacherChat&user=${encodeURIComponent(globalStudentName)}&t=${new Date().getTime()}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    const container = document.getElementById('t-chat-msgs');
                    if (data.chat !== undefined) {
                        renderTeacherChat(String(data.chat), container);
                    }
                } catch (e) { console.error(e); }
            }

            function renderTeacherChat(text, container) {
                // --- תיקון: עדכון האורך שנצפה, כדי שהנקודה לא תחזור ---
                if (text) lastChatLength = text.length;
                document.getElementById('t-chat-badge').style.display = 'none'; // כיבוי הנקודה
                // -----------------------------------------------------

                const isAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 50;

                container.innerHTML = "";
                if (!text) {
                    container.innerHTML = "<div style='text-align:center; color:#555; margin-top:20px;'>אין הודעות עדיין</div>";
                    return;
                }

                const lines = text.split('\n');
                lines.forEach(line => {
                    if (!line.trim()) return;

                    const div = document.createElement('div');
                    div.style.maxWidth = "80%";
                    div.style.padding = "8px 12px";
                    div.style.borderRadius = "12px";
                    div.style.fontSize = "14px";
                    div.style.wordWrap = "break-word";
                    div.style.lineHeight = "1.4";

                    if (line.includes("[תלמיד")) {
                        div.style.alignSelf = "flex-start";
                        div.style.background = "#2b5c3a";
                        div.style.color = "#e3e3e3";
                        div.style.borderBottomRightRadius = "2px";
                        div.innerText = line.replace(/\[.*?\]:\s*/, "");
                    } else {
                        div.style.alignSelf = "flex-end";
                        div.style.background = "#3c3e40";
                        div.style.color = "#fff";
                        div.style.borderBottomLeftRadius = "2px";
                        div.innerText = line.replace(/^\[מורה.*?\]:\s*/, "");
                    }

                    container.appendChild(div);
                });

                if (isAtBottom) container.scrollTop = container.scrollHeight;
            }

            async function sendTeacherMsg() {
                const input = document.getElementById('t-chat-input');
                const msg = input.value.trim();
                if (!msg) return;

                // 1. ניקוי השדה והוספה מידית למסך (כדי שיראה מהיר)
                input.value = "";
                const container = document.getElementById('t-chat-msgs');
                const div = document.createElement('div');

                // עיצוב ההודעה הזמנית
                div.style.maxWidth = "80%";
                div.style.padding = "8px 12px";
                div.style.borderRadius = "12px";
                div.style.fontSize = "14px";
                div.style.wordWrap = "break-word";
                div.style.lineHeight = "1.4";
                div.style.alignSelf = "flex-start";
                div.style.background = "#2b5c3a";
                div.style.color = "#e3e3e3";
                div.style.borderBottomRightRadius = "2px";
                div.innerText = msg;

                container.appendChild(div);
                container.scrollTop = container.scrollHeight;

                // 2. עצירת הריענון האוטומטי! (כדי שלא ימחק את ההודעה לפני שהיא נשמרת)
                if (tChatInterval) clearInterval(tChatInterval);

                try {
                    // 3. שליחה לשרת
                    const url = `${CONTROL_SCRIPT_URL}?action=teacherChat&user=${encodeURIComponent(globalStudentName)}&msg=${encodeURIComponent(msg)}`;
                    await fetch(url);

                    // 4. המתנה  של 2.5 שניות לגוגל שיטס לפני שמחדשים את הריענון
                    setTimeout(() => {
                        fetchTeacherChat(); //  המידע המעודכן

                        // הפעלה מחדש של השעון האוטומטי
                        tChatInterval = setInterval(() => {
                            if (document.getElementById('teacher-chat-overlay').style.display === 'none') {
                                clearInterval(tChatInterval);
                            } else {
                                fetchTeacherChat();
                            }
                        }, 5000);
                    }, 2500);

                } catch (e) {
                    div.style.color = "#ff4d4d";
                    div.innerText += " (שגיאה בשליחה)";
                }
            }

            // --- בדיקה ברקע להודעות חדשות (הנקודה האדומה) ---
            let lastChatLength = 0; // שומר את אורך הצ'אט האחרון שראינו

            // בדיקה ראשונית + הפעלה מחזורית כל 15 שניות
            setTimeout(backgroundChatCheck, 3000);
            setInterval(backgroundChatCheck, 15000);

            async function backgroundChatCheck() {
                // אם החלון פתוח - לא עושים כלום
                if (document.getElementById('teacher-chat-overlay').style.display !== 'none') return;

                if (!globalStudentName) return;

                try {
                    const url = `${CONTROL_SCRIPT_URL}?action=teacherChat&user=${encodeURIComponent(globalStudentName)}&t=${new Date().getTime()}`;
                    const res = await fetch(url);
                    const data = await res.json();

                    if (data.chat) {
                        const currentText = String(data.chat).trim();

                        // האם יש משהו חדש שעדיין לא ראינו?
                        if (currentText.length > lastChatLength) {

                            const lines = currentText.split('\n');
                            const lastLine = lines[lines.length - 1];

                            // אם ההודעה האחרונה היא מהמורה -> תדליק נורה
                            if (!lastLine.includes("[תלמיד")) {
                                document.getElementById('t-chat-badge').style.display = 'block';
                            } else {
                                // אם ההודעה האחרונה היא שלי (התלמיד) -> תעדכן שראיתי אותה (כדי לא לבדוק שוב)
                                lastChatLength = currentText.length;
                            }
                        }
                    }
                } catch (e) { }
            }

            document.getElementById('t-chat-input').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') sendTeacherMsg();
            });


            function toggleMessageBubble() {
                const bubble = document.getElementById('msg-bubble');
                const content = document.getElementById('msg-bubble-content');
                const btn = document.getElementById('msg-btn'); // הפניה לכפתור

                // בדיקה: אם פתוח -> סגור אותו ובטל צבע
                if (bubble.style.display === 'block') {
                    bubble.style.display = 'none';
                    btn.classList.remove('active');
                    return;
                }

                // --- מכאן: לוגיקה של פתיחה ---

                // 1. טעינת התוכן (כמו שהיה במקור)
                content.innerHTML = "";
                let rawMsg = window.lastSystemMessage || "";
                rawMsg = rawMsg.trim();

                if (rawMsg.startsWith("http")) {
                    bubble.style.width = "500px";
                    let src = rawMsg;
                    if (src.includes("docs.google.com") && !src.includes("/preview")) {
                        src = src.replace(/\/edit.*/, "/preview").replace(/\/view.*/, "/preview");
                    }
                    const iframe = document.createElement('iframe');
                    iframe.src = src;
                    iframe.style.width = "100%";
                    iframe.style.height = "400px";
                    iframe.style.border = "none";
                    iframe.style.backgroundColor = "#fff";
                    content.appendChild(iframe);
                } else {
                    bubble.style.width = "300px";
                    content.innerText = rawMsg || "📭 אין הודעות חדשות.";
                }

                // 2. הצגת הבועה וצביעת הכפתור
                bubble.style.display = 'block';
                btn.classList.add('active');

                // (הוסר החלק שסוגר בלחיצה בחוץ)
            }

            function showUrlModal(url) {
                const overlay = document.getElementById('universal-modal');
                const modalBox = overlay.querySelector('.modal-box');
                const title = document.getElementById('u-modal-title');
                const textContainer = document.getElementById('u-modal-text');
                const btnOk = document.getElementById('u-modal-ok');
                const btnCancel = document.getElementById('u-modal-cancel');
                const input = document.getElementById('u-modal-input');

                overlay.style.display = 'flex';
                input.style.display = 'none';

                // שינוי 1: הסתרת כפתור ה"סגור" התחתון (המשתמש ביקש רק X)
                btnOk.style.display = 'none';
                btnCancel.style.display = 'none'; // נשאר מוסתר ויזואלית

                textContainer.innerHTML = "";
                modalBox.style.width = "90%";
                modalBox.style.maxWidth = "600px";

                title.innerText = "📢 הודעת כיתה";

                let src = url;
                if (src.includes("docs.google.com") && !src.includes("/preview")) {
                    src = src.replace(/\/edit.*/, "/preview").replace(/\/view.*/, "/preview");
                }

                // Wrapper
                const wrapper = document.createElement('div');
                wrapper.style.position = "relative";
                wrapper.style.width = "100%";
                wrapper.style.height = "60vh";
                wrapper.style.overflow = "hidden";
                wrapper.style.border = "1px solid #444";
                wrapper.style.borderRadius = "8px";

                // iframe
                const iframe = document.createElement('iframe');
                iframe.id = 'modal-iframe-content';
                iframe.src = src;
                iframe.style.width = "100%";
                iframe.style.height = "100%";
                iframe.style.border = "none";
                iframe.style.background = "#fff";

                wrapper.appendChild(iframe);
                textContainer.appendChild(wrapper);

                // שינוי 2: הגדרת פעולת הסגירה
                const closeModal = () => {
                    overlay.style.display = 'none';
                    textContainer.innerHTML = "";
                    modalBox.style.width = "";
                    modalBox.style.maxWidth = "";
                };

                // שינוי 3: חיבור ה-X (שלוחץ על btnCancel) לפונקציית הסגירה
                btnCancel.onclick = closeModal;
            }

            window.openTeacherChat = openTeacherChat;
            window.sendTeacherMsg = sendTeacherMsg;
            window.toggleMessageBubble = toggleMessageBubble;
            window.showUrlModal = showUrlModal;

            // --- וידוא טעינה ראשונית תקינה ---
            var checkReady = setInterval(function () {
                if (typeof window.switchViewMode === 'function') {
                    clearInterval(checkReady);
                    var aiPanel = document.getElementById('ai-panel');
                    if (aiPanel && !aiPanel.classList.contains('collapsed')) {
                        aiPanel.classList.add('collapsed');
                        if (window.editorInstance) window.editorInstance.layout();
                    }
                    window.switchViewMode('lesson');
                }
            }, 100);



            // --- מערכת פורום גלובלית ---
            let forumRefreshInterval = null;

            window.openForum = async function () {
                if (!globalStudentName) { Sys.alert("יש להתחבר כדי להיכנס לפורום."); return; }
                document.getElementById('forum-overlay').style.display = 'flex';
                window.loadForumThreads();
            };

            window.closeForum = function () {
                document.getElementById('forum-overlay').style.display = 'none';
                if (forumRefreshInterval) clearInterval(forumRefreshInterval);
            };

            window.loadForumThreads = async function () {
                const container = document.getElementById('forum-content');
                container.innerHTML = '<div style="text-align:center; padding:50px; color:#888;"><i class="fa-solid fa-circle-notch fa-spin"></i> טוען פורום...</div>';
                try {
                    const res = await fetch(`${CONTROL_SCRIPT_URL}?action=getForum&t=${new Date().getTime()}`);
                    const data = await res.json();
                    container.innerHTML = "";
                    if (!data.threads || data.threads.length === 0) {
                        container.innerHTML = "<div style='text-align:center; color:#555; margin-top:50px;'>הפורום ריק.</div>";
                        return;
                    }
                    data.threads.reverse().forEach(thread => {
                        const info = parseThreadContent(thread.content);

                        // יצירת תקציר: לוקח את התיאור, חותך אותו ומוסיף שלוש נקודות
                        const preview = info.desc.length > 60 ? info.desc.substring(0, 60) + "..." : info.desc;

                        const card = document.createElement('div');
                        card.style.cssText = "background:#131314; padding:15px; border-radius:10px; cursor:pointer; border:1px solid #2d2e30; transition:0.2s; margin-bottom:10px; text-align:right;";
                        card.onmouseover = () => card.style.borderColor = "#a8c7fa";
                        card.onmouseout = () => card.style.borderColor = "#2d2e30";

                        card.innerHTML = `
                                    <div style="display:flex; justify-content:space-between; align-items:flex-start; direction:rtl;">
                                        <div style="font-weight:bold; color:#a8c7fa; font-size:16px;">${info.title}</div>
                                        <span style="background:#2d2e30; color:#aaa; font-size:11px; padding:2px 8px; border-radius:10px;">${thread.commentCount} תגובות</span>
                                    </div>
                                    <div style="color:#aaa; font-size:13px; margin-top:8px; direction:rtl; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        ${preview}
                                    </div>
                                    <div style="color:#666; font-size:11px; margin-top:5px; direction:rtl;">${info.user} • ${info.time}</div>
                                `;
                        card.onclick = () => window.openThread(thread, info);
                        container.appendChild(card);
                    });
                } catch (e) { container.innerHTML = "<div style='color:red; text-align:center;'>שגיאה בטעינת הפורום.</div>"; }
            };

            window.openNewThreadModal = function () {
                document.getElementById('thread-title').value = "";
                document.getElementById('thread-desc').value = "";
                document.getElementById('new-thread-overlay').style.display = 'flex';
            };

            window.submitNewThread = async function () {
                const title = document.getElementById('thread-title').value.trim();
                const desc = document.getElementById('thread-desc').value.trim();
                if (!title || !desc) { Sys.alert("יש למלא כותרת ותיאור"); return; }
                document.getElementById('new-thread-overlay').style.display = 'none';
                try {
                    const url = `${CONTROL_SCRIPT_URL}?action=createThread&user=${encodeURIComponent(globalStudentName)}&title=${encodeURIComponent(title)}&desc=${encodeURIComponent(desc)}`;
                    await fetch(url);
                    window.loadForumThreads();
                } catch (e) { Sys.alert("שגיאה בפרסום"); }
            };

            window.openThread = function (thread, info) {
                if (forumRefreshInterval) clearInterval(forumRefreshInterval);

                const container = document.getElementById('forum-content');
                // הסרת פריטי גלילה כפולים ושיפור המרווחים
                container.innerHTML = `
                            <div style="text-align:right; direction:rtl; padding-bottom: 20px;">
                                <button onclick="window.loadForumThreads()" style="color:#a8c7fa; background:none; border:none; cursor:pointer; padding:0; font-size:14px; margin-bottom: 15px;">
                                    <i class="fa-solid fa-arrow-right"></i> חזרה לפורום
                                </button>

                                <div style="background: #1e1f20; border: 1px solid #333; border-radius: 12px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                                    <h2 style="color:#fff; margin:0 0 10px 0; font-size: 22px;">${info.title}</h2>
                                    <p style="color:#e3e3e3; white-space:pre-wrap; font-size:16px; line-height: 1.6; margin: 0;">${info.desc}</p>
                                    <div style="font-size:12px; color:#888; margin-top:15px; border-top: 1px solid #333; padding-top: 10px;">
                                        <i class="fa-solid fa-user-edit"></i> פורסם ע"י: <b>${info.user}</b> | <i class="fa-solid fa-clock"></i> ${info.time}
                                    </div>
                                </div>

                                <div style="font-weight: bold; color: #a8c7fa; margin-bottom: 15px; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                    <i class="fa-solid fa-comments"></i> תגובות:
                                </div>

                                <div id="thread-comments-area" style="display:flex; flex-direction:column; gap:15px; margin-bottom: 30px;">
                                </div>

                                <div style="background:#131314; border: 1px solid #a8c7fa; padding:15px; border-radius:12px; direction:rtl; box-shadow: 0 -4px 10px rgba(0,0,0,0.3);">
                                    <textarea id="new-comment-input" placeholder="הצטרפו לשיחה... (Enter לירידת שורה)"
                                        style="width:100%; background:transparent; border:none; color:white; outline:none; text-align:right; resize:none; font-family:inherit; min-height:80px; font-size: 15px;"></textarea>
                                    <div style="display:flex; justify-content:flex-start; margin-top: 10px;">
                                        <button id="send-comment-btn" onclick="window.submitComment(${thread.row})"
                                            style="background:#a8c7fa; color:#000; padding:8px 25px; border-radius:20px; border:none; cursor:pointer; font-weight:bold; transition: 0.2s;">
                                            <i class="fa-solid fa-paper-plane"></i> שלח תגובה
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;

                const renderComments = (comments) => {
                    const commentsDiv = document.getElementById('thread-comments-area');
                    commentsDiv.innerHTML = "";
                    if (comments && comments.length > 0) {
                        comments.forEach(c => {
                            const div = document.createElement('div');
                            // עיצוב תגובה כ"בועה" נקייה
                            div.style.cssText = `
                                        background: #1a1a1b;
                                        color: #d1d1d1;
                                        padding: 15px 20px;
                                        border-radius: 15px 0 15px 15px;
                                        font-size: 15px;
                                        line-height: 1.5;
                                        border-right: 4px solid #a8c7fa;
                                        direction: rtl;
                                        white-space: pre-wrap;
                                        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                                    `;
                            div.innerText = c;
                            commentsDiv.appendChild(div);
                        });
                    } else {
                        commentsDiv.innerHTML = "<div style='color:#555; text-align:center; padding: 20px;'>טרם נכתבו תגובות. היה הראשון להגיב!</div>";
                    }
                };

                renderComments(thread.comments);

                forumRefreshInterval = setInterval(async () => {
                    try {
                        const res = await fetch(`${CONTROL_SCRIPT_URL}?action=getForum&t=${new Date().getTime()}`);
                        const data = await res.json();
                        const updated = data.threads.find(t => t.row === thread.row);
                        if (updated && updated.commentCount !== thread.commentCount) {
                            thread = updated;
                            renderComments(updated.comments);
                        }
                    } catch (e) { }
                }, 15000);
            };

            window.submitComment = async function (row) {
                const input = document.getElementById('new-comment-input');
                const btn = event.target; // תופס את הכפתור שנלחץ
                const text = input.value.trim();

                if (!text || btn.disabled) return; // מונע שליחה אם ריק או אם כבר נשלח

                // 1. נעילת ממשק המשתמש (מניעת הצפה)
                btn.disabled = true;
                btn.innerText = "שולח...";
                btn.style.opacity = "0.5";
                input.disabled = true;

                try {
                    const url = `${CONTROL_SCRIPT_URL}?action=addComment&user=${encodeURIComponent(globalStudentName)}&row=${row}&comment=${encodeURIComponent(text)}`;
                    await fetch(url);

                    // 2. טעינה מחדש של הנתונים
                    const res = await fetch(`${CONTROL_SCRIPT_URL}?action=getForum&t=${new Date().getTime()}`);
                    const data = await res.json();
                    const updated = data.threads.find(t => t.row === row);

                    // 3. הצגת האשכול המעודכן (זה גם מנקה את השדה ומשחרר את הכפתור כי ה-HTML נבנה מחדש)
                    window.openThread(updated, parseThreadContent(updated.content));
                } catch (e) {
                    Sys.alert("שגיאה בשליחה");
                    // שחרור במקרה של שגיאה כדי שיוכל לנסות שוב
                    btn.disabled = false;
                    btn.innerText = "שלח";
                    btn.style.opacity = "1";
                    input.disabled = false;
                }
            };

            function parseThreadContent(raw) {
                const parts = raw.split("||");
                const result = { title: "ללא כותרת", desc: "", user: "", time: "" };
                parts.forEach(p => {
                    if (p.startsWith("TITLE:")) result.title = p.replace("TITLE:", "");
                    if (p.startsWith("DESC:")) result.desc = p.replace("DESC:", "");
                    if (p.startsWith("USER:")) result.user = p.replace("USER:", "");
                    if (p.startsWith("TIME:")) result.time = p.replace("TIME:", "");
                });
                return result;
            }
        })();

        function toggleGlobalFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => { console.log(err); });
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        document.addEventListener('fullscreenchange', () => {
            const btn = document.getElementById('fs-global-btn');
            const icon = btn.querySelector('i');
            if (document.fullscreenElement) {
                icon.classList.replace('fa-expand', 'fa-compress');
                btn.title = "צא ממסך מלא";
            } else {
                icon.classList.replace('fa-compress', 'fa-expand');
                btn.title = "מסך מלא (F11)";
            }
        });

        function enforceKioskMode() {
            if (!document.body.classList.contains('kiosk-mode')) {
                document.getElementById('kiosk-overlay').style.display = 'none';
                return;
            }
            if (!document.fullscreenElement) {
                document.getElementById('kiosk-overlay').style.display = 'flex';
            } else {
                document.getElementById('kiosk-overlay').style.display = 'none';
            }
        }

        document.addEventListener('keydown', function (e) {
            if (!document.body.classList.contains('kiosk-mode')) return;
            if (e.key === 'F11' || e.key === 'Escape' || e.key === 'Alt') {
                e.preventDefault(); e.stopPropagation(); toggleGlobalFullScreen();
            }
        });
        document.addEventListener('fullscreenchange', enforceKioskMode);

        // --- לוגיקה לזום בשיעור ---
        let lessonScale = 1.0;
        function zoomLesson(change) {
            lessonScale += change;
            lessonScale = Math.min(Math.max(0.5, lessonScale), 2.0);
            const container = document.getElementById('lesson-content');
            if (!container || container.children.length === 0) return;
            const targetElement = container.children[0];
            targetElement.style.transform = `scale(${lessonScale})`;
            targetElement.style.transformOrigin = 'top right';
            if (lessonScale !== 1) {
                targetElement.style.width = `${100 / lessonScale}%`;
                targetElement.style.height = `${100 / lessonScale}%`;
            } else {
                targetElement.style.width = "100%";
                targetElement.style.height = "100%";
            }
        }

        // משתנים לשליטה בתצוגת ה-Visualizer
        let vizScale = 1.0;
        let isVizDark = true;

        window.zoomViz = function (change) {
            vizScale += change;
            vizScale = Math.min(Math.max(0.5, vizScale), 2.0);
            const iframe = document.getElementById('visualizer-iframe');
            if (!iframe) return;

            iframe.style.transform = `scale(${vizScale})`;
            iframe.style.transformOrigin = 'top right';
            iframe.style.width = vizScale === 1 ? "100%" : `${100 / vizScale}%`;
            iframe.style.height = vizScale === 1 ? "100%" : `${100 / vizScale}%`;
        };

        window.toggleVizFullScreen = function () {
            const box = document.querySelector('#visualizer-overlay .modal-box');
            const icon = document.getElementById('fs-viz-icon');
            const isFull = box.style.width === '100vw';

            box.style.width = isFull ? '90%' : '100vw';
            box.style.height = isFull ? '90%' : '100vh';
            box.style.maxWidth = isFull ? '1200px' : 'none';
            box.style.borderRadius = isFull ? '12px' : '0';

            icon.classList.toggle('fa-expand', isFull);
            icon.classList.toggle('fa-compress', !isFull);
        };

        window.toggleVizContrast = function () {
            isVizDark = !isVizDark;
            const iframe = document.getElementById('visualizer-iframe');
            if (!iframe) return;
            iframe.style.filter = isVizDark ? "invert(1) hue-rotate(180deg)" : "none";
        };


        let isLessonDark = true;
        function toggleLessonFullScreen() {
            const panel = document.getElementById('lesson-panel');
            const icon = document.getElementById('fs-lesson-icon');
            panel.classList.toggle('lesson-fullscreen');
            if (panel.classList.contains('lesson-fullscreen')) {
                icon.classList.replace('fa-expand', 'fa-compress');
            } else {
                icon.classList.replace('fa-compress', 'fa-expand');
            }
        }

        function toggleLessonContrast() {
            isLessonDark = !isLessonDark;
            const container = document.getElementById('lesson-content');
            if (!container || container.children.length === 0) return;
            const content = container.children[0];
            if (content.tagName === 'IFRAME') {
                content.style.filter = isLessonDark ? "invert(1) hue-rotate(180deg)" : "none";
            } else {
                if (isLessonDark) {
                    content.style.backgroundColor = "";
                    content.style.color = "#e3e3e3";
                } else {
                    content.style.backgroundColor = "#ffffff";
                    content.style.color = "#000000";
                }
            }
        }

        let modalScale = 1.0;
        let isModalDark = false;

        function zoomModal(delta) {
            modalScale += delta;
            modalScale = Math.min(Math.max(0.5, modalScale), 2.0);
            const iframe = document.getElementById('modal-iframe-content');
            if (!iframe) return;
            iframe.style.transform = `scale(${modalScale})`;
            iframe.style.transformOrigin = "top right";
            if (modalScale !== 1) {
                iframe.style.width = `${100 / modalScale}%`;
                iframe.style.height = `${100 / modalScale}%`;
            } else {
                iframe.style.width = "100%";
                iframe.style.height = "100%";
            }
        }

        function toggleModalContrast() {
            isModalDark = !isModalDark;
            const iframe = document.getElementById('modal-iframe-content');
            if (!iframe) return;
            iframe.style.filter = isModalDark ? "invert(1) hue-rotate(180deg)" : "none";
        }

        let isEditorDark = true;
        function toggleEditorFullScreen() {
            // שינוי: במקום להשפיע רק על העורך, משפיעים על כל גוף ה-IDE שמכיל לשוניות + עורך
            const ideBody = document.querySelector('.ide-body');
            const icon = document.getElementById('fs-editor-icon');

            ideBody.classList.toggle('editor-fullscreen');

            if (ideBody.classList.contains('editor-fullscreen')) {
                icon.classList.replace('fa-expand', 'fa-compress');
            } else {
                icon.classList.replace('fa-compress', 'fa-expand');
            }

            // עדכון הפריסה של Monaco Editor
            if (window.editorInstance) {
                setTimeout(() => window.editorInstance.layout(), 10);
            }
        }

        function toggleEditorTheme() {
            isEditorDark = !isEditorDark;
            if (isEditorDark) {
                monaco.editor.setTheme('java-custom');
            } else {
                monaco.editor.setTheme('vs');
            }
        }

        let isCalcMinimized = false;

        function toggleCalculator() {
            const overlay = document.getElementById('calc-overlay');
            const win = document.getElementById('calc-window');

            // בדיקה אם המחשבון פתוח (בין אם הוא במרכז ובין אם הוא בפינה)
            const isOpen = (overlay.style.display === 'flex') || (isCalcMinimized && overlay.style.visibility === 'hidden');

            if (isOpen) {
                // --- סגירה מוחלטת ---
                overlay.style.display = 'none';
                overlay.style.visibility = 'visible';

                // אם המחשבון היה בפינה בזמן הסגירה, נאפס את ההגדרות שלו 
                // כדי שבפעם הבאה הוא ייפתח שוב במרכז כרגיל
                if (isCalcMinimized) {
                    isCalcMinimized = false;

                    // החזרת עיצוב החלון למצב מרכזי (בזיכרון, כי ה-overlay מוסתר)
                    win.style.position = "relative";
                    win.style.bottom = "auto";
                    win.style.right = "auto";
                    win.style.width = "500px";
                    win.style.height = "600px";
                    win.style.margin = "auto";
                    win.style.zIndex = "";

                    // החזרת האייקון למצב "מינוס"
                    const minBtn = document.getElementById('calc-min-btn');
                    if (minBtn) {
                        minBtn.classList.replace('fa-expand', 'fa-minus');
                        minBtn.title = "מזער לפינה";
                    }
                }
            } else {
                // --- פתיחה במרכז ---
                overlay.style.display = 'flex';
                overlay.style.visibility = 'visible';
                injectBotLiToAllModals(); // מוסיף את הראש של בוטלי
            }
        }

        function minimizeCalculator() {
            const overlay = document.getElementById('calc-overlay');
            const win = document.getElementById('calc-window');
            const minBtn = document.getElementById('calc-min-btn');

            if (!isCalcMinimized) {
                isCalcMinimized = true;

                // הופך את הרקע לבלתי נראה לחלוטין לקליקים
                overlay.style.visibility = "hidden";

                // המחשבון עצמו חוזר להיות נראה ופעיל
                win.style.visibility = "visible";
                win.style.position = "fixed";
                win.style.bottom = "20px";
                win.style.right = "20px";
                win.style.left = "auto";
                win.style.width = "400px"; // הגדלתי מעט כדי שהכפתורים לא יתכווצו
                win.style.height = "500px";
                win.style.zIndex = "30000";
                win.style.margin = "0";
                win.style.boxShadow = "0 10px 40px rgba(0,0,0,0.8)";

                win.querySelectorAll('.botli-head').forEach(el => el.remove());
                minBtn.classList.replace('fa-minus', 'fa-expand');
            } else {
                isCalcMinimized = false;
                overlay.style.visibility = "visible";
                overlay.style.display = "flex";

                win.style.position = "relative";
                win.style.bottom = "auto";
                win.style.right = "auto";
                win.style.width = "500px";
                win.style.height = "600px";
                win.style.margin = "auto";

                injectBotLiToAllModals();
                minBtn.classList.replace('fa-expand', 'fa-minus');
            }
        }


        window.toggleCalculator = toggleCalculator;
        window.minimizeCalculator = minimizeCalculator;

        // פונקציה לפתיחת/סגירת דף הטיוטה
        function toggleScratchpad() {
            const overlay = document.getElementById('scratchpad-overlay');
            const area = document.getElementById('scratchpad-area');

            if (overlay.style.display === 'flex') {
                overlay.style.display = 'none';
            } else {
                overlay.style.display = 'flex';
                // ממקד את הסמן בתוך הטיוטה ברגע שהיא נפתחת
                setTimeout(() => area.focus(), 100);
            }
        }

        let scratchpadFontSize = 16;
        let isScratchpadDark = true;
        let pCanvas, pCtx, pDrawing = false, pTool = 'pen', pStartX, pStartY, pLineWidth = 3, pClipboard = [];
        let eraserPos = null; // מיקום המחק לצורך הצגת העיגול
		let objects = []; // רשימת כל הקווים והצורות
        let undoStack = [];
        let redoStack = [];
        let selectedObjects = [];
        let isMoving = false;
        let selectBox = null;
        let currentObject = null;

        // פונקציית עזר לחישוב מרחק בין נקודה לקו (עבור המחק)
        function getDistance(x, y, x1, y1, x2, y2) {
            const A = x - x1; const B = y - y1; const C = x2 - x1; const D = y2 - y1;
            const dot = A * C + B * D; const len_sq = C * C + D * D;
            let param = -1;
            if (len_sq != 0) param = dot / len_sq;
            let xx, yy;
            if (param < 0) { xx = x1; yy = y1; }
            else if (param > 1) { xx = x2; yy = y2; }
            else { xx = x1 + param * C; yy = y1 + param * D; }
            return Math.sqrt(Math.pow(x - xx, 2) + Math.pow(y - yy, 2));
        }
		
		// פונקציית עזר למחיקה נגררת עם רדיוס
function eraseAt(x, y) {
            const radius = 10;
            let changed = false;
            for (let i = objects.length - 1; i >= 0; i--) {
                const obj = objects[i];
                let hit = false;
                
                if (obj.type === 'pen') {
                    // בדיקת נקודות בודדות (מטפל בנקודות קטנות)
                    for (let p of obj.points) {
                        const dist = Math.sqrt(Math.pow(x - p.x, 2) + Math.pow(y - p.y, 2));
                        if (dist < radius) { hit = true; break; }
                    }
                    // בדיקת קטעי קווים (למחיקה רגילה)
                    if (!hit) {
                        for (let j = 0; j < obj.points.length - 1; j++) {
                            if (getDistance(x, y, obj.points[j].x, obj.points[j].y, obj.points[j + 1].x, obj.points[j + 1].y) < radius) { hit = true; break; }
                        }
                    }
                } else if (obj.type === 'line') {
                    if (getDistance(x, y, obj.startX, obj.startY, obj.endX, obj.endY) < radius) hit = true;
                } else if (obj.type === 'rect') {
                    const d1 = getDistance(x, y, obj.startX, obj.startY, obj.endX, obj.startY);
                    const d2 = getDistance(x, y, obj.endX, obj.startY, obj.endX, obj.endY);
                    const d3 = getDistance(x, y, obj.endX, obj.endY, obj.startX, obj.endY);
                    const d4 = getDistance(x, y, obj.startX, obj.endY, obj.startX, obj.startY);
                    if (d1 < radius || d2 < radius || d3 < radius || d4 < radius) hit = true;
                } else if (obj.type === 'circle') {
                    const r = Math.sqrt(Math.pow(obj.startX - obj.endX, 2) + Math.pow(obj.startY - obj.endY, 2));
                    const dist = Math.sqrt(Math.pow(x - obj.startX, 2) + Math.pow(y - obj.startY, 2));
                    if (Math.abs(dist - r) < radius) hit = true;
                }

                if (hit) { objects.splice(i, 1); changed = true; }
            }
            if (changed) render();
        }
        // ציור מחדש של כל הקנבס מהאובייקטים
        function render() {
            pCtx.clearRect(0, 0, pCanvas.width, pCanvas.height);
            objects.forEach(obj => {
                pCtx.beginPath();
                pCtx.strokeStyle = selectedObjects.includes(obj) ? "#a8c7fa" : obj.color;
                pCtx.lineWidth = selectedObjects.includes(obj) ? obj.width + 2 : obj.width;
                if (obj.type === 'pen') {
                    pCtx.moveTo(obj.points[0].x, obj.points[0].y);
                    obj.points.forEach(p => pCtx.lineTo(p.x, p.y));
                } else if (obj.type === 'line') {
                    pCtx.moveTo(obj.startX, obj.startY); pCtx.lineTo(obj.endX, obj.endY);
                } else if (obj.type === 'rect') {
                    pCtx.strokeRect(obj.startX, obj.startY, obj.endX - obj.startX, obj.endY - obj.startY);
                } else if (obj.type === 'circle') {
                    let r = Math.sqrt(Math.pow(obj.startX - obj.endX, 2) + Math.pow(obj.startY - obj.endY, 2));
                    pCtx.arc(obj.startX, obj.startY, r, 0, 2 * Math.PI);
                }
                pCtx.stroke();
            });
            if (pTool === 'select' && selectBox && !isMoving) {
                pCtx.setLineDash([5, 5]);
                pCtx.strokeStyle = "#a8c7fa";
                pCtx.strokeRect(selectBox.startX, selectBox.startY, selectBox.endX - selectBox.startX, selectBox.endY - selectBox.startY);
                pCtx.setLineDash([]);
            }
	if (pTool === 'eraser' && pDrawing) {
        pCtx.beginPath();
        pCtx.arc(pStartX, pStartY, 10, 0, Math.PI * 2);
        pCtx.strokeStyle = '#a8c7fa';
        pCtx.setLineDash([5, 5]);
        pCtx.stroke();
        pCtx.setLineDash([]); // מחזיר לקו רגיל כדי לא להרוס צורות אחרות
    }
        }

        function saveState() {
            if (undoStack.length > 30) undoStack.shift();
            undoStack.push(JSON.stringify(objects));
            redoStack = [];
        }

        window.undo = function () {
            if (undoStack.length > 0) {
                redoStack.push(JSON.stringify(objects));
                objects = JSON.parse(undoStack.pop());
                render();
            }
        };

        window.redo = function () {
            if (redoStack.length > 0) {
                undoStack.push(JSON.stringify(objects));
                objects = JSON.parse(redoStack.pop());
                render();
            }
        };

        window.initPainter = function () {
            pCanvas = document.getElementById('paint-canvas');
            pCtx = pCanvas.getContext('2d');
            document.getElementById('painter-ctx-menu').style.display = 'none';
            const container = document.getElementById('canvas-container');

            // התאמת גודל הקנבס
            if (pCanvas.width !== container.clientWidth || pCanvas.height !== container.clientHeight) {
                const temp = pCtx.getImageData(0, 0, pCanvas.width, pCanvas.height);
                pCanvas.width = container.clientWidth; pCanvas.height = container.clientHeight;
                pCtx.putImageData(temp, 0, 0);
                pCtx.lineCap = 'round'; pCtx.lineJoin = 'round';
            }

            // שימוש ב-Pointer Events לתמיכה במגע, עט ועכבר
            pCanvas.onpointerdown = (e) => {

                const x = e.offsetX, y = e.offsetY;
                if (pTool === 'select') {
                    // אם יש בחירה ולחצנו בתוכה - תתחיל להזיז
                    if (selectedObjects.length > 0 && isPointInSelection(x, y)) {
                        isMoving = true;
                        pStartX = x;
                        pStartY = y;
                        saveState();
                        return; // עוצר כאן כדי לא להתחיל מלבן בחירה חדש
                    } else {
                        // לחיצה מחוץ לבחירה - מאפסת בחירה ומתחילה מלבן חדש
                        isMoving = false;
                        selectedObjects = [];
                        selectBox = { startX: x, startY: y, endX: x, endY: y };
                    }
                    render();
                    return;
                }


                // מונע מהדפדפן לבצע פעולות ברירת מחדל כמו גלילה
                if (e.pointerType === 'touch') pCanvas.releasePointerCapture(e.pointerId);

if (pTool === 'eraser') {
                    saveState();
                    pDrawing = true; // מסמן שאנחנו "מציירים" (מוחקים) כרגע
                    pStartX = x; pStartY = y; // שומר מיקום נוכחי
                    eraseAt(x, y);
                    render(); // מצייר מחדש כדי להציג את העיגול
                    return;
                }

                saveState();
                pDrawing = true;
                currentObject = {
                    type: pTool, color: document.getElementById('paint-color').value,
                    width: pLineWidth, points: [{ x, y }], startX: x, startY: y
                };
            };

            pCanvas.onpointermove = (e) => {
                const x = e.offsetX, y = e.offsetY;
                if (pTool === 'select') {
                    if (isMoving) { moveSelected(x - pStartX, y - pStartY); pStartX = x; pStartY = y; }
                    else if (selectBox) { selectBox.endX = x; selectBox.endY = y; }
                    render(); return;
                }
if (pDrawing && pTool === 'eraser') {
                    pStartX = x; pStartY = y; // מעדכן את המיקום לעיגול
                    eraseAt(x, y);
                    render();
                    return;
                }

                if (!pDrawing || !currentObject) return;

                currentObject.endX = x; currentObject.endY = y;
                if (pTool === 'pen') currentObject.points.push({ x, y });
                render();

                // תצוגה מקדימה בזמן אמת
                pCtx.beginPath();
                pCtx.strokeStyle = currentObject.color; pCtx.lineWidth = currentObject.width;
                if (pTool === 'pen') {
                    pCtx.moveTo(currentObject.points[0].x, currentObject.points[0].y);
                    currentObject.points.forEach(p => pCtx.lineTo(p.x, p.y));
                } else if (pTool === 'line') {
                    pCtx.moveTo(currentObject.startX, currentObject.startY); pCtx.lineTo(x, y);
                } else if (pTool === 'rect') {
                    pCtx.strokeRect(currentObject.startX, currentObject.startY, x - currentObject.startX, y - currentObject.startY);
                } else if (pTool === 'circle') {
                    let r = Math.sqrt(Math.pow(currentObject.startX - x, 2) + Math.pow(currentObject.startY - y, 2));
                    pCtx.arc(currentObject.startX, currentObject.startY, r, 0, 2 * Math.PI);
                }
                pCtx.stroke();
            };

pCanvas.onpointerup = () => {
                if (pTool === 'select' && !isMoving && selectBox) {
                    selectedObjects = objects.filter(obj => isObjectInBox(obj, selectBox));
                    selectBox = null;
                }
                isMoving = false;

                if (pDrawing && currentObject) { 
                    objects.push(currentObject); 
                }
                
                pDrawing = false; 
                currentObject = null;
                
                // --- השורה החשובה: ---
                render(); 
                // ---------------------
            };

            pCanvas.onpointerleave = pCanvas.onpointerup; // עוצר ציור אם האצבע/עט יצאו מגבולות הקנבס


            pCanvas.oncontextmenu = (e) => {
                e.preventDefault();
                if (selectedObjects.length > 0 && isPointInSelection(e.offsetX, e.offsetY)) {
                    const menu = document.getElementById('painter-ctx-menu');
                    menu.style.display = 'block';
                    menu.style.left = e.pageX + 'px';
                    menu.style.top = e.pageY + 'px';
                }
            };

        };

        window.copyPainter = function () {
            if (selectedObjects.length === 0) return;
            pClipboard = JSON.parse(JSON.stringify(selectedObjects));
            document.getElementById('painter-ctx-menu').style.display = 'none';
        };

        window.cutPainter = function () {
            if (selectedObjects.length === 0) return;
            saveState();
            pClipboard = JSON.parse(JSON.stringify(selectedObjects));
            objects = objects.filter(obj => !selectedObjects.includes(obj));
            selectedObjects = [];
            document.getElementById('painter-ctx-menu').style.display = 'none';
            render();
        };

        window.pastePainter = function () {
            if (pClipboard.length === 0) return;
            saveState();
            const pasted = JSON.parse(JSON.stringify(pClipboard));
            let minX = Infinity, minY = Infinity;
            pasted.forEach(obj => {
                if (obj.type === 'pen') {
                    obj.points.forEach(p => { minX = Math.min(minX, p.x); minY = Math.min(minY, p.y); });
                } else {
                    minX = Math.min(minX, obj.startX, obj.endX);
                    minY = Math.min(minY, obj.startY, obj.endY);
                }
            });
            const offsetX = (pCanvas.width - 150) - minX;
            const offsetY = 50 - minY;
            pasted.forEach(obj => {
                if (obj.type === 'pen') {
                    obj.points.forEach(p => { p.x += offsetX; p.y += offsetY; });
                } else {
                    obj.startX += offsetX; obj.startY += offsetY;
                    obj.endX += offsetX; obj.endY += offsetY;
                }
                objects.push(obj);
            });
            selectedObjects = pasted;
            render();
        };

        window.setTool = function (t) {
            pTool = t;
            document.querySelectorAll('#painter-tools .zoom-btn').forEach(b => b.classList.remove('active-tool'));
            document.getElementById('tool-' + t)?.classList.add('active-tool');
        };

        window.clearCanvas = function () {
            saveState(); objects = []; render();
        };

        window.addEventListener('keydown', (e) => {
            if (document.getElementById('painter-area').style.display === 'flex') {
                if (e.ctrlKey && e.key.toLowerCase() === 'z') { e.preventDefault(); window.undo(); }
                if (e.ctrlKey && e.key.toLowerCase() === 'y') { e.preventDefault(); window.redo(); }
            }
        });

        // פונקציות Scratchpad קיימות
        function zoomScratchpad(change) {
            const isPainter = document.getElementById('painter-area').style.display === 'flex';
            if (!isPainter) {
                scratchpadFontSize = Math.max(10, Math.min(40, scratchpadFontSize + change));
                document.getElementById('scratchpad-area').style.fontSize = scratchpadFontSize + 'px';
            }
        }

        function toggleScratchpadContrast() {
            isScratchpadDark = !isScratchpadDark;
            const isPainter = document.getElementById('painter-area').style.display === 'flex';
            const area = document.getElementById('scratchpad-area');
            const container = document.getElementById('canvas-container');
            if (isPainter) { container.style.filter = isScratchpadDark ? "none" : "invert(1) hue-rotate(180deg)"; }
            else {
                area.style.background = isScratchpadDark ? "#1e1f20" : "#ffffff";
                area.style.color = isScratchpadDark ? "#e3e3e3" : "#000000";
            }
        }

        function isObjectInBox(obj, box) {
            const xMin = Math.min(box.startX, box.endX), xMax = Math.max(box.startX, box.endX);
            const yMin = Math.min(box.startY, box.endY), yMax = Math.max(box.startY, box.endY);
            const check = (x, y) => x >= xMin && x <= xMax && y >= yMin && y <= yMax;
            if (obj.type === 'pen') return obj.points.every(p => check(p.x, p.y));
            return check(obj.startX, obj.startY) && check(obj.endX, obj.endY);
        }
        function moveSelected(dx, dy) {
            selectedObjects.forEach(obj => {
                if (obj.type === 'pen') {
                    obj.points.forEach(p => {
                        p.x += dx;
                        p.y += dy;
                    });
                } else {
                    obj.startX += dx; obj.startY += dy;
                    obj.endX += dx; obj.endY += dy;
                }
            });
        }
        function isPointInSelection(x, y) {
            if (selectedObjects.length === 0) return false;

            // מציאת הגבולות המקסימליים של כל האובייקטים שנבחרו
            let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;

            selectedObjects.forEach(obj => {
                if (obj.type === 'pen') {
                    obj.points.forEach(p => {
                        minX = Math.min(minX, p.x); maxX = Math.max(maxX, p.x);
                        minY = Math.min(minY, p.y); maxY = Math.max(maxY, p.y);
                    });
                } else {
                    const left = Math.min(obj.startX, obj.endX), right = Math.max(obj.startX, obj.endX);
                    const top = Math.min(obj.startY, obj.endY), bottom = Math.max(obj.startY, obj.endY);
                    minX = Math.min(minX, left); maxX = Math.max(maxX, right);
                    minY = Math.min(minY, top); maxY = Math.max(maxY, bottom);
                }
            });

            // הוספת "מרווח ביטחון" של 10 פיקסלים סביב הבחירה כדי שיהיה קל לתפוס
            return x >= minX - 10 && x <= maxX + 10 && y >= minY - 10 && y <= maxY + 10;
        }

        window.toggleScratchMode = function (isPainter) {
            const area = document.getElementById('scratchpad-area');
            const painter = document.getElementById('painter-area');
            const btnText = document.getElementById('scratch-text-btn');
            const btnPaint = document.getElementById('scratch-paint-btn');
            const zoomPlus = document.getElementById('scratch-zoom-plus');
            const zoomMinus = document.getElementById('scratch-zoom-minus');
            if (isPainter) {
                area.style.display = 'none'; painter.style.display = 'flex';
                btnPaint.classList.add('active'); btnText.classList.remove('active');
                if (zoomPlus) zoomPlus.style.display = 'none';
                if (zoomMinus) zoomMinus.style.display = 'none';
                setTimeout(() => window.initPainter(), 50);
            } else {
                area.style.display = 'block'; painter.style.display = 'none';
                btnText.classList.add('active'); btnPaint.classList.remove('active');
                if (zoomPlus) zoomPlus.style.display = 'flex';
                if (zoomMinus) zoomMinus.style.display = 'flex';
            }
        };

        function toggleScratchpadFullScreen() {
            const box = document.getElementById('scratchpad-box');
            const icon = document.getElementById('fs-scratch-icon');
            if (box.style.width === '100vw') {
                box.style.width = '800px'; box.style.height = '600px'; box.style.borderRadius = '12px';
                icon.classList.replace('fa-compress', 'fa-expand');
            } else {
                box.style.width = '100vw'; box.style.height = '100vh'; box.style.borderRadius = '0';
                icon.classList.replace('fa-expand', 'fa-compress');
            }
            setTimeout(() => window.initPainter(), 100);
        }

        window.zoomScratchpad = zoomScratchpad;
        window.toggleScratchpadContrast = toggleScratchpadContrast;
        window.toggleScratchpadFullScreen = toggleScratchpadFullScreen;
        window.toggleScratchpad = toggleScratchpad;

        window.addEventListener('keydown', (e) => {
            // בודק אם אזור הצייר מוצג כרגע
            if (document.getElementById('painter-area').style.display === 'flex') {
                if (e.ctrlKey && e.key.toLowerCase() === 'z') {
                    e.preventDefault();
                    window.undo();
                }
                if (e.ctrlKey && e.key.toLowerCase() === 'y') {
                    e.preventDefault();
                    window.redo();
                }
            }
        });

        let jitsiApi = null;

        // פונקציה למזעור החלון (הסתרת הוידאו מבלי לנתק)
        function minimizeVideo() {
            document.getElementById('video-overlay').style.display = 'none';
            // שימו לב: אנחנו לא עושים dispose, השיחה ממשיכה ברקע!
        }

        function toggleVideoClass() {
            const overlay = document.getElementById('video-overlay');
            const container = document.getElementById('jitsi-container');

            const displayName = (typeof globalStudentName !== 'undefined' && globalStudentName) ? globalStudentName : "אורח";

            // בדיקה: האם השיחה כבר פעילה?
            if (jitsiApi) {
                // אם השיחה פעילה, נבדוק אם החלון מוצג או מוסתר
                if (overlay.style.display === 'none') {
                    // מצב 1: השיחה ממוזערת -> אנחנו משחזרים אותה (Restore)
                    overlay.style.display = 'flex';
                } else {
                    // מצב 2: החלון פתוח -> אנחנו סוגרים ומנתקים (כמו כפתור X)
                    overlay.style.display = 'none';
                    jitsiApi.dispose();
                    jitsiApi = null;
                }
            } else {
                // מצב 3: אין שיחה -> מתחילים שיחה חדשה
                overlay.style.display = 'flex';

                // --- התיקון: שימוש בשרת קהילתי ללא מגבלת 5 דקות ---
                const domain = 'meet.guifi.net';
                // --------------------------------------------------

                const options = {
                    roomName: 'BotLi_Classroom_Main_Sabag', // הוספתי סיומת ייחודית כדי שלא ייכנסו זרים
                    width: '100%',
                    height: '100%',
                    parentNode: container,
                    userInfo: {
                        displayName: displayName
                    },
                    configOverwrite: {
                        startWithAudioMuted: true,
                        startWithVideoMuted: true,
                        prejoinPageEnabled: false // דילוג על מסך "הצטרף"
                    },
                    interfaceConfigOverwrite: {
                        SHOW_JITSI_WATERMARK: false,
                        TOOLBAR_BUTTONS: [
                            'microphone', 'camera', 'closedcaptions', 'desktop', 'fullscreen',
                            'fodeviceselection', 'hangup', 'profile', 'chat', 'recording',
                            'livestreaming', 'etherpad', 'sharedvideo', 'settings', 'raisehand',
                            'videoquality', 'filmstrip', 'feedback', 'stats', 'shortcuts',
                            'tileview', 'videobackgroundblur', 'download', 'help', 'mute-everyone'
                        ]
                    }
                };

                jitsiApi = new JitsiMeetExternalAPI(domain, options);

                // האזנה לאירוע ניתוק (כדי לסגור את החלון כשהתלמיד לוחץ על הטלפון האדום)
                jitsiApi.addEventListeners({
                    videoConferenceLeft: function () {
                        overlay.style.display = 'none';
                        jitsiApi.dispose();
                        jitsiApi = null;
                    }
                });
            }
        }



    </script>


    <div id="kiosk-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 999999; justify-content: center; align-items: center; flex-direction: column; text-align: center;">
        <h1 style="color: red; font-size: 30px;">⚠️ יצאת ממסך מלא!</h1>
        <p style="color: white; font-size: 18px;">המורה הגדיר מצב נעילה. עליך לחזור למסך מלא כדי להמשיך.</p>
        <button onclick="toggleGlobalFullScreen()" style="padding: 15px 30px; font-size: 20px; background: #a8c7fa; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">חזור למסך מלא מייד</button>
    </div>


    <div id="calc-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 26500; justify-content: center; align-items: center; backdrop-filter: blur(2px);">
        <div id="calc-window" class="modal-box" style="width: 500px; height: 600px; display: flex; flex-direction: column; padding: 0; overflow: visible; border-radius: 12px; position: relative; transition: all 0.3s ease;">

            <div style="background: #131314; padding: 10px 15px; border-bottom: 1px solid #2d2e30; display: flex; justify-content: space-between; align-items: center; direction: rtl; flex-shrink: 0;">
                <span style="font-weight: bold; color: #a8c7fa;"><i class="fa-solid fa-calculator"></i> מחשבון מדעי</span>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <i id="calc-min-btn" class="fa-solid fa-minus" onclick="minimizeCalculator()" title="מזער לפינה" style="cursor: pointer; color: #888; font-size: 18px;"></i>
                    <i class="fa-solid fa-xmark" onclick="toggleCalculator()" title="סגור" style="cursor: pointer; color: #888; font-size: 20px;"></i>
                </div>
            </div>

            <div id="calc-body" style="flex: 1; background: #fff; overflow: hidden; border-radius: 0 0 12px 12px; position: relative;">
                <iframe src="https://www.desmos.com/scientific?embed"
                        style="width: 100%; height: 100%; border: none; filter: invert(1) hue-rotate(180deg);"></iframe>
            </div>
        </div>
    </div>

    <div id="scratchpad-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 26000; justify-content: center; align-items: center; backdrop-filter: blur(2px);">
        <div class="modal-box" id="scratchpad-box" style="width: 800px; height: 600px; display: flex; flex-direction: column; padding: 0; overflow: hidden; border-radius: 12px; position: relative;">
            <div style="background: #131314; padding: 10px 15px; border-bottom: 1px solid #2d2e30; display: flex; justify-content: space-between; align-items: center; direction: rtl; flex-shrink: 0;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="font-weight: bold; color: #a8c7fa;"><i class="fa-solid fa-pen-to-square"></i> דף טיוטה</span>

                    <div class="mode-toggle-container" style="height: 30px; border-radius: 15px;">
                        <button id="scratch-text-btn" class="mode-btn active" onclick="window.toggleScratchMode(false)" style="padding: 0 12px; font-size: 11px;">
                            <i class="fa-solid fa-font"></i> טקסט
                        </button>
                        <button id="scratch-paint-btn" class="mode-btn" onclick="window.toggleScratchMode(true)" style="padding: 0 12px; font-size: 11px;">
                            <i class="fa-solid fa-palette"></i> צייר
                        </button>
                    </div>
                </div>
                <i class="fa-solid fa-xmark" onclick="toggleScratchpad()" style="cursor: pointer; color: #888; font-size: 20px;"></i>
            </div>

            <div style="flex: 1; position: relative; display: flex; flex-direction: column; overflow: hidden; background: #1e1f20; border-radius: 0 0 12px 12px;">
                <textarea id="scratchpad-area" spellcheck="false" placeholder="כתוב כאן הערות חופשיות או קוד... שים לב! הטיוטה לא נשמרת לאחר התנתקות מהאתר" style="flex: 1; background: #1e1f20; color: #e3e3e3; border: none; padding: 20px; font-family: 'Consolas', monospace; font-size: 16px; resize: none; outline: none; line-height: 1.5; box-sizing: border-box; direction: ltr; text-align: left; border-radius: 0 0 12px 12px;"></textarea>

                <div id="painter-area" style="display: none; flex-direction: column; height: 100%; position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 5;">
                    <div id="painter-tools" style="display: flex; gap: 10px; padding: 8px; background: #131314; border-bottom: 1px solid #2d2e30; direction: rtl; align-items: center;">
                        <input type="color" id="paint-color" value="#a8c7fa" style="width:25px; height:25px; border:none; background:none; cursor:pointer;">
                        <button class="zoom-btn" onclick="window.setTool('pen')" id="tool-pen" title="עיפרון"><i class="fa-solid fa-pen"></i></button>
                        <button class="zoom-btn" onclick="window.setTool('line')" id="tool-line" title="קו ישר"><i class="fa-solid fa-minus"></i></button>
                        <button class="zoom-btn" onclick="window.setTool('rect')" id="tool-rect" title="מלבן"><i class="fa-solid fa-vector-square"></i></button>
                        <button class="zoom-btn" onclick="window.setTool('circle')" id="tool-circle" title="עיגול"><i class="fa-regular fa-circle"></i></button>
                        <button class="zoom-btn" onclick="window.setTool('select')" id="tool-select" title="בחירה והזזה"><i class="fa-solid fa-scissors"></i></button>
                        <button class="zoom-btn" onclick="window.pastePainter()" id="tool-paste" title="הדבק (Paste)"><i class="fa-solid fa-paste"></i></button>
                        <button class="zoom-btn" onclick="window.redo()" title="שחזור (Ctrl+Y)"><i class="fa-solid fa-rotate-right"></i></button>
                        <button class="zoom-btn" onclick="window.undo()" title="ביטול (Ctrl+Z)"><i class="fa-solid fa-rotate-left"></i></button>
                        <button class="zoom-btn" onclick="window.setTool('eraser')" id="tool-eraser" title="מחק קו שלם"><i class="fa-solid fa-eraser"></i></button>
                        <div style="width:1px; height:20px; background:#444; margin:0 5px;"></div>
                        <button class="zoom-btn" onclick="window.clearCanvas()" title="נקה הכל" style="color:#ff4d4d;"><i class="fa-solid fa-trash-can"></i></button>
                    </div>

                    <div id="canvas-container" style="flex: 1; cursor: crosshair; overflow: hidden; position: relative; border-radius: 0 0 12px 12px;">

                        <canvas id="paint-canvas" style="display: block;"></canvas>
                    </div>
                </div>
            </div>

            <div style="position: absolute; bottom: 20px; right: 25px; display: flex; gap: 8px; z-index: 1000;">
                <button class="zoom-btn" onclick="toggleScratchpadFullScreen()" title="מסך מלא"><i id="fs-scratch-icon" class="fa-solid fa-expand"></i></button>
                <button id="scratch-zoom-plus" class="zoom-btn" onclick="zoomScratchpad(1)" title="הגדל"><i class="fa-solid fa-plus"></i></button>
                <button id="scratch-zoom-minus" class="zoom-btn" onclick="zoomScratchpad(-1)" title="הקטן"><i class="fa-solid fa-minus"></i></button>
                <button class="zoom-btn" onclick="toggleScratchpadContrast()" title="מצב יום/לילה"><i class="fa-solid fa-circle-half-stroke"></i></button>
            </div>

        </div>
    </div>

    <div id="video-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 28000; justify-content: center; align-items: center; backdrop-filter: blur(2px);">
        <div class="modal-box" style="width: 90%; height: 90%; max-width: 1200px; display: flex; flex-direction: column; padding: 0; overflow: visible; background: #1e1f20; border: 1px solid #444746; border-radius: 4px;">

            <div style="background: #131314; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2d2e30;">
                <span style="color: #a8c7fa; font-weight: bold;"><i class="fa-solid fa-video"></i> כיתה וירטואלית</span>

                <div style="display: flex; gap: 15px;">
                    <i class="fa-solid fa-minus" onclick="minimizeVideo()" title="מזער (השיחה תמשיך ברקע)" style="cursor: pointer; color: #ccc; font-size: 20px;"></i>
                    <i class="fa-solid fa-xmark" onclick="toggleVideoClass()" title="נתק וסגור" style="cursor: pointer; color: #fff; font-size: 20px;"></i>
                </div>
            </div>

            <div id="jitsi-container" style="flex: 1; width: 100%; height: 100%; background: #000; border-radius: 0 0 12px 12px;"></div>
        </div>
    </div>

    <div id="visualizer-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 30000; justify-content: center; align-items: center; backdrop-filter: blur(2px);">
        <div class="modal-box" style="width: 90%; height: 90%; max-width: 1200px; display: flex; flex-direction: column; padding: 0; overflow: hidden; background: #1e1f20; border: 1px solid #444746; position: relative;">

            <div class="viz-controls" style="position: absolute; bottom: 20px; right: 25px; z-index: 20; display: flex; gap: 8px;">
                <button class="zoom-btn" onclick="toggleVizFullScreen()" title="מסך מלא"><i id="fs-viz-icon" class="fa-solid fa-expand"></i></button>
                <button class="zoom-btn" onclick="zoomViz(0.1)" title="הגדל תצוגה"><i class="fa-solid fa-plus"></i></button>
                <button class="zoom-btn" onclick="zoomViz(-0.1)" title="הקטן תצוגה"><i class="fa-solid fa-minus"></i></button>

                <button class="zoom-btn" onclick="toggleVizContrast()" title="מצב יום/לילה"><i class="fa-solid fa-circle-half-stroke"></i></button>
            </div>

            <div style="background: #131314; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #2d2e30; direction: rtl; z-index: 10;">
                <span style="color: #a8c7fa; font-weight: bold;">
                    <i class="fa-solid fa-eye"></i> הדמיית זיכרון
                </span>
                <i class="fa-solid fa-xmark" onclick="document.getElementById('visualizer-overlay').style.display='none'" style="cursor: pointer; color: #c4c7c5; font-size: 20px;"></i>
            </div>

            <div id="visualizer-loader" style="position: absolute; top: 50px; left: 0; width: 100%; height: calc(100% - 50px); background: #1e1f20; z-index: 5; display: flex; justify-content: center; align-items: center; flex-direction: column; border-radius: 0 0 12px 12px;">
                <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 40px; color: #a8c7fa; margin-bottom: 15px;"></i>
                <span style="font-size: 14px; color: #aaa;">מעבד נתונים...</span>
            </div>

            <div id="viz-container" style="flex: 1; display:flex; position: relative; z-index: 1;"></div>
        </div>
    </div>

</body>
</html>
