<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>BotLi</title>
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MCA4MCI+PHJlY3QgeD0iMTgiIHk9IjE4IiB3aWR0aD0iNDQiIGhlaWdodD0iNDAiIHJ4PSI4IiBmaWxsPSIjZmY0ZDRkIi8+PHJlY3QgeD0iOCIgeT0iMzAiIHdpZHRoPSI4IiBoZWlnaHQ9IjE2IiByeD0iMiIgZmlsbD0iI2ZmNGQ0ZCIvPjxyZWN0IHg9IjY0IiB5PSIzMCIgd2lkdGg9IjgiIGhlaWdodD0iMTYiIHJ4PSIyIiBmaWxsPSIjZmY0ZDRkIi8+PHJlY3QgeD0iMzYiIHk9IjgiIHdpZHRoPSI4IiBoZWlnaHQ9IjEwIiByeD0iMiIgZmlsbD0iI2ZmNGQ0ZCIvPjxjaXJjbGUgY3g9IjMwIiBjeT0iMzUiIHI9IjUiIGZpbGw9IiMxMzEzMTQiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjM1IiByPSI1IiBmaWxsPSIjMTMxMzE0Ii8+PHJlY3QgeD0iMjgiIHk9IjQ4IiB3aWR0aD0iNiIgaGVpZ2h0PSIzIiBmaWxsPSIjMTMxMzE0Ii8+PHJlY3QgeD0iMzciIHk9IjQ4IiB3aWR0aD0iNiIgaGVpZ2h0PSIzIiBmaWxsPSIjMTMxMzE0Ii8+PHJlY3QgeD0iNDYiIHk9IjQ4IiB3aWR0aD0iNiIgaGVpZ2h0PSIzIiBmaWxsPSIjMTMxMzE0Ii8+PC9zdmc+" type="image/svg+xml">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        * {
            scrollbar-width: thin;
            scrollbar-color: #444746 #131314;
            box-sizing: border-box;
        }

        /* 砖 爪 拽住拽 (on) - 住转专转 驻转专 住  */
        body.kiosk-mode #fs-global-btn {
            display: none !important;
        }

        /* 住转专转 驻转专 住专 砖 驻驻 ( 转 注  驻驻,  住) */
        ::-webkit-scrollbar {
            display: none;
        }
        /* 爪 拽住拽 驻注 专爪 住转专  */

        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #131314;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            color: #e3e3e3;
            display: flex;
            flex-direction: row;
            user-select: none;
        }

        #ai-panel {
            width: 350px;
            min-width: 360px;
            height: 100%;
            background-color: #131314;
            display: flex;
            flex-direction: column;
            position: relative;
            flex-shrink: 0;
            transition: opacity 0.3s;
        }

            #ai-panel.disabled-mode {
                opacity: 0.3;
                pointer-events: none;
                filter: grayscale(100%);
            }

        .resizer-vertical {
            width: 6px;
            height: 100%;
            background: #131314;
            cursor: col-resize;
            border-left: 1px solid #2d2e30;
            border-right: 1px solid #2d2e30;
        }

        #ide-panel {
            flex: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: #131314;
            min-width: 300px;
        }

        header, .ai-header {
            height: 50px;
            background-color: #131314;
            border-bottom: 1px solid #2d2e30;
            display: flex;
            align-items: center;
            padding: 0 15px;
            flex-shrink: 0;
        }

        header {
            justify-content: space-between;
            direction: ltr;
        }

        .ai-header {
            color: #e3e3e3;
            font-size: 16px;
            font-weight: 500;
            gap: 12px;
            justify-content: space-between;
        }

        .exam-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            color: #ff4d4d;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 14px;
            margin-right: 20px;
        }

        .exam-dot {
            width: 12px;
            height: 12px;
            background-color: red;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(255, 0, 0, 0.8);
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0.3;
            }
        }

        button {
            border: none;
            cursor: pointer;
            font-weight: 500;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
            font-family: inherit;
            color: #c4c7c5;
            background: none;
        }

            button:hover {
                background-color: #333537;
                color: white;
            }

        #runBtn {
            background-color: #2da042;
            color: white;
            padding: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

            #runBtn:disabled {
                background-color: #2d2e30;
                color: #555;
                cursor: not-allowed;
            }

        #examBtn {
            border: 1px solid #444746;
            padding: 5px 15px;
        }

            #examBtn.active {
                background-color: rgba(255, 0, 0, 0.2);
                color: #ff8080;
                border-color: #ff4d4d;
            }

        #submitBtn {
            border: 1px solid #444746;
            color: #c4c7c5;
            padding: 5px 15px;
            margin-right: 10px;
        }

        #learningBtn {
            border: 1px solid #444746;
            padding: 5px 15px;
            margin-left: 10px;
        }

            #learningBtn.active-mode {
                background-color: #a8c7fa;
                color: #000;
                border-color: #a8c7fa;
            }

        .lesson-category {
            background: #131314;
            padding: 12px 15px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 1px solid #2d2e30;
            user-select: none;
            display: flex;
            justify-content: space-between;
            direction: rtl;
            text-align: right;
        }

            .lesson-category:hover {
                background: #2d2e30;
            }

        .lesson-items {
            display: none;
            background: #1e1f20;
            direction: rtl;
        }

            .lesson-items.open {
                display: block;
            }

        .lesson-item {
            padding: 10px 20px;
            font-size: 14px;
            color: #c4c7c5;
            cursor: pointer;
            border-right: 3px solid transparent;
            transition: 0.2s;
            text-align: right;
        }

            .lesson-item:hover {
                background: #2d2e30;
                color: white;
            }

            .lesson-item.active-lesson {
                background: #26292b;
                color: #a8c7fa;
                border-right: 3px solid #a8c7fa;
            }

        .ide-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #tabs-container {
            height: 40px;
            background-color: #131314;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #2d2e30;
            overflow-x: auto;
            overflow-y: hidden;
            direction: ltr;
            padding-left: 10px;
            gap: 5px;
        }

        .tab {
            padding: 0 15px;
            height: 30px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #c4c7c5;
            background-color: transparent;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 13px;
            user-select: none;
            white-space: nowrap;
            transition: 0.2s;
        }

            .tab:hover {
                background-color: #2d2e30;
            }

            .tab.active {
                background-color: #1e1f20;
                color: #a8c7fa;
                border-bottom: 2px solid #a8c7fa;
            }

        #editor-wrapper {
            height: 60%;
            min-height: 100px;
            position: relative;
            direction: ltr;
            text-align: left;
            background-color: #1e1f20;
        }

        #editor {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .editor-controls {
            position: absolute;
            bottom: 20px;
            right: 25px;
            z-index: 20;
            display: flex;
            gap: 8px;
        }

        .zoom-btn {
            background: #2d2e30;
            border: 1px solid #444746;
            color: #e3e3e3;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .resizer-horizontal {
            height: 6px;
            width: 100%;
            background: #131314;
            cursor: row-resize;
            border-top: 1px solid #2d2e30;
            border-bottom: 1px solid #2d2e30;
        }

        #bottom-panel {
            flex: 1;
            display: flex;
            flex-direction: row;
            background-color: #131314;
            min-height: 50px;
            overflow: hidden;
        }

        #input-container {
            width: 30%;
            min-width: 100px;
            background-color: #131314;
            display: flex;
            flex-direction: column;
        }

        #output-wrapper {
            flex: 1;
            min-width: 100px;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            height: 30px;
            background: #131314;
            color: #8e918f;
            padding: 0 15px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            direction: ltr;
            border-bottom: 1px solid #2d2e30;
        }

        #stdin-input {
            flex: 1;
            background-color: #131314;
            color: #e3e3e3;
            border: none;
            padding: 10px 15px;
            resize: none;
            font-family: 'Consolas', monospace;
            outline: none;
            font-size: 14px;
            direction: ltr;
            text-align: left;
            user-select: text;
        }

        #output-container {
            flex: 1;
            background-color: #131314;
            padding: 10px 15px;
            direction: ltr;
            overflow: auto;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            color: #e3e3e3;
            white-space: pre-wrap;
            user-select: text;
        }

        #chat-window {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: #131314;
            user-select: text;
        }

        .chat-msg {
            max-width: 90%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.6;
            word-wrap: break-word;
            position: relative;
        }

        .msg-user {
            align-self: flex-start;
            background-color: #282a2c;
            color: #e3e3e3;
            border-bottom-right-radius: 4px;
        }

        .msg-ai {
            background-color: transparent;
            border-left: 2px solid #2d2e30;
            padding-left: 12px;
        }

        .msg-system {
            align-self: center;
            background-color: transparent;
            color: #8e918f;
            font-size: 12px;
            border-radius: 4px;
            padding: 5px 15px;
            text-align: center;
            width: 90%;
            border: 1px dashed #444746;
        }

        .clickable-link {
            color: #a8c7fa;
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
        }

            .clickable-link:hover {
                text-decoration: underline;
            }

        .code-block {
            position: relative;
            direction: ltr !important;
            text-align: left !important;
            background: #2b2b2b;
            padding: 15px;
            padding-top: 35px;
            margin: 10px 0;
            border-radius: 12px;
            border: 1px solid #444;
            font-family: 'Consolas', monospace;
            white-space: pre-wrap;
            color: #a8c7fa;
            display: block;
            font-size: 13px;
            unicode-bidi: isolate;
        }

        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #444;
            border: 1px solid #555;
            color: #ccc;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            padding: 4px 10px;
            font-family: sans-serif;
            transition: 0.2s;
            z-index: 10;
        }

            .copy-btn:hover {
                background: #555;
                color: white;
            }

        .chat-input-area {
            padding: 15px;
            background: #131314;
            border-top: 1px solid #2d2e30;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #ai-input {
            flex: 1;
            background: #1e1f20;
            border: 1px solid #444746;
            color: #e3e3e3;
            padding: 12px 15px;
            border-radius: 24px;
            outline: none;
            text-align: right;
            direction: rtl;
            transition: 0.2s;
            user-select: text;
        }

            #ai-input:focus {
                border-color: #a8c7fa;
            }

        #send-ai-btn, #exercises-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            justify-content: center;
        }

        #send-ai-btn {
            background: #a8c7fa;
            color: #000;
        }

        #exercises-btn {
            background: #2d2e30;
            color: #c4c7c5;
        }

            #exercises-btn:hover {
                background: #444746;
                color: white;
            }

        .typing-indicator {
            display: none;
            padding: 10px 20px;
            background: transparent;
            color: #a8c7fa;
            font-size: 12px;
            font-weight: 600;
            text-align: right;
            border-top: 1px solid #444;
            border-bottom: 1px solid #1e1e1e;
            align-items: center;
            gap: 10px;
        }

        .error-text {
            color: #f2b8b5;
        }

        .output-text {
            color: #e3e3e3;
        }

        .success-msg {
            color: #6dd58c;
        }

        #context-menu {
            display: none;
            position: absolute;
            z-index: 2000;
            background: #252526;
            border: 1px solid #454545;
            width: 150px;
            border-radius: 8px;
            padding: 5px 0;
            direction: ltr;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .ctx-item {
            padding: 8px 15px;
            color: #ccc;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .ctx-item:hover {
                background-color: #004a77;
                color: white;
            }

        #modal-overlay, #rename-overlay, #exercise-overlay, #submit-overlay, #login-overlay, #universal-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 21000;
            justify-content: center;
            align-items: center;
            direction: ltr;
            backdrop-filter: blur(4px);
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            direction: ltr;
        }

        .btn-create-small {
            background: #a8c7fa;
            color: #000;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            font-size: 13px;
            height: 42px;
        }

            .btn-create-small:hover {
                opacity: 0.9;
            }

        .btn-login-centered {
            width: 150px;
            margin: 20px auto 0 auto;
            display: block;
        }

        .modal-box {
            background: #1e1f20;
            padding: 25px;
            border-radius: 12px;
            width: 320px;
            border: 1px solid #444746;
            color: #e0e0e0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-align: right;
            direction: rtl;
            position: relative;
            overflow: visible !important;
            margin-top: 40px;
        }

            .modal-box h3 {
                margin-top: 0;
                color: #fff;
                font-weight: 500;
                text-align: center;
            }

        .modal-input, .modal-select {
            width: 100%;
            padding: 10px;
            margin: 15px 0;
            background: #131314;
            border: 1px solid #444746;
            color: white;
            box-sizing: border-box;
            border-radius: 6px;
            outline: none;
            text-align: right;
            direction: rtl;
        }

            .modal-input:focus, .modal-select:focus {
                border-color: #a8c7fa;
            }

            .modal-input:disabled {
                background: #2d2e30;
                color: #8e918f;
                border-color: #444;
                cursor: not-allowed;
            }

        .modal-btns {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .modal-btn-ok {
            background: #a8c7fa;
            color: #000;
            border-radius: 18px;
            padding: 8px 24px;
            border: none;
            font-weight: 500;
            cursor: pointer;
        }

        .modal-btn-cancel {
            background: transparent;
            color: #a8c7fa;
            border-radius: 18px;
            padding: 8px 24px;
            border: 1px solid #444746;
            cursor: pointer;
        }

        #login-overlay {
            display: flex;
            z-index: 22000;
        }

        #exam-lockdown-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 19000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: red;
            text-align: center;
        }

            #exam-lockdown-overlay h1 {
                font-size: 40px;
                margin-bottom: 20px;
            }

            #exam-lockdown-overlay p {
                font-size: 20px;
                color: #ccc;
            }

        #remote-lock-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000;
            z-index: 21000; /* --- 砖: 注 -20000 -21000  住转 转 驻转专 砖注专 --- */
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .exercise-list-box {
            background: #1e1f20;
            border-radius: 12px;
            width: 500px;
            max-height: 80%;
            border: 1px solid #444746;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            direction: rtl;
            text-align: right;
        }

        .ex-header {
            padding: 20px;
            background: #131314;
            color: white;
            font-weight: bold;
            border-bottom: 1px solid #2d2e30;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ex-content {
            overflow-y: auto;
            padding: 10px;
            flex: 1;
        }

        details {
            margin-bottom: 10px;
            border: 1px solid #2d2e30;
            border-radius: 8px;
            overflow: hidden;
            background: #131314;
        }

        summary {
            background: #1e1f20;
            color: #e3e3e3;
            padding: 12px;
            cursor: pointer;
            font-weight: 500;
            user-select: none;
            outline: none;
        }

            summary:hover {
                background: #2d2e30;
            }

        .ex-item {
            background: #131314;
            padding: 12px 15px;
            border-bottom: 1px solid #2d2e30;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

            .ex-item:last-child {
                border-bottom: none;
            }

            .ex-item:hover {
                background: #1e1f20;
                border-right: 3px solid #a8c7fa;
                border-left: none;
            }

        .ex-title {
            font-size: 14px;
            color: #e3e3e3;
            font-weight: 500;
        }

        .ex-desc {
            font-size: 12px;
            color: #8e918f;
        }

        .ai-tools {
            display: flex;
            gap: 10px;
        }

        .project-list-container {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #444746;
            background: #131314;
            border-radius: 6px;
            margin-top: 5px;
        }

        .project-item {
            padding: 12px 15px;
            border-bottom: 1px solid #2d2e30;
            cursor: pointer;
            color: #e3e3e3;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
        }

            .project-item:hover {
                background-color: #2d2e30;
                color: #a8c7fa;
            }

            .project-item i {
                margin-left: 10px;
                color: #a8c7fa;
            }

        .status-loading {
            color: #a8c7fa;
        }

        .status-success {
            color: #6dd58c;
            font-weight: bold;
        }

        .status-error {
            color: #f2b8b5;
        }

        .delete-btn {
            color: #ff4d4d;
            padding: 5px 10px;
            border-radius: 4px;
            transition: 0.2s;
        }

            .delete-btn:hover {
                background: rgba(255, 77, 77, 0.2);
            }

        #universal-modal {
            z-index: 99999 !important;
        }

        header button:disabled {
            color: #444746 !important;
            cursor: not-allowed;
            opacity: 0.5;
        }

            header button:disabled:hover {
                background-color: transparent !important;
                color: #444746 !important;
            }

        #stdin-input:disabled {
            background-color: #0b0b0c;
            color: #555;
            cursor: not-allowed;
        }

        .list-busy {
            pointer-events: none;
            opacity: 0.4;
            filter: grayscale(1);
            transition: 0.3s;
        }

        .lib-link {
            color: #8ab4f8;
            font-size: 13px;
            cursor: pointer;
            text-decoration: none;
            margin-top: 10px;
            display: inline-block;
            transition: 0.2s;
        }

            .lib-link:hover {
                text-decoration: underline;
                color: #aecbfa;
            }

        #lesson-body {
            line-height: 1.6;
            font-size: 16px;
            color: #e0e0e0;
            max-width: 900px;
            white-space: normal;
        }

            #lesson-body h1 {
                color: #a8c7fa;
                font-size: 2.2em;
                margin: 0 0 10px 0;
                line-height: 1.2;
                font-weight: 700;
            }

            #lesson-body h3 {
                font-size: 1.3em;
                color: #e3e3e3;
                border-bottom: 1px solid #2d2e30;
                padding-bottom: 5px;
                margin-top: 15px;
                margin-bottom: 5px;
                font-weight: 600;
            }

            #lesson-body hr {
                border: 0;
                border-top: 1px solid #444;
                margin: 15px 0;
            }

            #lesson-body p {
                margin: 5px 0;
            }

            #lesson-body strong {
                color: #fff;
                font-weight: 700;
            }

            #lesson-body ul {
                padding-right: 25px;
                margin: 10px 0;
            }

            #lesson-body li {
                margin-bottom: 6px;
            }

            #lesson-body code {
                display: inline;
                vertical-align: baseline;
                background-color: rgba(168, 199, 250, 0.1);
                border: 1px solid rgba(168, 199, 250, 0.2);
                color: #a8c7fa;
                padding: 0 4px;
                border-radius: 4px;
                font-family: 'Consolas', 'Courier New', monospace;
                font-size: 0.95em;
                direction: ltr;
                unicode-bidi: isolate;
            }

        /* 注爪 注专 iframe 砖  拽住 注 爪  */
        .doc-frame {
            width: 100%;
            height: 800px;
            min-height: 60vh;
            border: none;
            border-radius: 8px;
            /* 专拽: 驻 爪注 (专住) 砖专 注   */
            filter: invert(1) hue-rotate(180deg);
            /* 注   注 */
            background: #fff;
        }
        /* --- 注爪 爪 抓 砖  --- */
        #ai-panel.collapsed {
            width: 60px !important; /* 专 驻住 爪专 */
            min-width: 60px !important;
            transition: width 0.3s ease;
        }

            /* 住转专转 转 专 砖驻 抓 */
            #ai-panel.collapsed .ai-header .ai-tools,
            #ai-panel.collapsed .ai-header span, /* 住转专 转   */
            #ai-panel.collapsed #chat-window,
            #ai-panel.collapsed .chat-input-area,
            #ai-panel.collapsed .typing-indicator {
                display: none !important;
            }

            /* 转转 专 爪 抓 */
            #ai-panel.collapsed .ai-header {
                justify-content: center;
                padding: 0;
            }

                #ai-panel.collapsed .ai-header i {
                    font-size: 24px;
                    cursor: pointer;
                    padding: 10px;
                }

        /* 转驻专 爪 抓 (住驻专) */
        .collapsed-tools {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
        }

        #ai-panel.collapsed .collapsed-tools {
            display: flex;
        }

        .side-icon-btn {
            background: none;
            border: none;
            color: #c4c7c5;
            font-size: 20px;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: 0.2s;
        }

            .side-icon-btn:hover {
                background: #2d2e30;
                color: #a8c7fa;
            }
        /* --- 转拽 住专 驻转专 专 --- */

        /* 专 砖转驻转  驻转专 专 拽转   */
        #submitBtn, #examBtn, #fs-global-btn {
            height: 36px !important; /*  拽注   */
            min-height: 36px; /* 注转 抓 */
            display: inline-flex; /* 砖砖 驻拽住 砖专 转 */
            align-items: center;
            justify-content: center;
            border: 1px solid #444746;
            background-color: transparent;
            color: #c4c7c5;
            transition: all 0.2s ease;
            box-sizing: border-box;
            margin: 0 5px; /* 专   */
        }

        /* 注爪 驻转专 注 拽住 (砖, 爪 ) - 爪专转 "" */
        #submitBtn, #examBtn {
            border-radius: 18px; /* 驻转 注转 (爪 ) */
            padding: 0 16px !important; /* 专驻  爪 */
            gap: 8px; /* 专 拽注  拽 拽住 */
        }

        /* 注爪 驻转专 拽 (住 ) - 爪专转 注 砖 */
        #fs-global-btn {
            width: 36px !important; /* 专 砖  */
            padding: 0 !important; /*  专驻  专 */
            border-radius: 50%; /* 注  */
        }

            /* 驻拽 注专 注专  */
            #submitBtn:hover, #examBtn:hover, #fs-global-btn:hover {
                background-color: #333537;
                color: white;
                border-color: #888;
            }

        /* 住 驻转专  驻注 */
        #examBtn.active {
            background-color: rgba(255, 77, 77, 0.15);
            color: #ff8080;
            border-color: #ff4d4d;
        }

        /* 拽 爪 住  砖 砖注专  */
        #lesson-panel.lesson-fullscreen {
            position: fixed !important;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 20000; /* 注  */
        }

        /* 爪 住  注专 拽 */
        #editor-wrapper.editor-fullscreen {
            position: fixed !important;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 20000; /* 注  */
            background: #1e1f20; /* 专拽注 专专转  */
        }

        /* --- 注爪 转 爪 (注专 / 砖注专) --- */
        .mode-toggle-container {
            display: flex;
            background-color: transparent; /* 专拽注 砖拽祝 */
            border: 1px solid #444746;
            border-radius: 18px; /* 专住 爪 */
            padding: 2px; /* 专 拽  住专转 驻转专 */
            height: 36px; /*  拽注  砖专 驻转专 */
            box-sizing: border-box;
            align-items: center;
        }

        .mode-btn {
            border: none;
            background: transparent;
            color: #8e918f;
            padding: 0 15px;
            height: 100%; /* 转驻住 转   驻 */
            border-radius: 16px; /* 专住 驻 拽 -2px 爪 */
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

            .mode-btn:hover {
                color: #e3e3e3;
            }

            /* 爪 驻注 */
            .mode-btn.active {
                background-color: #a8c7fa; /*  专 */
                color: #000000; /* 拽住 砖专 */
                font-weight: 700;
                box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            }

            /*  爪 驻注 砖驻转专 砖转 () */
            .mode-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

        /* 爪 住  - 住转专 转 转驻专 爪 */
        #lesson-panel.lesson-fullscreen #lesson-sidebar {
            display: none !important;
        }

        /* 爪 住  - 专拽注 砖 转 */
        #lesson-panel.lesson-fullscreen #lesson-content {
            background-color: #131314;
        }
    </style>
</head>
<body>

    <div id="universal-modal">
        <div class="modal-box" style="text-align: center;">
            <div style="margin-top: -50px; margin-bottom: 10px;">
                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MCA4MCI+PHJlY3QgeD0iMTgiIHk9IjE4IiB3aWR0aD0iNDQiIGhlaWdodD0iNDAiIHJ4PSI4IiBmaWxsPSIjZmY0ZDRkIi8+PHJlY3QgeD0iOCIgeT0iMzAiIHdpZHRoPSI4IiBoZWlnaHQ9IjE2IiByeD0iMiIgZmlsbD0iI2ZmNGQ0ZCIvPjxyZWN0IHg9IjY0IiB5PSIzMCIgd2lkdGg9IjgiIGhlaWdodD0iMTYiIHJ4PSIyIiBmaWxsPSIjZmY0ZDRkIi8+PHJlY3QgeD0iMzYiIHk9IjgiIHdpZHRoPSI4IiBoZWlnaHQ9IjEwIiByeD0iMiIgZmlsbD0iI2ZmNGQ0ZCIvPjxjaXJjbGUgY3g9IjMwIiBjeT0iMzUiIHI9IjUiIGZpbGw9IiMxMzEzMTQiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjM1IiByPSI1IiBmaWxsPSIjMTMxMzE0Ii8+PHJlY3QgeD0iMjgiIHk9IjQ4IiB3aWR0aD0iNiIgaGVpZ2h0PSIzIiBmaWxsPSIjMTMxMzE0Ii8+PHJlY3QgeD0iMzciIHk9IjQ4IiB3aWR0aD0iNiIgaGVpZ2h0PSIzIiBmaWxsPSIjMTMxMzE0Ii8+PHJlY3QgeD0iNDYiIHk9IjQ4IiB3aWR0aD0iNiIgaGVpZ2h0PSIzIiBmaWxsPSIjMTMxMzE0Ii8+PC9zdmc+"
                     style="width: 70px; height: 70px; background: #1e1f20; border-radius: 50%; padding: 5px; border: 3px solid #ff4d4d; box-shadow: 0 5px 15px rgba(0,0,0,0.5);">
            </div>

            <h3 id="u-modal-title" style="margin-top: 5px; color: #ff4d4d;"> 专:</h3>
            <p id="u-modal-text" style="font-size:15px; color:#e0e0e0; white-space:pre-wrap; text-align:center; direction:rtl; margin-bottom: 20px;"></p>

            <input type="text" id="u-modal-input" class="modal-input" style="display:none;">

            <div class="modal-btns">
                <button id="u-modal-cancel" class="modal-btn-cancel" style="display:none;"> 转</button>
                <button id="u-modal-ok" class="modal-btn-ok">转 / 砖专</button>
            </div>
        </div>
    </div>

    <div id="remote-lock-overlay">
        <div style="text-align: center;">
            <i class="fa-solid fa-cloud-lock" style="font-size: 60px; color: #ff4d4d; margin-bottom: 20px;"></i>
            <h1 style="color: white; margin: 0 0 10px 0;">注专转 砖</h1>
            <p style="color: #aaa; font-size: 18px;">专 注 转 砖 注专转 专注.<br>住 驻转 转 砖注 转住专.</p>
            <div style="margin-top: 20px; color: #a8c7fa; font-size: 12px;">
                <i class="fa-solid fa-sync fa-spin"></i> 转 砖专专...
            </div>
        </div>
    </div>

    <div id="login-overlay">
        <div class="modal-box">
            <h3><i class="fa-solid fa-user-lock"></i> 住 注专转</h3>
            <label style="font-size: 12px; color: #aaa; display:block; text-align:right;">砖 砖转砖:</label>
            <input type="text" id="login-user" class="modal-input" placeholder="砖 砖转砖" style="margin-top:5px;">
            <label style="font-size: 12px; color: #aaa; display:block; text-align:right;">住住:</label>
            <input type="password" id="login-pass" class="modal-input" placeholder="住住" style="margin-top:5px;">
            <div id="login-msg" style="color: #ff4d4d; font-size: 13px; min-height: 20px; margin-bottom: 5px;"></div>
            <button id="login-btn" class="modal-btn-ok btn-login-centered">转专</button>
        </div>
    </div>

    <div id="exam-lockdown-overlay">
        <h1><i class="fa-solid fa-lock"></i>  注</h1>
        <p>转 爪  转专 -3 驻注.<br> 拽专 专 砖专专 注.</p>
        <button id="unlock-btn" style="margin-top:20px; border:1px solid #555; padding:10px 20px; background:transparent; color:#ccc; cursor:pointer;">砖专专 注 (专)</button>
    </div>

    <div id="submit-overlay">
        <div class="modal-box" style="text-align: center;">
            <h3 style="margin-top: 5px; color: #ff4d4d;">:</h3>

            <p id="modal-title-submit" style="font-size: 18px; color: #e0e0e0; margin-top: 0; margin-bottom: 25px; font-weight: 500;"></p>

            <div id="submit-status" style="font-size:14px; margin-bottom:20px; min-height:20px;"></div>

            <input type="hidden" id="submit-student-name">

            <div class="modal-btns" style="justify-content: center; gap: 15px;">
                <button id="submit-cancel-btn" class="modal-btn-cancel" style="width: 100px; justify-content: center;"></button>
                <button id="submit-confirm-btn" class="modal-btn-ok" style="width: 120px; justify-content: center;">砖 注砖</button>
            </div>
        </div>
    </div>

    <div id="ai-panel" class="collapsed">
        <div class="ai-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <i class="fa-solid fa-robot" style="color: #ff4d4d; cursor: pointer;" onclick="toggleAiCollapse()" title="抓/专"></i>
                <span>旨止路执</span>
            </div>
            <div class="ai-tools">
                <button id="clear-chat-btn" title="拽 砖"><i class="fa-solid fa-trash"></i></button>
            </div>
        </div>

        <div class="collapsed-tools">
            <button id="side-book-btn" class="side-icon-btn" title="住驻专 转专" onclick="openExerciseModal()">
                <i class="fa-solid fa-book"></i>
            </button>
        </div>

        <div id="chat-window">
            <div class="chat-msg msg-ai">
                砖!  旨止路执. <br>
                驻砖专 专 转专 <span id="open-ex-link" class="clickable-link">住驻专转 转专 <i class="fa-solid fa-book"></i></span>,  砖 砖转 注 拽.<br>
                驻: 砖转砖  <b>"专"</b>  <b>"住专"</b>  拽 注专 拽转.
            </div>
        </div>
        <div class="typing-indicator" id="ai-loading">
            <i class="fa-solid fa-circle-notch fa-spin"></i> 砖...
        </div>
        <div class="chat-input-area">
            <button id="exercises-btn" title="专 转专"><i class="fa-solid fa-book"></i></button>
            <input type="text" id="ai-input" placeholder="转 ...">
            <button id="send-ai-btn"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>

    <div class="resizer-vertical" id="resizer-v"></div>

    <div id="ide-panel">
        <header>
            <div id="left-header-group" style="display: flex; align-items: center; gap: 20px;">
                <div id="editor-tools" style="display: flex; gap: 8px; align-items: center;">
                    <button id="runBtn" title="专爪"><i id="btnIcon" class="fa-solid fa-play"></i></button>
                    <button id="btn-save" title="砖专 驻专拽"><i class="fa-solid fa-floppy-disk"></i></button>
                    <button id="btn-load" title="注 驻专拽"><i class="fa-solid fa-folder-open"></i></button>
                </div>

                <div style="width: 1px; height: 18px; background: #2d2e30;"></div>

                <div id="exam-tools" style="display: flex; align-items: center; gap: 10px;">
                    <button id="submitBtn" title="砖转 注"><i class="fa-solid fa-paper-plane"></i> 砖</button>
                    <button id="examBtn" title="爪 "><i class="fa-solid fa-lock"></i> 爪 </button>
                    <div class="exam-indicator" id="examIndicator"><div class="exam-dot"></div>爪 </div>
                </div>

            </div>

            <div id="right-header-group" style="display: flex; align-items: center; position: relative;">

                <div id="msg-bubble" style="display: none; position: absolute; top: 50px; right: 0; width: 300px; background: #1e1f20; border: 1px solid #a8c7fa; padding: 15px; border-radius: 8px; z-index: 30000; text-align: right; direction: rtl; box-shadow: 0 5px 20px rgba(0,0,0,0.5); color: #e3e3e3; font-size: 14px; line-height: 1.5;">
                    <div style="font-weight: bold; color: #a8c7fa; margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 5px;">注 专:</div>
                    <div id="msg-bubble-content"></div>
                </div>

                <button id="msg-btn" onclick="toggleMessageBubble()" title="注转 专" style="border: 1px solid #444746; margin-right: 10px; width: 36px !important; height: 36px !important; padding: 0 !important; border-radius: 50%; justify-content: center;">
                    <i class="fa-solid fa-envelope"></i>
                </button>

                <button id="fs-global-btn" onclick="toggleGlobalFullScreen()" title="住  (F11)" style="border: 1px solid #444746; margin-right: 10px;">
                    <i class="fa-solid fa-expand"></i>
                </button>

                <div class="mode-toggle-container">
                    <button id="mode-editor-btn" class="mode-btn active" onclick="switchViewMode('editor')">
                        <i class="fa-solid fa-code"></i> 注专
                    </button>
                    <button id="mode-lesson-btn" class="mode-btn" onclick="switchViewMode('lesson')">
                        <i class="fa-solid fa-graduation-cap"></i> 砖注专
                    </button>
                </div>
            </div>
        </header>

        <div id="lesson-panel" style="display: none; flex: 1; overflow: hidden; background-color: #131314; flex-direction: row-reverse; position: relative;">

            <div id="lesson-sidebar" style="width: 250px; background: #1e1f20; border-left: 1px solid #2d2e30; display: flex; flex-direction: column;">
                <div style="padding: 15px; font-weight: bold; border-bottom: 1px solid #2d2e30; text-align: right;">转 注</div>
                <div id="lesson-menu-container" style="flex: 1; overflow-y: auto;">
                    <div style="padding: 20px; text-align: center; color: #888;">注 拽专住...</div>
                </div>
            </div>

            <div id="lesson-content" style="flex: 1; padding: 0; overflow: hidden; position: relative; text-align: right; direction: rtl;">
                <div style="padding: 30px; color: #e3e3e3; font-size: 16px;">
                    专 砖注专 转驻专 爪 砖  转.
                </div>
            </div>

            <div class="lesson-zoom-controls" style="position: absolute; bottom: 20px; right: 30px; z-index: 20001; display: flex; gap: 8px;">

                <button class="zoom-btn" onclick="toggleLessonFullScreen()" title="住 "><i id="fs-lesson-icon" class="fa-solid fa-expand"></i></button>

                <button class="zoom-btn" onclick="toggleLessonContrast()" title="驻 爪注 (/)"><i class="fa-solid fa-circle-half-stroke"></i></button>

                <button class="zoom-btn" onclick="zoomLesson(-0.1)" title="拽 转爪"><i class="fa-solid fa-minus"></i></button>
                <button class="zoom-btn" onclick="zoomLesson(0.1)" title=" 转爪"><i class="fa-solid fa-plus"></i></button>
            </div>

        </div>

        <div class="ide-body">
            <div id="tabs-container">
                <button id="add-tab-btn"><i class="fa-solid fa-plus"></i></button>
            </div>

            <div id="editor-wrapper">
                <div id="editor"></div>
                <div class="editor-controls">
                    <button class="zoom-btn" onclick="toggleEditorFullScreen()" title="住 "><i id="fs-editor-icon" class="fa-solid fa-expand"></i></button>
                    <button class="zoom-btn" onclick="toggleEditorTheme()" title="爪 /"><i class="fa-solid fa-circle-half-stroke"></i></button>
                    <button class="zoom-btn" id="zoom-out-btn" title="拽 拽住"><i class="fa-solid fa-minus"></i></button>
                    <button class="zoom-btn" id="zoom-in-btn" title=" 拽住"><i class="fa-solid fa-plus"></i></button>
                </div>
            </div>

            <div class="resizer-horizontal" id="resizer-h"></div>

            <div id="bottom-panel">
                <div id="input-container">
                    <div class="panel-header">INPUT</div>
                    <textarea id="stdin-input" placeholder="Enter input here..."></textarea>
                </div>

                <div class="resizer-vertical" id="resizer-io"></div>

                <div id="output-wrapper">
                    <div class="panel-header" style="border-left:none;">OUTPUT</div>
                    <div id="output-container"><span style="color:#666;">// Output here...</span></div>
                </div>
            </div>
        </div>
    </div>

    <div id="context-menu"><div class="ctx-item" id="ctx-rename"><i class="fa-solid fa-pen"></i> Rename</div><div class="ctx-item" id="ctx-delete"><i class="fa-solid fa-trash"></i> Delete</div></div>

    <div id="rename-overlay"><div class="modal-box"><h3>Rename File</h3><input type="text" id="rename-filename" class="modal-input"><div class="modal-btns"><button id="rename-cancel" class="modal-btn-cancel">Cancel</button><button id="rename-confirm" class="modal-btn-ok">Rename</button></div></div></div>

    <div id="exercise-overlay">
        <div class="exercise-list-box">
            <div class="ex-header">
                <span>住驻专转 转专</span>
                <button id="close-ex-modal" style="font-size:16px; padding:0;"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="ex-content" id="exercise-list"></div>
        </div>
    </div>

    <div id="save-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 21000; justify-content: center; align-items: center; backdrop-filter: blur(4px);">
        <div class="modal-box">
            <h3>砖专转 驻专拽</h3>

            <input type="text" id="save-input-name" class="modal-input" placeholder="砖 驻专拽">
            <div id="save-status-msg" style="min-height: 25px; font-size: 13px; margin-top: 5px;"></div>
            <div class="modal-btns">
                <button id="save-cancel" class="modal-btn-cancel"></button>
                <button id="save-confirm" class="modal-btn-ok">砖专</button>
            </div>
        </div>
    </div>

    <div id="load-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 21000; justify-content: center; align-items: center; backdrop-filter: blur(4px);">
        <div class="modal-box" style="height: 450px; display: flex; flex-direction: column;">
            <h3>驻专拽 砖</h3>
            <div id="load-status-msg" style="min-height: 25px; font-size: 13px; margin-bottom: 5px;"></div>
            <div id="project-list-area" class="project-list-container"></div>
            <div class="modal-btns" style="margin-top: 15px;">
                <button id="load-close" class="modal-btn-cancel">住专</button>
            </div>
        </div>
    </div>

    <div id="new-file-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 22000; justify-content: center; align-items: center; backdrop-filter: blur(4px);">
        <div class="modal-box" style="width: 380px;">
            <h3 style="margin-top:0; margin-bottom: 20px;">爪专转 拽 砖</h3>
            <div class="input-group">
                <button id="create-file-btn" class="btn-create-small">爪专</button>
                <input type="text" id="new-file-name" class="modal-input" placeholder="砖 拽">
            </div>
            <div style="height: 1px; background: #2d2e30; margin: 15px 0;"></div>
            <div style="text-align: center;">
                <div id="open-lib-link" class="lib-link" style="margin-bottom: 10px; font-size: 13px;">
                    <i class="fa-solid fa-book"></i> 驻转 专 拽转 转
                </div>
                <div id="lib-loader" style="display:none; color:#aaa; font-size:12px; margin-bottom:10px;"><i class="fa-solid fa-circle-notch fa-spin"></i> 注...</div>
                <div id="lib-container" class="project-list-container" style="display:none; height: 180px; margin-bottom: 5px;"></div>
            </div>
            <div class="modal-btns" style="margin-top: 20px;">
                <button id="new-file-close" class="modal-btn-cancel" style="font-size: 13px; padding: 6px 20px;">住专</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <script>
        (function () {
            const SECURE_MODE = true;

            if (SECURE_MODE) {
                document.addEventListener('contextmenu', event => event.preventDefault());
                document.addEventListener('keydown', function (e) {
                    if (
                        e.key === 'F12' ||
                        (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                        (e.ctrlKey && e.shiftKey && e.key === 'J') ||
                        (e.ctrlKey && e.key === 'U')
                    ) {
                        e.preventDefault();
                    }
                });

                let hasSentDebuggerAlert = false;
                setInterval(() => {
                    const start = new Date().getTime();
                    debugger;
                    const end = new Date().getTime();

                    if (end - start > 100) {
                        if (!hasSentDebuggerAlert && typeof globalStudentName !== 'undefined' && globalStudentName) {
                            hasSentDebuggerAlert = true;
                            sendlog(globalStudentName, "(Debugger Mode)");
                        }
                    }
                }, 100);
            }

            const CONTROL_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxumfuV3J-mHCWLvFxZuuRJ0B2uAQ5YvS-jZ-2in9xSiOqCVzA2KcLEWqr7dylk6GKKDQ/exec";
            const ORIGINAL_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT7dGkvqmR6SZR1K6CQO_xSkpeP4I78Dycw_58HoscO_WRkK3NWZcUtIdTRELwPCnG79NHcBFV7euoB/pub?output=csv";
            const EXERCISES_CSV_URL = "https://corsproxy.io/?" + encodeURIComponent(ORIGINAL_SHEET_URL);
            const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdfkV1E_rCAlRt6qcvIwI4Nmb5QRqN0S6vo7-mPx_shgknVzQ/formResponse";
            const ENTRY_ID_NAME = "entry.1249368905";
            const ENTRY_ID_CODE = "entry.588004609";

            let EXERCISES_DB = {};
            let currentActiveExercise = null;
            let globalStudentName = "";
            let isSystemInteraction = false;
            let lastSystemMessage = "";

            let isSystemLocked = false;
            let isWatchdogActive = true;
            let remotePassword = "";
            let lockInterval = null;

            let isLearningMode = false;
            let lessonsData = {};
            let currentLessonContext = null;

            const JAVA_STDLIB = {
                "String": ["length()", "charAt(int index)", "substring(int begin, int end)", "indexOf(String s)", "equals(Object o)", "equalsIgnoreCase(String s)", "toUpperCase()", "toLowerCase()", "trim()", "contains(CharSequence s)"],
                "Math": ["abs(int a)", "max(int a, int b)", "min(int a, int b)", "pow(double a, double b)", "sqrt(double a)", "random()", "round(double a)", "ceil(double a)", "floor(double a)", "PI", "E"],
                "System": ["out.println()", "out.print()", "out.printf()", "in", "exit(0)", "currentTimeMillis()"],
                "Scanner": ["nextInt()", "nextDouble()", "nextLine()", "next()", "hasNext()", "close()"],
                "ArrayList": ["add(E e)", "get(int index)", "size()", "remove(int index)", "clear()", "isEmpty()", "contains(Object o)"],
                "Arrays": ["toString(int[] a)", "sort(int[] a)", "binarySearch(int[] a, int key)", "copyOf(int[] original, int newLength)"],
                "Random": ["nextInt(int bound)", "nextDouble()", "nextBoolean()"]
            };
            const KEYWORDS = ["public", "private", "protected", "static", "final", "void", "class", "interface", "extends", "implements", "new", "return", "if", "else", "for", "while", "do", "switch", "case", "break", "continue", "default", "try", "catch", "finally", "throw", "throws", "import", "package", "this", "super", "boolean", "int", "double", "char", "float", "long", "byte", "short", "true", "false", "null"];

            const Sys = {
                _show: (type, msg, inputType = null, placeholder = "") => {
                    return new Promise((resolve) => {
                        isSystemInteraction = true;
                        const overlay = document.getElementById('universal-modal');
                        const title = document.getElementById('u-modal-title');
                        const text = document.getElementById('u-modal-text');
                        const input = document.getElementById('u-modal-input');
                        const btnOk = document.getElementById('u-modal-ok');
                        const btnCancel = document.getElementById('u-modal-cancel');

                        overlay.style.display = 'flex';
                        input.style.display = 'none';
                        btnCancel.style.display = 'none';
                        input.value = '';
                        text.innerText = msg;

                        title.innerText = ":";

                        if (type === 'alert') {
                            btnOk.innerText = '砖';
                            btnOk.onclick = () => { close(); resolve(true); };
                        } else if (type === 'confirm') {
                            title.innerText = ":";
                            btnOk.innerText = '';
                            btnCancel.innerText = '';
                            btnCancel.style.display = 'inline-block';
                            btnOk.onclick = () => { close(); resolve(true); };
                            btnCancel.onclick = () => { close(); resolve(false); };
                        } else if (type === 'prompt') {
                            title.innerText = " 爪专 注:";
                            input.style.display = 'block';
                            input.type = inputType || 'text';
                            input.placeholder = placeholder;
                            btnOk.innerText = '砖专';
                            btnCancel.innerText = '';
                            btnCancel.style.display = 'inline-block';
                            input.focus();
                            input.onkeydown = (e) => { if (e.key === 'Enter') btnOk.click(); };
                            btnOk.onclick = () => { let val = input.value; close(); resolve(val); };
                            btnCancel.onclick = () => { close(); resolve(null); };
                        }
                        function close() { overlay.style.display = 'none'; isSystemInteraction = false; }
                    });
                },
                alert: async (msg) => { return await Sys._show('alert', msg); },
                confirm: async (msg) => { return await Sys._show('confirm', msg); },
                prompt: async (msg, isPassword = false) => { return await Sys._show('prompt', msg, isPassword ? 'password' : 'text'); }
            };

            const TEACHER_PROMPT = `
 拽砖  驻注 专 拽  注 砖 转 转  专转 砖专.

专转 住住 ()
转: 转 转, 转.
注 转专: 转, 转, 注专, 拽转 住住转, 驻注转.

--- 转转 专转 (砖专) - 拽 拽专! ---
1. 驻住 转专 :
               * 住驻专 砖: int  (住专 砖转砖 -long, short, byte).
               * 住驻专 注砖专: double  (住专 砖转砖 -float).
               * 专: boolean, char, String.
               * 住专 砖转砖 -var.

2.  拽专 (Control Flow):
               * 住专 砖转砖 -break  continue 转 转! 砖 砖转砖 转 注爪专   (砖: while(i < n && !found)).
               * 住专 砖转砖 -Ternary Operator ( ? :),  专拽 -if-else .
               * 住专 砖转砖 -foreach (转 for-each),  专拽 -for 专 注 拽住 (i).

3. 住专 :
               *  砖 转拽 (Streams, Lambdas, Anonymous Arrays, Collections).
               *  住驻专转 砖 转 转 ( List, Map   专 专转).
               * 注专转 拽 转 转 注专转  转.

 爪 转转
1. 住 专注砖 (Hello World):
                拽 注专  专专转  ("Hello World") 转 拽砖 注专 转专 砖 - **转转注  拽 拽**! 转 砖专 转专 砖.

2. 砖 注  ("转住专 "):
                转 砖 " ?", "转住专 "  " 转" - 注 住专  驻砖,  拽  住驻专.

3. 拽砖 "专"  "砖":
               转 转 爪注   驻转专.  转专 注 爪注 砖专 转!

注拽专转 注
1. 注拽专 爪注 :
               注  转转 转 专转 ! 转 ** 转 拽爪专** 爪注  .

2. 驻 砖 转:
               * 注祝 拽 驻专拽 专专.
               *  : int x = 5; (砖专 砖) return x;
               *  专注: return 5; ( 砖 砖 专).

---  转砖 (拽专!) ---
注 专 转 转砖 驻专  :

1. [砖驻 住专 拽爪专  专 爪注  注专转]

[专拽  爪注 专砖 转转 拽 驻注, 住祝 转 拽 :]
\`\`\`java
// 拽 专 爪注  
\`\`\`
`;

            const LESSON_PROMPT = `
转 注转 注专  砖 转 砖爪驻 砖注专 注 砖.
转 转转:
1. 注 爪专 驻砖转, 住专 住转 ( 爪专 爪  砖 专砖 拽砖).
2. 转专 专爪 转转 转 拽 转 专专转  砖 转 专.
3. 转住 砖专转 转 砖注专 砖转 专 专注.
4.  转 砖 注 砖, 住专 转 砖驻 驻砖.
`;

            const WELCOME_MSG = `砖!  旨止路执. <br>
                        驻砖专 专 转专 <span id="welcome-ex-link" class="clickable-link">住驻专转 转专 <i class="fa-solid fa-book"></i></span>,  砖 砖转 注 拽.<br>
                        驻: 砖转砖  <b>"专"</b>  <b>"住专"</b>  拽 注专 拽转.`;

            let editorInstance;
            let currentFontSize = 16;
            let files = { "Main.java": `public class Main {\n    public static void main(String[] args) {\n        System.out.println("Hello World");\n    }\n}` };
            let activeFileName = "Main.java";
            let contextMenuTarget = null;
            let isExamMode = false;
            let examStrikes = 0;
            const MAX_STRIKES = 3;

            function scanProjectForClasses() {
                const projectMap = {};
                Object.keys(files).forEach(filename => {
                    const code = (filename === activeFileName && editorInstance) ? editorInstance.getValue() : files[filename];
                    const classNameMatch = code.match(/class\s+(\w+)/);
                    if (classNameMatch) {
                        const className = classNameMatch[1];
                        const methods = [];
                        const methodRegex = /public\s+(?:static\s+)?(?:\w+|void)\s+(\w+)\s*\(/g;
                        let match;
                        while ((match = methodRegex.exec(code)) !== null) methods.push(match[1] + "()");
                        projectMap[className] = methods;
                    }
                });
                return projectMap;
            }

            require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' } });
            require(['vs/editor/editor.main'], function () {
                const javaFormatter = function (model) {
                    const text = model.getValue(); const lines = text.split('\n'); const edits = []; let indentLevel = 0;
                    for (let i = 0; i < lines.length; i++) {
                        let line = lines[i].trim();
                        if (line.startsWith('}')) indentLevel = Math.max(0, indentLevel - 1);
                        const indentString = "    ".repeat(indentLevel);
                        const newText = indentString + line;
                        if (lines[i] !== newText) edits.push({ range: { startLineNumber: i + 1, startColumn: 1, endLineNumber: i + 1, endColumn: lines[i].length + 1 }, text: newText });
                        if (line.endsWith('{')) indentLevel++;
                    }
                    return edits;
                };

                monaco.languages.registerDocumentFormattingEditProvider('java', { provideDocumentFormattingEdits: (model) => javaFormatter(model) });
                monaco.languages.registerCompletionItemProvider('java', {
                    triggerCharacters: ['.'],
                    provideCompletionItems: function (model, position) {
                        const textUntilPosition = model.getValueInRange({ startLineNumber: position.lineNumber, startColumn: 1, endLineNumber: position.lineNumber, endColumn: position.column });
                        const range = { startLineNumber: position.lineNumber, endLineNumber: position.lineNumber, startColumn: model.getWordUntilPosition(position).startColumn, endColumn: model.getWordUntilPosition(position).endColumn };
                        const suggestions = [];
                        const isMemberAccess = textUntilPosition.endsWith('.');
                        if (isMemberAccess) {
                            const segments = textUntilPosition.trim().split(/[ .]/);
                            let objectName = segments[segments.length - 2].replace(/[^a-zA-Z0-9]/g, '');
                            if (JAVA_STDLIB[objectName]) JAVA_STDLIB[objectName].forEach(method => suggestions.push({ label: method, kind: monaco.languages.CompletionItemKind.Method, insertText: method.replace('()', '($0)'), insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: "Java Library", range: range }));
                            const userClasses = scanProjectForClasses();
                            if (userClasses[objectName]) userClasses[objectName].forEach(method => suggestions.push({ label: method, kind: monaco.languages.CompletionItemKind.Method, insertText: method, detail: "User Class", range: range }));
                        } else {
                            KEYWORDS.forEach(kw => suggestions.push({ label: kw, kind: monaco.languages.CompletionItemKind.Keyword, insertText: kw, range: range }));
                            Object.keys(JAVA_STDLIB).forEach(cls => suggestions.push({ label: cls, kind: monaco.languages.CompletionItemKind.Class, insertText: cls, range: range }));
                            suggestions.push({ label: 'sysout', kind: monaco.languages.CompletionItemKind.Snippet, insertText: 'System.out.println($0);', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Print', range: range });
                            suggestions.push({ label: 'main', kind: monaco.languages.CompletionItemKind.Snippet, insertText: 'public static void main(String[] args) {\n\t$0\n}', insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet, detail: 'Main', range: range });
                        }
                        return { suggestions: suggestions };
                    }
                });

                monaco.editor.defineTheme('java-custom', { base: 'vs-dark', inherit: true, rules: [{ token: 'keyword', foreground: '569CD6', fontStyle: 'bold' }, { token: 'type.identifier', foreground: '4EC9B0' }, { token: 'identifier', foreground: 'DCDCAA' }, { token: 'string', foreground: 'CE9178' }, { token: 'comment', foreground: '6A9955' }, { token: 'number', foreground: 'B5CEA8' }], colors: { 'editor.background': '#1e1f20' } });

                editorInstance = monaco.editor.create(document.getElementById('editor'), {
                    value: files[activeFileName], language: 'java', theme: 'java-custom', automaticLayout: true, fontSize: currentFontSize, minimap: { enabled: false }, suggestOnTriggerCharacters: true, acceptSuggestionOnEnter: "on", tabSize: 4, insertSpaces: true, formatOnType: true, formatOnPaste: true
                });

                editorInstance.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyI, () => editorInstance.trigger('editor', 'editor.action.formatDocument'));
                editorInstance.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Space, () => editorInstance.trigger('editor', 'editor.action.triggerSuggest'));
                editorInstance.onDidChangeModelContent(() => { files[activeFileName] = editorInstance.getValue(); });

                loadExercisesFromSheet();
                renderTabs();
                initResizers();

                bindEvents();
                setTimeout(function () {
                    switchViewMode('lesson');
                }, 500);
            });

            function bindEvents() {
                document.getElementById('runBtn').onclick = runCode;
                document.getElementById('btn-save').onclick = saveProject;
                document.getElementById('btn-load').onclick = loadProject;
                document.getElementById('submitBtn').onclick = openSubmitModal;
                document.getElementById('examBtn').onclick = toggleExamMode;

                document.getElementById('add-tab-btn').onclick = openNewFileModal;
                document.getElementById('zoom-in-btn').onclick = () => changeFontSize(1);
                document.getElementById('zoom-out-btn').onclick = () => changeFontSize(-1);
                document.getElementById('ctx-rename').onclick = triggerRename;
                document.getElementById('ctx-delete').onclick = triggerDelete;
                document.getElementById('rename-cancel').onclick = closeRenameModal;
                document.getElementById('rename-confirm').onclick = performRename;
                document.getElementById('close-ex-modal').onclick = closeExerciseModal;
                document.getElementById('save-cancel').onclick = () => document.getElementById('save-overlay').style.display = 'none';
                document.getElementById('save-confirm').onclick = performSaveLogic;
                document.getElementById('load-close').onclick = () => document.getElementById('load-overlay').style.display = 'none';
                document.getElementById('create-file-btn').onclick = createCustomFile;
                document.getElementById('open-lib-link').onclick = fetchLibraryClasses;
                document.getElementById('new-file-close').onclick = closeNewFileModal;
                document.getElementById('login-btn').onclick = performLogin;
                document.getElementById('unlock-btn').onclick = unlockByPassword;
                document.getElementById('submit-cancel-btn').onclick = closeSubmitModal;
                document.getElementById('submit-confirm-btn').onclick = submitToGoogleForms;
                document.getElementById('clear-chat-btn').onclick = clearChat;
                document.getElementById('exercises-btn').onclick = openExerciseModal;
                document.getElementById('send-ai-btn').onclick = sendToAI;
                document.getElementById('ai-input').onkeypress = handleChatKey;
                document.getElementById('login-user').onkeypress = handleLoginKey;
                document.getElementById('login-pass').onkeypress = handleLoginKey;
                document.getElementById('copy-lesson-btn').onclick = copyLessonCode;
                document.getElementById('side-book-btn').onclick = openExerciseModal;

                const wl = document.getElementById('welcome-ex-link');
                if (wl) wl.onclick = openExerciseModal;
                const ol = document.getElementById('open-ex-link');
                if (ol) ol.onclick = openExerciseModal;
            }

            async function checkRemoteLock() {
                try {
                    const response = await fetch(CONTROL_SCRIPT_URL + "?t=" + new Date().getTime());
                    if (!response.ok) return;

                    const data = await response.json();

                    if (data.password) remotePassword = String(data.password);
                    if (data.examUrl) remoteExamUrl = String(data.examUrl);

                    isSystemLocked = (data.status === "BLOCK");

                    // --- 拽 注转 注转 (转 A4) ---
                    if (data.message && data.message.trim() !== "") {
                        //  注 砖转转 驻注 专
                        if (data.message !== lastSystemMessage) {
                            lastSystemMessage = data.message;
                            window.lastSystemMessage = lastSystemMessage; // 注 

                            if (globalStudentName) {
                                // 拽:   拽砖专?
                                if (lastSystemMessage.startsWith("http")) {
                                    showUrlModal(lastSystemMessage);
                                } else {
                                    // 拽住 专
                                    await Sys.alert(" 注转 转:\n\n" + lastSystemMessage);
                                }
                            }
                        }
                    } else {
                        window.lastSystemMessage = "";
                    }
                    // ---------------------------------------

                    if (data.watchdog === "off") {
                        isWatchdogActive = false;
                        document.body.classList.remove('kiosk-mode');
                    } else {
                        isWatchdogActive = true;
                        if (data.watchdog === "on") {
                            document.body.classList.add('kiosk-mode');
                            enforceKioskMode();
                        } else {
                            document.body.classList.remove('kiosk-mode');
                        }
                    }
                    updateLockUI();
                } catch (e) { console.error(e); }
            }

            function updateLockUI() {
                const overlay = document.getElementById('remote-lock-overlay');
                if (isSystemLocked) overlay.style.display = 'flex'; else overlay.style.display = 'none';
            }

            // 住 住 住   爪
            document.documentElement.requestFullscreen().catch(() => { });

            async function performLogin() {
                const u = document.getElementById('login-user').value.trim();
                const p = document.getElementById('login-pass').value.trim();
                const msg = document.getElementById('login-msg');
                const btn = document.getElementById('login-btn');

                if (!u || !p) { msg.innerText = "  转  砖转"; return; }
                btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> 转专...'; msg.innerText = "";
                const deviceId = getUniqueDeviceId();

                try {
                    const url = CONTROL_SCRIPT_URL + "?action=login" + "&user=" + encodeURIComponent(u) + "&pass=" + encodeURIComponent(p) + "&deviceId=" + encodeURIComponent(deviceId);
                    const response = await fetch(url);
                    const data = await response.json();

                    if (data.result === "APPROVE") {
                        globalStudentName = data.name;
                        localStorage.setItem('studentName', globalStudentName);
                        document.getElementById('login-overlay').style.display = 'none';

                        const firstName = getFirstName(globalStudentName);
                        const chatBox = document.querySelector('.msg-ai');
                        if (chatBox) chatBox.innerHTML = `砖 ${firstName}!  旨止路执. <br>驻砖专 专 转专 <span id="open-ex-link-2" class="clickable-link">住驻专转 转专 <i class="fa-solid fa-book"></i></span>,  砖 砖转 注 拽.`;
                        setTimeout(() => { if (document.getElementById('open-ex-link-2')) document.getElementById('open-ex-link-2').onclick = openExerciseModal; }, 100);

                        sendlog(globalStudentName, `[LOGIN] 转专 爪 (砖: ${deviceId})`);
                        startGlobalWatchdog();
                        if (lockInterval) clearInterval(lockInterval);
                        checkRemoteLock();
                        lockInterval = setInterval(checkRemoteLock, 5000);
                    } else {
                        msg.innerText = data.msg || "砖 驻专 转专转";
                        btn.disabled = false; btn.innerHTML = '转专';
                    }
                } catch (e) {
                    msg.innerText = "砖转 转拽砖专转 注 砖专转";
                    btn.disabled = false; btn.innerHTML = '转专';
                }
            }

            let watchdogDebounce = false;
            function startGlobalWatchdog() {
                //  注专   注专 ( 转 砖 爪)
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'hidden') handleViolation();
                });

                //   驻拽住 (拽拽 抓 )
                window.addEventListener('blur', () => {
                    // 转拽: 拽  驻拽住 注专 -iframe (  拽住)
                    //   驻注  iframe, 住 砖转 注 转专 驻砖 注 注 住
                    if (document.activeElement && document.activeElement.tagName === 'IFRAME') {
                        return; //  住专,  转驻注 注拽
                    }

                    handleViolation();
                });
            }

            async function handleViolation() {
                if (!isWatchdogActive) return;
                if (isSystemInteraction || watchdogDebounce) return;
                watchdogDebounce = true; setTimeout(() => { watchdogDebounce = false; }, 5000);
                if (isExamMode) {
                    examStrikes++;
                    sendlog(globalStudentName, ` 专转  (${examStrikes}/3)`);
                    if (examStrikes >= MAX_STRIKES) lockdownExam(); else await Sys.alert(`转专转 砖注转 ! (${examStrikes}/3)`);
                    return;
                }
                sendlog(globalStudentName, `锔 转专转 爪 `);
                setTimeout(async () => { await Sys.alert("转专转 爪 注专转!"); }, 100);
            }

            async function loadExercisesFromSheet() {
                try {
                    const timestamp = new Date().getTime();
                    const freshGoogleUrl = ORIGINAL_SHEET_URL + "&t=" + timestamp;
                    const finalUrl = "https://corsproxy.io/?" + encodeURIComponent(freshGoogleUrl);
                    const response = await fetch(finalUrl);
                    const csvText = await response.text();
                    Papa.parse(csvText, {
                        header: true, skipEmptyLines: true,
                        complete: function (results) {
                            const tempDB = {}; EXERCISES_DB = {};
                            results.data.forEach((row, index) => {
                                if (!row.category || !row.title) return;
                                if (!tempDB[row.category]) tempDB[row.category] = [];
                                tempDB[row.category].push({ id: 100 + index, title: row.title, desc: row.description || "", task: row.task || "" });
                            });
                            EXERCISES_DB = tempDB;
                            renderExerciseList();
                        }
                    });
                } catch (error) { console.error("CSV Load Error:", error); }
            }

            function renderExerciseList() {
                const list = document.getElementById('exercise-list'); list.innerHTML = "";
                if (Object.keys(EXERCISES_DB).length === 0) { list.innerHTML = "<div style='padding:10px; color:#aaa;'>注 转专...</div>"; return; }
                Object.keys(EXERCISES_DB).forEach(category => {
                    const details = document.createElement('details');
                    const summary = document.createElement('summary'); summary.innerText = category; details.appendChild(summary);
                    EXERCISES_DB[category].forEach(ex => {
                        const div = document.createElement('div'); div.className = 'ex-item';
                        div.innerHTML = `<div class="ex-title">${ex.title}</div><div class="ex-desc">${ex.desc}</div>`;
                        div.onclick = () => selectExercise(ex); details.appendChild(div);
                    });
                    list.appendChild(details);
                });
            }

            function openExerciseModal() {
                document.getElementById('exercise-overlay').style.display = 'flex';
            }
            window.openExerciseModal = openExerciseModal; // <--- 住驻 转 
            function closeExerciseModal() { document.getElementById('exercise-overlay').style.display = 'none'; }
            function selectExercise(ex) {
                currentActiveExercise = ex;
                closeExerciseModal();

                // --- 转拽 砖: 驻转转 爪' 专拽 注砖 ---
                const panel = document.getElementById('ai-panel');
                if (panel.classList.contains('collapsed')) {
                    // 拽专 驻拽爪转 驻转 砖爪专 拽
                    if (typeof window.toggleAiCollapse === "function") {
                        window.toggleAiCollapse();
                    } else {
                        panel.classList.remove('collapsed'); //  拽专 专
                    }
                }
                // ------------------------------------------

                const cw = document.getElementById('chat-window');
                const d = document.createElement('div');
                d.className = `chat-msg msg-system`;
                d.innerHTML = `专 转专: <b>${ex.title}</b><br>${ex.task}`;
                cw.appendChild(d);
                cw.scrollTop = cw.scrollHeight;
            }

            async function sendlog(name, content) {
                const formData = new FormData();
                formData.append(ENTRY_ID_NAME, name);
                formData.append(ENTRY_ID_CODE, content);
                try { await fetch(GOOGLE_FORM_URL, { method: "POST", mode: "no-cors", body: formData }); return true; } catch (e) { return false; }
            }

            function openSubmitModal() {
                const overlay = document.getElementById('submit-overlay');
                const statusDiv = document.getElementById('submit-status');
                const nameInput = document.getElementById('submit-student-name');
                const firstName = getFirstName(globalStudentName);
                document.getElementById('modal-title-submit').innerText = `${firstName}, 砖 转 转专?`;
                statusDiv.innerText = "";
                nameInput.value = globalStudentName;
                overlay.style.display = 'flex';
                injectBotLiToAllModals();
            }
            function closeSubmitModal() { document.getElementById('submit-overlay').style.display = 'none'; }

            async function submitToGoogleForms() {
                const name = globalStudentName; const statusDiv = document.getElementById('submit-status');
                if (editorInstance) files[activeFileName] = editorInstance.getValue();
                let fullCode = ""; if (isExamMode) fullCode += `// EXAM SUBMISSION\n`;
                Object.keys(files).forEach(f => { fullCode += `\n// File: ${f}\n${files[f]}\n-------------------\n`; });
                statusDiv.innerText = "砖..."; statusDiv.style.color = "#a8c7fa";
                await sendlog(name, fullCode);

                statusDiv.innerText = "砖 爪! "; statusDiv.style.color = "#6dd58c";
                if (isExamMode) { disableExamMode(); resetWorkspace(); setTimeout(async () => await Sys.alert(" 砖 爪."), 500); }
                setTimeout(closeSubmitModal, 2000);
            }

            async function toggleExamMode() {
                if (!isExamMode) {
                    if (isLearningMode) { await Sys.alert("砖 住专 转 爪  驻 转转 "); return; }
                    const firstName = getFirstName(globalStudentName);
                    if (await Sys.confirm(`${firstName}, 转 ?`)) {
                        await sendlog(globalStudentName, `转转 `); enableExamMode(); resetWorkspace();
                    }
                } else {
                    const pwd = await Sys.prompt("住 住住转 专  爪 :", true);
                    if (pwd === remotePassword) { disableExamMode(); await Sys.alert("爪  ."); } else if (pwd !== null) await Sys.alert("住住 砖");
                }
            }

            function enableExamMode() {
                isExamMode = true;
                examStrikes = 0;

                // 驻 砖 爪 注专 ( 砖 砖专 砖注专)
                switchViewMode('editor');

                document.getElementById('examBtn').classList.add('active');
                document.getElementById('examIndicator').style.display = 'flex';
                document.getElementById('ai-panel').classList.add('disabled-mode');

                // 专 驻转专
                document.getElementById('ai-input').disabled = true;
                document.getElementById('send-ai-btn').disabled = true;
                document.getElementById('runBtn').disabled = true;
                document.getElementById('btn-save').disabled = true;
                document.getElementById('btn-load').disabled = true;
                document.getElementById('stdin-input').disabled = true;

                // --- 砖: 专 驻转专 注专 砖注专 砖 ---
                document.getElementById('mode-lesson-btn').disabled = true;

                // 注转 注转拽 拽
                document.addEventListener('copy', preventCopyPaste, true);
                document.addEventListener('cut', preventCopyPaste, true);
                document.addEventListener('paste', preventCopyPaste, true);
            }

            function disableExamMode() {
                isExamMode = false;

                document.getElementById('examBtn').classList.remove('active');
                document.getElementById('examIndicator').style.display = 'none';
                document.getElementById('ai-panel').classList.remove('disabled-mode');

                // 砖专专 驻转专
                document.getElementById('ai-input').disabled = false;
                document.getElementById('send-ai-btn').disabled = false;
                document.getElementById('runBtn').disabled = false;
                document.getElementById('btn-save').disabled = false;
                document.getElementById('btn-load').disabled = false;
                document.getElementById('stdin-input').disabled = false;

                // --- 砖: 砖专专 驻转专 注专 砖注专 砖 ---
                document.getElementById('mode-lesson-btn').disabled = false;

                // 砖专专 注转拽 拽
                document.removeEventListener('copy', preventCopyPaste, true);
                document.removeEventListener('cut', preventCopyPaste, true);
                document.removeEventListener('paste', preventCopyPaste, true);
            }
            function preventCopyPaste(e) { if (isExamMode) { e.preventDefault(); e.stopPropagation(); } }
            function lockdownExam() {
                document.getElementById('exam-lockdown-overlay').style.display = 'flex'; if (editorInstance) editorInstance.updateOptions({ readOnly: true });
                sendlog(globalStudentName, `  注 注拽 驻专转 `);
            }
            async function unlockByPassword() {
                const pwd = await Sys.prompt("住 住住转 专 砖专专:", true);
                if (pwd === remotePassword) {
                    document.getElementById('exam-lockdown-overlay').style.display = 'none'; if (editorInstance) editorInstance.updateOptions({ readOnly: false }); examStrikes = 0; await Sys.alert(" 砖专专.");
                } else if (pwd !== null) await Sys.alert("住住 砖");
            }

            async function clearChat() {
                if (await Sys.confirm(" 拽转 转 爪'?")) document.getElementById('chat-window').innerHTML = `<div class="chat-msg msg-ai">${WELCOME_MSG}</div>`;
            }

            async function sendToAI() {
                if (isExamMode) return;
                const inputField = document.getElementById('ai-input');
                const userText = inputField.value.trim();
                if (!userText) return;

                const loading = document.getElementById('ai-loading');

                try {
                    addMessage(userText, 'user');
                    inputField.value = '';
                    loading.style.display = 'flex';

                    if (editorInstance && !isLearningMode) files[activeFileName] = editorInstance.getValue();

                    let fullCode = "";
                    Object.keys(files).forEach(f => { fullCode += `\n// File: ${f}\n${files[f]}`; });

                    const chatMsgs = document.querySelectorAll('.chat-msg');
                    let recentChat = "";
                    for (let i = Math.max(0, chatMsgs.length - 4); i < chatMsgs.length; i++) {
                        recentChat += `${chatMsgs[i].classList.contains('msg-ai') ? "AI" : "User"}: ${chatMsgs[i].innerText}\n`;
                    }

                    let currentSystemPrompt = "";
                    let contextInfo = "";

                    if (isLearningMode && currentLessonContext) {
                        currentSystemPrompt = LESSON_PROMPT;
                        contextInfo = `CURRENT LESSON CONTEXT:\nTitle: ${currentLessonContext.title}\nContent: ${currentLessonContext.text}\nCode Snippet: ${currentLessonContext.code}`;
                    } else {
                        currentSystemPrompt = TEACHER_PROMPT;
                        const activeTaskDescription = currentActiveExercise ? currentActiveExercise.task : "General Help";
                        contextInfo = `EXERCISE CONTEXT:\nTask: ${activeTaskDescription}`;
                    }

                    const fullPrompt = `${currentSystemPrompt}\n\n${contextInfo}\n\nRECENT CHAT:\n${recentChat}\n\nSTUDENT CODE:\n${fullCode}\n\nSTUDENT QUESTION: ${userText}`;

                    const response = await fetch('https://text.pollinations.ai/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            messages: [{ role: 'user', content: fullPrompt }],
                            model: 'openai',
                            jsonMode: false
                        })
                    });

                    let aiText = await response.text();
                    aiText = aiText.replace(/"error"/i, "Error").replace(/(\n\s*---\s*\n[\s\S]*?(Pollinations|Support|mission|kofi)[\s\S]*$)/i, "").replace(/ \*\*Ad\*\* /g, "").trim();

                    addMessage(aiText, 'ai');
                } catch (error) {
                    console.error(error);
                    addMessage("锔 砖转 转拽砖专转.", 'ai');
                }
                finally {
                    loading.style.display = 'none';
                }
            }

            function addMessage(text, sender) {
                const cw = document.getElementById('chat-window'); const d = document.createElement('div'); d.className = `chat-msg msg-${sender}`;
                if (sender === 'ai') {
                    const codeMap = [];
                    const hiddenText = text.replace(/```([\s\S]*?)```/g, (match, rawCode) => {
                        let cleanCode = rawCode.trim().replace(/^(?:java|Java|text)\s+/i, "");
                        const safeCode = cleanCode.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        codeMap.push(safeCode);
                        return `___CODE_BLOCK_${codeMap.length - 1}___`;
                    });
                    let formattedText = hiddenText.replace(/\n/g, '<br>').replace(/___CODE_BLOCK_(\d+)___/g, (m, i) => `<div class="code-block"><button class="copy-btn" onclick="copyCode(this)">Copy</button>${codeMap[i]}</div>`);
                    d.innerHTML = formattedText;
                } else { d.innerHTML = text.replace(/\n/g, '<br>'); }
                cw.appendChild(d); cw.scrollTop = cw.scrollHeight;
            }

            function handleChatKey(e) { if (e.key === 'Enter') sendToAI(); }
            function renderTabs() { const c = document.getElementById('tabs-container'), b = document.getElementById('add-tab-btn'); c.innerHTML = ''; Object.keys(files).forEach(f => { const t = document.createElement('div'); t.className = `tab ${f === activeFileName ? 'active' : ''}`; t.innerHTML = `<span>${f}</span>`; t.onclick = () => switchTab(f); t.oncontextmenu = (e) => openContextMenu(e, f); c.appendChild(t); }); c.appendChild(b); }
            function switchTab(f) { files[activeFileName] = editorInstance.getValue(); activeFileName = f; editorInstance.setValue(files[activeFileName]); renderTabs(); }
            function openContextMenu(e, f) { e.preventDefault(); if (f === "Main.java") return; contextMenuTarget = f; const m = document.getElementById('context-menu'); m.style.display = 'block'; m.style.left = e.pageX + 'px'; m.style.top = e.pageY + 'px'; }
            function closeContextMenu() { document.getElementById('context-menu').style.display = 'none'; }
            async function triggerDelete() { if (!contextMenuTarget) return; if (await Sys.confirm(`Delete ${contextMenuTarget}?`)) { delete files[contextMenuTarget]; if (activeFileName === contextMenuTarget) { activeFileName = "Main.java"; editorInstance.setValue(files[activeFileName]); } renderTabs(); } }
            function triggerRename() { if (!contextMenuTarget) return; document.getElementById('rename-overlay').style.display = 'flex'; document.getElementById('rename-filename').value = contextMenuTarget; }
            async function performRename() { let n = document.getElementById('rename-filename').value.trim(); if (!n.endsWith('.java')) n += '.java'; if (files[n]) { await Sys.alert('Exists!'); return; } files[n] = files[contextMenuTarget]; delete files[contextMenuTarget]; if (activeFileName === contextMenuTarget) activeFileName = n; document.getElementById('rename-overlay').style.display = 'none'; renderTabs(); }
            function closeRenameModal() { document.getElementById('rename-overlay').style.display = 'none'; }

            function openNewFileModal() {
                document.getElementById('new-file-name').value = '';
                document.getElementById('lib-container').style.display = 'none';
                document.getElementById('lib-container').innerHTML = '';
                document.getElementById('new-file-overlay').style.display = 'flex';
                document.getElementById('new-file-name').focus();
            }
            function closeNewFileModal() { document.getElementById('new-file-overlay').style.display = 'none'; }

            async function fetchLibraryClasses() {
                const container = document.getElementById('lib-container'); const loader = document.getElementById('lib-loader');
                container.style.display = 'block'; if (container.children.length > 0) return; loader.style.display = 'block';
                try {
                    const url = `${CONTROL_SCRIPT_URL}?action=getLibraryClasses`; const res = await fetch(url); const data = await res.json();
                    loader.style.display = 'none';
                    if (data.classes && Object.keys(data.classes).length > 0) {
                        Object.keys(data.classes).forEach(className => {
                            const item = document.createElement('div'); item.className = 'project-item';
                            item.innerHTML = `<div style="display:flex; align-items:center; gap:10px;"><i class="fa-solid fa-code" style="color: #a8c7fa;"></i><span style="font-family: monospace; font-size: 14px;">${className}.java</span></div><i class="fa-solid fa-plus" style="color: #666; font-size: 12px;"></i>`;
                            item.onclick = () => addLibraryFile(className, data.classes[className]);
                            container.appendChild(item);
                        });
                    } else container.innerHTML = '<div style="padding:15px; text-align:center; color:#aaa; font-size:13px;">专 专拽</div>';
                } catch (e) { loader.style.display = 'none'; container.innerHTML = '<div style="padding:15px; text-align:center; color:#ff4d4d; font-size:13px;">砖 注</div>'; }
            }
            async function addLibraryFile(name, code) {
                const fileName = name + ".java";
                if (files[fileName]) { if (!await Sys.confirm(`拽抓 ${fileName} 专 拽.  专住?`)) return; }
                files[fileName] = code; finalizeFileAdd(fileName);
            }
            async function createCustomFile() {
                let name = document.getElementById('new-file-name').value.trim().replace(".java", ""); if (!name) return;
                const fileName = name + ".java"; if (files[fileName]) { await Sys.alert("拽!"); return; }
                files[fileName] = `public class ${name} {\n    \n}`; finalizeFileAdd(fileName);
            }
            function finalizeFileAdd(fileName) { closeNewFileModal(); activeFileName = fileName; editorInstance.setValue(files[activeFileName]); renderTabs(); setTimeout(() => Sys.alert(`拽抓 ${fileName} 住祝`), 200); }

            async function runCode() {
                if (isExamMode) { await Sys.alert("专爪 住 爪 ."); return; }
                if (!editorInstance) return; files[activeFileName] = editorInstance.getValue();
                const btn = document.getElementById('runBtn'), icon = document.getElementById('btnIcon'), out = document.getElementById('output-container'), stdin = document.getElementById('stdin-input').value;
                let fullCode = ""; Object.values(files).forEach(c => fullCode += c);
                btn.disabled = true; icon.className = "fa-solid fa-circle-notch fa-spin"; out.innerHTML = '<span class="success-msg">Compiling...</span><br>';
                let allImports = new Set(), mainContent = "", otherContent = "", importRegex = /^\s*import\s+.*;/gm;
                if (files["Main.java"]) { let c = files["Main.java"], i = c.match(importRegex); if (i) i.forEach(x => allImports.add(x.trim())); mainContent = c.replace(importRegex, "").trim(); }
                Object.keys(files).forEach(f => { if (f === "Main.java") return; let c = files[f], i = c.match(importRegex); if (i) i.forEach(x => allImports.add(x.trim())); let clean = c.replace(importRegex, "").trim().replace(/public\s+class/g, "class"); otherContent += "\n\n" + clean; });
                const merged = Array.from(allImports).join("\n") + "\n\n" + mainContent + otherContent;
                try {
                    const res = await fetch('https://emkc.org/api/v2/piston/execute', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ language: "java", version: "15.0.2", files: [{ name: "Main.java", content: merged }], stdin: stdin }) });
                    const data = await res.json(); out.innerHTML = "";
                    if (data.run) {
                        if (data.run.stdout) out.appendChild(Object.assign(document.createElement('span'), { className: 'output-text', innerText: data.run.stdout }));
                        if (data.run.stderr) out.appendChild(Object.assign(document.createElement('span'), { className: 'error-text', innerText: "\n" + data.run.stderr }));
                    } else out.innerHTML = '<span class="error-text">Error: No response.</span>';
                } catch (e) { out.innerHTML += `<br><span class="error-text">Net Error: ${e.message}</span>`; }
                finally { btn.disabled = false; icon.className = "fa-solid fa-play"; }
            }
            function resetWorkspace() { files = { "Main.java": `public class Main {\n    public static void main(String[] args) {\n        \n    }\n}` }; activeFileName = "Main.java"; editorInstance.setValue(files[activeFileName]); renderTabs(); }

            window.copyCode = function (btn) { const cb = btn.parentElement.cloneNode(true); cb.querySelector('.copy-btn').remove(); navigator.clipboard.writeText(cb.textContent.trim()).then(() => { const o = btn.innerText; btn.innerText = "Copied!"; btn.style.color = "#4EC9B0"; setTimeout(() => { btn.innerText = o; btn.style.color = "#ccc"; }, 1500); }); };

            function changeFontSize(d) { currentFontSize = Math.max(10, Math.min(30, currentFontSize + d)); if (editorInstance) editorInstance.updateOptions({ fontSize: currentFontSize }); document.getElementById('output-container').style.fontSize = currentFontSize + 'px'; document.getElementById('stdin-input').style.fontSize = currentFontSize + 'px'; }

            function switchViewMode(mode) {
                // 拽转 拽转
                if (isExamMode && mode === 'lesson') {
                    Sys.alert(" 转 注专 砖注专  ");
                    return;
                }

                // 注 砖转 爪 
                isLearningMode = (mode === 'lesson');

                const btnEditor = document.getElementById('mode-editor-btn');
                const btnLesson = document.getElementById('mode-lesson-btn');

                const ideBody = document.querySelector('.ide-body');
                const lessonPanel = document.getElementById('lesson-panel');
                const leftGroup = document.getElementById('left-header-group');

                if (mode === 'lesson') {
                    // --- 住 爪 砖注专 ---
                    btnLesson.classList.add('active');
                    btnEditor.classList.remove('active');

                    // 砖 拽专: 砖专 注 拽 专拽  砖驻转专  拽驻抓
                    leftGroup.style.visibility = 'hidden';

                    ideBody.style.display = 'none';   // 住转专转 注专
                    lessonPanel.style.display = 'flex'; // 爪转 砖注专

                    // 注转 砖注专  专 注
                    if (Object.keys(lessonsData).length === 0) fetchLessons();

                } else {
                    // --- 住 爪 注专 ---
                    btnEditor.classList.add('active');
                    btnLesson.classList.remove('active');

                    leftGroup.style.visibility = 'visible'; // 专 爪 专

                    ideBody.style.display = 'flex';   // 爪转 注专
                    lessonPanel.style.display = 'none'; // 住转专转 砖注专

                    // 专注 注专 (砖 砖专 爪 住转专)
                    if (editorInstance) editorInstance.layout();
                }
            }
            window.switchViewMode = switchViewMode;

            async function fetchLessons() {
                const menuContainer = document.getElementById('lesson-menu-container');
                menuContainer.innerHTML = '<div style="padding:20px; text-align:center;"><i class="fa-solid fa-circle-notch fa-spin"></i> 注...</div>';
                try {
                    const timestamp = new Date().getTime();
                    const url = `${CONTROL_SCRIPT_URL}?action=getLessons&t=${timestamp}`;

                    const res = await fetch(url);
                    const data = await res.json();

                    if (data.lessons) {
                        lessonsData = data.lessons;
                        renderLessonMenu();
                    }
                    else {
                        menuContainer.innerHTML = ' 爪 砖注专';
                    }
                } catch (e) {
                    menuContainer.innerHTML = '砖 注';
                }
            }

            function renderLessonMenu() {
                const container = document.getElementById('lesson-menu-container');
                container.innerHTML = '';

                //  注 拽专转 专砖转 (Main Categories)
                Object.keys(lessonsData).forEach((mainCat) => {
                    const mainCatDiv = document.createElement('div');
                    mainCatDiv.className = 'lesson-category';
                    // 拽专 专砖转 - 注爪
                    mainCatDiv.innerHTML = `<span style="color: #a8c7fa; font-size:15px;">${mainCat}</span> <i class="fa-solid fa-chevron-down"></i>`;
                    mainCatDiv.style.borderBottom = "1px solid #444";
                    mainCatDiv.style.backgroundColor = "#252627";

                    const mainItemsDiv = document.createElement('div');
                    mainItemsDiv.className = 'lesson-items';

                    // 爪 注 拽专 专砖转
                    mainCatDiv.onclick = () => {
                        mainItemsDiv.classList.toggle('open');
                        const icon = mainCatDiv.querySelector('i');
                        if (mainItemsDiv.classList.contains('open')) {
                            icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
                        } else {
                            icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
                        }
                    };

                    //  注 转转-拽专转 (Sub Categories)
                    const subCategories = lessonsData[mainCat];
                    Object.keys(subCategories).forEach(subCat => {

                        // ---  砖: 爪专转  转转-拽专 ---
                        const subWrapper = document.createElement('div');
                        subWrapper.style.borderBottom = "1px solid #2d2e30";

                        // 1. 转专转 砖 转转-拽专 (注砖  爪)
                        const subHeader = document.createElement('div');
                        subHeader.style.padding = "10px 15px";
                        subHeader.style.fontSize = "13px";
                        subHeader.style.color = "#e3e3e3";
                        subHeader.style.fontWeight = "bold";
                        subHeader.style.backgroundColor = "#1e1f20";
                        subHeader.style.cursor = "pointer";
                        subHeader.style.display = "flex";
                        subHeader.style.justifyContent = "space-between";
                        subHeader.style.alignItems = "center";
                        subHeader.style.userSelect = "none";

                        // 抓 爪  (RTL) + 拽住
                        subHeader.innerHTML = `
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <i class="fa-solid fa-chevron-left" style="font-size:10px; color:#888; transition: transform 0.2s;"></i>
                                    <span>${subCat}</span>
                                </div>
                            `;

                        // 2.  砖 砖注专 注爪 (住转专 转)
                        const lessonsContainer = document.createElement('div');
                        lessonsContainer.style.display = "none"; // 住专 专专转 
                        lessonsContainer.style.backgroundColor = "#131314";

                        // 爪 注 转转-拽专
                        subHeader.onclick = (e) => {
                            e.stopPropagation(); //   住专 转 拽专 专砖转 注转
                            const isOpen = lessonsContainer.style.display === "block";
                            const icon = subHeader.querySelector('i');

                            if (isOpen) {
                                lessonsContainer.style.display = "none";
                                icon.style.transform = "rotate(0deg)"; // 抓 砖 (住专)
                            } else {
                                lessonsContainer.style.display = "block";
                                icon.style.transform = "rotate(-90deg)"; // 抓  (驻转)
                            }
                        };

                        // 住驻转 砖注专 转 
                        subCategories[subCat].forEach(lesson => {
                            const lDiv = document.createElement('div');
                            lDiv.className = 'lesson-item';
                            lDiv.innerText = lesson.title;
                            lDiv.style.paddingRight = "35px"; //  驻
                            lDiv.style.fontSize = "13px";
                            lDiv.style.color = "#aaa";

                            lDiv.onclick = (e) => {
                                e.stopPropagation();
                                loadLessonContent(lDiv, lesson);
                            };
                            lessonsContainer.appendChild(lDiv);
                        });

                        // 专转 
                        subWrapper.appendChild(subHeader);
                        subWrapper.appendChild(lessonsContainer);
                        mainItemsDiv.appendChild(subWrapper);
                    });

                    container.appendChild(mainCatDiv);
                    container.appendChild(mainItemsDiv);
                });
            }

            function loadLessonContent(element, lesson) {
                lessonScale = 1.0;
                isLessonDark = true;

                // 1. 住 驻专 驻注 转驻专 爪
                document.querySelectorAll('.lesson-item').forEach(el => el.classList.remove('active-lesson'));
                element.classList.add('active-lesson');

                currentLessonContext = lesson;

                // 2. 转驻住转 专 转 拽  砖
                const lessonContentDiv = document.getElementById('lesson-content');
                lessonContentDiv.innerHTML = ''; // 拽 : 转专转, , 拽 砖

                // 3.  专驻  爪 转  砖 (Full Screen 转 )
                lessonContentDiv.style.padding = "0";
                lessonContentDiv.style.overflow = "hidden"; //   爪转 (专拽 驻转 转注)

                const content = lesson.text ? lesson.text.trim() : "";
                let contentElement;

                // --- 驻砖专转 ':    拽住 ---
                if (content.startsWith("http") && content.includes("docs.google.com")) {
                    let embedUrl = content;
                    // 专 爪 转爪 拽 (拽 转专)
                    if (embedUrl.includes("/edit")) embedUrl = embedUrl.replace(/\/edit.*/, "/preview");
                    else if (embedUrl.includes("/view")) embedUrl = embedUrl.replace(/\/view.*/, "/preview");

                    // 爪专转 iframe 砖转驻住 100%  专
                    contentElement = document.createElement('iframe');
                    contentElement.src = embedUrl;
                    contentElement.className = 'doc-frame'; // 砖砖 拽 拽转 (驻专 爪注  砖)

                    // 专转 注爪  
                    contentElement.style.width = "100%";
                    contentElement.style.height = "100%";
                    contentElement.style.border = "none";
                    contentElement.style.display = "block";

                    // 驻爪: 砖专 注 爪  (驻 爪注).
                    //  转 专爪 祝  专 - 转拽 转 砖专 :
                    contentElement.style.filter = "invert(1) hue-rotate(180deg)";
                    contentElement.style.background = "#fff"; // 注 

                } else {
                    // --- 驻砖专转 ':   拽住 专 (Markdown) ---
                    contentElement = document.createElement('div');
                    contentElement.id = 'lesson-body';

                    // 注爪 拽住 专
                    contentElement.style.padding = "30px"; //   爪专 专驻 砖 拽专
                    contentElement.style.width = "100%";
                    contentElement.style.height = "100%";
                    contentElement.style.overflowY = "auto"; //  驻转 拽住
                    contentElement.style.boxSizing = "border-box"; // 注 专 专

                    contentElement.innerHTML = parseMarkdown(content);
                }

                // 4. 住驻转  住驻 住
                lessonContentDiv.appendChild(contentElement);

                // 注 拽 注专转 ( 驻专注 砖转砖)
                addMessage(`驻转转 转 砖注专: <b>${lesson.title}</b>.`, 'system');
            }

            async function copyLessonCode() {
                if (!currentLessonContext || !currentLessonContext.code) return;
                if (await Sys.confirm(" 注转拽 转 拽 注专?\n(砖 : 拽  专住)")) {
                    toggleLearningMode();
                    editorInstance.setValue(currentLessonContext.code);
                    files[activeFileName] = currentLessonContext.code;
                }
            }

            function initResizers() {
                const resizerV = document.getElementById('resizer-v'), aiPanel = document.getElementById('ai-panel'), resizerH = document.getElementById('resizer-h'), editorWrapper = document.getElementById('editor-wrapper'), resizerIO = document.getElementById('resizer-io'), inputContainer = document.getElementById('input-container'), bottomPanel = document.getElementById('bottom-panel');
                resizerV.addEventListener('mousedown', function (e) { e.preventDefault(); document.addEventListener('mousemove', resizeX); document.addEventListener('mouseup', stopResizeX); resizerV.classList.add('active'); });
                function resizeX(e) { aiPanel.style.width = Math.max(360, Math.min(window.innerWidth - e.clientX, window.innerWidth * 0.6)) + 'px'; if (editorInstance) editorInstance.layout(); }
                function stopResizeX() { document.removeEventListener('mousemove', resizeX); document.removeEventListener('mouseup', stopResizeX); resizerV.classList.remove('active'); }
                resizerH.addEventListener('mousedown', function (e) { e.preventDefault(); document.addEventListener('mousemove', resizeY); document.addEventListener('mouseup', stopResizeY); resizerH.classList.add('active'); });
                function resizeY(e) { editorWrapper.style.height = Math.max(100, Math.min(e.clientY - document.getElementById('ide-panel').offsetTop - 90, document.getElementById('ide-panel').offsetHeight - 150)) + 'px'; if (editorInstance) editorInstance.layout(); }
                function stopResizeY() { document.removeEventListener('mousemove', resizeY); document.removeEventListener('mouseup', stopResizeY); resizerH.classList.remove('active'); }
                resizerIO.addEventListener('mousedown', function (e) { e.preventDefault(); document.addEventListener('mousemove', resizeIO); document.addEventListener('mouseup', stopResizeIO); resizerIO.classList.add('active'); });
                function resizeIO(e) { inputContainer.style.width = Math.max(100, Math.min(bottomPanel.getBoundingClientRect().right - e.clientX, bottomPanel.getBoundingClientRect().width - 100)) + 'px'; }
                function stopResizeIO() { document.removeEventListener('mousemove', resizeIO); document.removeEventListener('mouseup', stopResizeIO); resizerIO.classList.remove('active'); }
            }

            function saveProject() { document.getElementById('save-input-name').value = ''; document.getElementById('save-status-msg').innerHTML = ''; document.getElementById('save-overlay').style.display = 'flex'; document.getElementById('save-input-name').focus(); }
            async function performSaveLogic() {
                const nameInput = document.getElementById('save-input-name'); const statusDiv = document.getElementById('save-status-msg'); const projectName = nameInput.value.trim();
                if (!projectName) { statusDiv.innerHTML = '<span class="status-error">砖 住专</span>'; return; }
                statusDiv.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> 砖专...'; nameInput.disabled = true;
                try {
                    const payload = encodeURIComponent(JSON.stringify(files));
                    const url = `${CONTROL_SCRIPT_URL}?action=saveProject&user=${encodeURIComponent(globalStudentName)}&project=${encodeURIComponent(projectName)}&files=${payload}&t=${new Date().getTime()}`;
                    const res = await fetch(url); const data = await res.json();
                    if (data.result === "OK") { statusDiv.innerHTML = '<span class="status-success">砖专!</span>'; setTimeout(() => { document.getElementById('save-overlay').style.display = 'none'; nameInput.disabled = false; }, 1500); }
                    else if (data.result === "EXISTS") { statusDiv.innerHTML = '<span class="status-error">砖 拽</span>'; nameInput.disabled = false; }
                    else { statusDiv.innerHTML = `<span class="status-error">${data.error}</span>`; nameInput.disabled = false; }
                } catch (e) { statusDiv.innerHTML = '<span class="status-error">砖</span>'; nameInput.disabled = false; }
            }

            async function loadProject() {
                const overlay = document.getElementById('load-overlay');
                const titleElement = overlay.querySelector('h3');
                const firstName = getFirstName(globalStudentName);

                titleElement.innerText = `驻专拽 砖 ${firstName}`;

                const listArea = document.getElementById('project-list-area');
                const statusDiv = document.getElementById('load-status-msg');
                listArea.classList.remove('list-busy');
                overlay.style.display = 'flex';
                injectBotLiToAllModals();

                listArea.innerHTML = ''; statusDiv.innerHTML = '注...';
                try {
                    const listUrl = `${CONTROL_SCRIPT_URL}?action=listProjects&user=${encodeURIComponent(globalStudentName)}&t=${new Date().getTime()}`;
                    const listRes = await fetch(listUrl); const listData = await listRes.json(); statusDiv.innerHTML = '';
                    if (!listData.projects || listData.projects.length === 0) { listArea.innerHTML = '<div style="padding:20px; text-align:center; color:#aaa;"> 驻专拽</div>'; return; }
                    listData.projects.reverse().forEach(projName => {
                        const item = document.createElement('div'); item.className = 'project-item';
                        item.innerHTML = `<div style="display:flex; align-items:center; gap:10px;"><i class="fa-solid fa-folder"></i><span>${projName}</span></div><div class="delete-btn" onclick="deleteProject(event, '${projName}')"><i class="fa-solid fa-trash"></i></div>`;

                        item.querySelector('.delete-btn').addEventListener('click', (e) => deleteProject(e, projName));
                        item.addEventListener('click', (e) => { if (e.target.closest('.delete-btn')) return; loadSpecificProject(projName); });

                        item.removeAttribute('onclick');
                        item.querySelector('.delete-btn').removeAttribute('onclick');

                        listArea.appendChild(item);
                    });
                } catch (e) { statusDiv.innerHTML = '砖 注'; }
            }

            async function deleteProject(e, name) {
                e.stopPropagation(); if (await Sys.confirm(`拽 转 "${name}"?`)) {
                    const statusDiv = document.getElementById('load-status-msg'); const listArea = document.getElementById('project-list-area');
                    listArea.classList.add('list-busy'); statusDiv.innerHTML = '拽...';
                    try {
                        const url = `${CONTROL_SCRIPT_URL}?action=deleteProject&user=${encodeURIComponent(globalStudentName)}&project=${encodeURIComponent(name)}`;
                        const res = await fetch(url); const data = await res.json();
                        if (data.result === "OK") { loadProject(); setTimeout(() => Sys.alert("拽"), 200); } else { listArea.classList.remove('list-busy'); statusDiv.innerHTML = '砖'; }
                    } catch (err) { listArea.classList.remove('list-busy'); statusDiv.innerHTML = '砖'; }
                }
            }

            async function loadSpecificProject(name) {
                const statusDiv = document.getElementById('load-status-msg'); const listArea = document.getElementById('project-list-area');
                listArea.classList.add('list-busy'); statusDiv.innerHTML = `注 转: <b>${name}</b>...`;
                try {
                    const loadUrl = `${CONTROL_SCRIPT_URL}?action=loadProject&user=${encodeURIComponent(globalStudentName)}&project=${encodeURIComponent(name)}&t=${new Date().getTime()}`;
                    const res = await fetch(loadUrl); const data = await res.json();
                    if (data.files) {
                        files = JSON.parse(data.files); activeFileName = Object.keys(files)[0]; editorInstance.setValue(files[activeFileName]); renderTabs();
                        statusDiv.innerHTML = `注!`; setTimeout(() => { document.getElementById('load-overlay').style.display = 'none'; listArea.classList.remove('list-busy'); }, 500);
                    } else { statusDiv.innerHTML = `砖`; listArea.classList.remove('list-busy'); }
                } catch (e) { statusDiv.innerHTML = '砖'; listArea.classList.remove('list-busy'); }
            }

            function getFirstName(fullName) {
                if (!fullName) return "转";
                return fullName.trim().split(/\s+/)[0];
            }

            function getUniqueDeviceId() {
                let deviceId = localStorage.getItem('school_device_id');
                if (!deviceId) {
                    const randomPart = Math.random().toString(36).substring(2, 10).toUpperCase();
                    deviceId = "DEV-" + randomPart;
                    localStorage.setItem('school_device_id', deviceId);
                }
                return deviceId;
            }

            function injectBotLiToAllModals() {
                const botliHeadHTML = `
                        <div class="botli-head" style="position: absolute; top: -45px; left: 50%; transform: translateX(-50%); z-index: 10000; pointer-events: none;">
                            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MCA4MCI+PHJlY3QgeD0iMTgiIHk9IjE4IiB3aWR0aD0iNDQiIGhlaWdodD0iNDAiIHJ4PSI4IiBmaWxsPSIjZmY0ZDRkIi8+PHJlY3QgeD0iOCIgeT0iMzAiIHdpZHRoPSI4IiBoZWlnaHQ9IjE2IiByeD0iMiIgZmlsbD0iI2ZmNGQ0ZCIvPjxyZWN0IHg9IjY0IiB5PSIzMCIgd2lkdGg9IjgiIGhlaWdodD0iMTYiIHJ4PSIyIiBmaWxsPSIjZmY0ZDRkIi8+PHJlY3QgeD0iMzYiIHk9IjgiIHdpZHRoPSI4IiBoZWlnaHQ9IjEwIiByeD0iMiIgZmlsbD0iI2ZmNGQ0ZCIvPjxjaXJjbGUgY3g9IjMwIiBjeT0iMzUiIHI9IjUiIGZpbGw9IiMxMzEzMTQiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjM1IiByPSI1IiBmaWxsPSIjMTMxMzE0Ii8+PHJlY3QgeD0iMjgiIHk9IjQ4IiB3aWR0aD0iNiIgaGVpZ2h0PSIzIiBmaWxsPSIjMTMxMzE0Ii8+PHJlY3QgeD0iMzciIHk9IjQ4IiB3aWR0aD0iNiIgaGVpZ2h0PSIzIiBmaWxsPSIjMTMxMzE0Ii8+PHJlY3QgeD0iNDYiIHk9IjQ4IiB3aWR0aD0iNiIgaGVpZ2h0PSIzIiBmaWxsPSIjMTMxMzE0Ii8+PC9zdmc+"
                            style="width: 75px; height: 75px; background: #1e1f20; border-radius: 50%; padding: 5px; border: 3px solid #ff4d4d; box-shadow: 0 5px 15px rgba(0,0,0,0.5);">
                        </div>
                    `;
                document.querySelectorAll('.modal-box').forEach(box => {
                    box.querySelectorAll('.botli-head').forEach(el => el.remove());
                    box.querySelectorAll('img').forEach(img => {
                        if (img.src.includes('PHN2ZyB4bWx')) {
                            const wrapper = img.closest('div');
                            if (wrapper && wrapper !== box) wrapper.remove();
                            else img.remove();
                        }
                    });
                    box.insertAdjacentHTML('afterbegin', botliHeadHTML);
                    box.style.overflow = "visible";
                    box.style.position = "relative";
                    if (!box.style.paddingTop || parseInt(box.style.paddingTop) < 40) {
                        box.style.paddingTop = "45px";
                    }
                });
            }

            document.body.addEventListener('click', closeContextMenu);

            window.addEventListener('load', () => setTimeout(injectBotLiToAllModals, 500));
            document.addEventListener('click', (e) => {
                if (e.target.closest('button')) {
                    setTimeout(injectBotLiToAllModals, 50);
                }
            });
            setTimeout(injectBotLiToAllModals, 500);

            window.toggleAiCollapse = function () {
                const panel = document.getElementById('ai-panel');
                panel.classList.toggle('collapsed');

                //  砖 注专 拽, 爪专 注 转  砖  砖转驻住 转 拽 砖转驻
                if (typeof editorInstance !== 'undefined') {
                    setTimeout(() => editorInstance.layout(), 300);
                }
            };

            function parseMarkdown(text) {
                if (!text) return "";
                text = text.trim();
                const codeBlocks = [];
                text = text.replace(/`([^`\n]+)`/g, (match, code) => {
                    codeBlocks.push(`<code>${code}</code>`);
                    return `___CODE_${codeBlocks.length - 1}___`;
                });
                text = text.replace(/^### (.*$)/gim, '<h3>$1</h3>');
                text = text.replace(/^## (.*$)/gim, '<h2>$1</h2>');
                text = text.replace(/^# (.*$)/gim, '<h1>$1</h1>');
                text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                text = text.replace(/^\* (.*$)/gim, '<li>$1</li>');
                text = text.replace(/((<li>.*<\/li>\s*)+)/gim, '<ul>$1</ul>');
                text = text.replace(/^---$/gim, '<hr>');
                text = text.replace(/___CODE_(\d+)___/g, (match, index) => codeBlocks[index]);
                text = text.replace(/\r\n/g, '\n');
                text = text.replace(/\n{3,}/g, '\n\n');
                text = text.replace(/(<\/h[1-6]>)\n+/g, '$1');
                text = text.replace(/(<\/ul>)\n+/g, '$1');
                text = text.replace(/\n+(<ul>)/g, '$1');
                text = text.replace(/(<hr>)\n+/g, '$1');
                text = text.replace(/\n/g, '<br>');
                return text;
            }


        })();

        // 驻拽爪 住  (F11)
        function toggleGlobalFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log(`Error attempting to enable full-screen mode: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        //  砖 ( 注 转 拽   爪 F11 拽转)
        document.addEventListener('fullscreenchange', () => {
            const btn = document.getElementById('fs-global-btn');
            const icon = btn.querySelector('i');

            if (document.fullscreenElement) {
                icon.classList.replace('fa-expand', 'fa-compress');
                btn.title = "爪 住 ";
            } else {
                icon.classList.replace('fa-compress', 'fa-expand');
                btn.title = "住  (F11)";
            }
        });

        function enforceKioskMode() {
            //  爪   'on',  注砖 
            if (!document.body.classList.contains('kiosk-mode')) {
                document.getElementById('kiosk-overlay').style.display = 'none';
                return;
            }

            //    住  -> 转驻注 转 住!
            if (!document.fullscreenElement) {
                document.getElementById('kiosk-overlay').style.display = 'flex';
            } else {
                document.getElementById('kiosk-overlay').style.display = 'none';
            }
        }

        // 住转 拽砖 爪 拽住拽
        document.addEventListener('keydown', function (e) {
            if (!document.body.classList.contains('kiosk-mode')) return;

            // 住转 F11, Esc, 住 住转 Alt ( 转 驻砖专 -OS)
            if (e.key === 'F11' || e.key === 'Escape' || e.key === 'Alt') {
                e.preventDefault();
                e.stopPropagation();
                //  抓 Esc  F11,    砖 砖专 住 
                toggleGlobalFullScreen();
            }
        });

        // 注 驻转专 转专转  砖住 住  
        const originalLogin = document.getElementById('login-btn').onclick;
        document.getElementById('login-btn').onclick = async function () {
            // 拽 住 住 住   专
            //   砖  转专,   专 爪 on
            //   转注 住驻转 专拽 专 拽转 转砖 砖专转.
            // 转专 , 住:
            try {
                await document.documentElement.requestFullscreen();
            } catch (err) { }

            // 驻注转 驻拽爪转 转专转 拽专转 (砖爪转 转 拽 砖)
            // 注专: 注祝 砖转注转拽 转 转 -onclick 砖 驻转专 转专转   转 砖  转砖
            // 专  驻砖  住祝 转 砖专转 -FullScreen 转 驻拽爪 handleLogin 注爪.
        };

        //  砖 住   拽驻抓 转 住 
        document.addEventListener('fullscreenchange', enforceKioskMode);

        // --- 砖转 拽  砖注专 ---
        let lessonScale = 1.0; //  转转 (100%)

        function zoomLesson(change) {
            // 注 专转 
            lessonScale += change;

            // 转  ( 50% -200%)
            lessonScale = Math.min(Math.max(0.5, lessonScale), 2.0);

            // 爪转  转 ( 砖专 砖 lesson-content)
            const container = document.getElementById('lesson-content');
            if (!container || container.children.length === 0) return;

            const targetElement = container.children[0]; //  -iframe  -div 砖 拽住

            // 转 
            targetElement.style.transform = `scale(${lessonScale})`;
            targetElement.style.transformOrigin = 'top right'; // 转拽转 驻 转 注 (RTL)

            // 转拽  驻 砖 砖转 ( 注  转专转)
            if (lessonScale !== 1) {
                targetElement.style.width = `${100 / lessonScale}%`;
                targetElement.style.height = `${100 / lessonScale}%`;
            } else {
                targetElement.style.width = "100%";
                targetElement.style.height = "100%";
            }
        }

        // --- 砖转  转爪转 砖注专 ---
        let isLessonDark = true; // 专专转 : 爪 

        function toggleLessonFullScreen() {
            const panel = document.getElementById('lesson-panel');
            const icon = document.getElementById('fs-lesson-icon');

            panel.classList.toggle('lesson-fullscreen');

            // 驻转 拽
            if (panel.classList.contains('lesson-fullscreen')) {
                icon.classList.replace('fa-expand', 'fa-compress');
            } else {
                icon.classList.replace('fa-compress', 'fa-expand');
            }
        }

        function toggleLessonContrast() {
            isLessonDark = !isLessonDark;
            const container = document.getElementById('lesson-content');
            if (!container || container.children.length === 0) return;

            const content = container.children[0]; // -iframe  -div

            if (content.tagName === 'IFRAME') {
                // 驻  拽住
                content.style.filter = isLessonDark ? "invert(1) hue-rotate(180deg)" : "none";
            } else {
                // 驻 拽住 专
                if (isLessonDark) {
                    content.style.backgroundColor = ""; // 砖拽祝 (专 专拽注  砖 转专)
                    content.style.color = "#e3e3e3";
                } else {
                    content.style.backgroundColor = "#ffffff"; // 
                    content.style.color = "#000000"; // 砖专
                }
            }
        }

        function toggleMessageBubble() {
            const bubble = document.getElementById('msg-bubble');
            const content = document.getElementById('msg-bubble-content');

            //  注 专 驻转 - 住专 转
            if (bubble.style.display === 'block') {
                bubble.style.display = 'none';
                return;
            }

            // 拽 转 拽
            content.innerHTML = "";

            // 拽专转 注 转 A4
            let rawMsg = window.lastSystemMessage || "";
            rawMsg = rawMsg.trim();

            // 拽:   拽砖专  拽住?
            if (rawMsg.startsWith("http")) {
                // --- 转爪转 住 (iframe) ---
                bubble.style.width = "500px"; // 专转 注

                let src = rawMsg;
                // 专 转 爪 转爪 拽 (Preview) 拽
                if (src.includes("docs.google.com") && !src.includes("/preview")) {
                    src = src.replace(/\/edit.*/, "/preview").replace(/\/view.*/, "/preview");
                }

                const iframe = document.createElement('iframe');
                iframe.src = src;
                iframe.style.width = "100%";
                iframe.style.height = "400px";
                iframe.style.border = "none";
                iframe.style.backgroundColor = "#fff"; // 注转 专拽注 砖拽祝

                content.appendChild(iframe);

            } else {
                // --- 转爪转 拽住 专 ---
                bubble.style.width = "300px"; // 专 专 住专
                content.innerText = rawMsg || "  注转 砖转.";
            }

            bubble.style.display = 'block';

            // 住专 爪 抓
            setTimeout(() => {
                document.addEventListener('click', function closeOnClickOutside(e) {
                    if (!bubble.contains(e.target) && e.target.id !== 'msg-btn') {
                        bubble.style.display = 'none';
                        document.removeEventListener('click', closeOnClickOutside);
                    }
                });
            }, 100);
        }
        //lastSystemMessage = data.message;
        //window.lastSystemMessage = lastSystemMessage;
        function showUrlModal(url) {
            const overlay = document.getElementById('universal-modal');
            const modalBox = overlay.querySelector('.modal-box'); // <--- 转驻住 转 拽驻住
            const title = document.getElementById('u-modal-title');
            const textContainer = document.getElementById('u-modal-text');
            const btnOk = document.getElementById('u-modal-ok');
            const btnCancel = document.getElementById('u-modal-cancel');
            const input = document.getElementById('u-modal-input');

            // 驻住 
            overlay.style.display = 'flex';
            input.style.display = 'none';
            btnCancel.style.display = 'none';
            textContainer.innerHTML = "";

            // --- 专转  ---
            modalBox.style.width = "90%";
            modalBox.style.maxWidth = "600px";
            // -------------------

            title.innerText = " 注转 转";

            // 驻 拽砖专 (Preview)
            let src = url;
            if (src.includes("docs.google.com") && !src.includes("/preview")) {
                src = src.replace(/\/edit.*/, "/preview").replace(/\/view.*/, "/preview");
            }

            // 爪专转 iframe
            const iframe = document.createElement('iframe');
            iframe.src = src;
            iframe.style.width = "100%";
            iframe.style.height = "60vh"; //  住 住 (60%)
            iframe.style.border = "none";
            iframe.style.background = "#fff";
            iframe.style.borderRadius = "8px";

            textContainer.appendChild(iframe);

            // 驻转专 住专
            btnOk.innerText = '住专';
            btnOk.onclick = () => {
                overlay.style.display = 'none';
                textContainer.innerHTML = "";

                // --- 专转 专 专专转  (  专住 转专转 专转) ---
                modalBox.style.width = "";
                modalBox.style.maxWidth = "";
                // -----------------------------------------------------------
            };
        }

        (function () {
            var checkReady = setInterval(function () {
                // 拽 砖注专转 注
                if (typeof window.switchViewMode === 'function') {
                    clearInterval(checkReady);

                    // 1. 抓 
                    var aiPanel = document.getElementById('ai-panel');
                    if (aiPanel && !aiPanel.classList.contains('collapsed')) {
                        aiPanel.classList.add('collapsed');
                        // 住专 砖 砖 注专  拽
                        if (window.editorInstance) window.editorInstance.layout();
                    }

                    // 2. 注专 爪 砖注专
                    window.switchViewMode('lesson');
                }
            }, 100);
        })();


        // --- 拽 注专 拽 (住  + 注专转 砖) ---
        let isEditorDark = true;

        function toggleEditorFullScreen() {
            const wrapper = document.getElementById('editor-wrapper');
            const icon = document.getElementById('fs-editor-icon');

            wrapper.classList.toggle('editor-fullscreen');

            // 驻转 拽 注  注专
            if (wrapper.classList.contains('editor-fullscreen')) {
                icon.classList.replace('fa-expand', 'fa-compress');
            } else {
                icon.classList.replace('fa-compress', 'fa-expand');
            }

            if (editorInstance) editorInstance.layout();
        }

        function toggleEditorTheme() {
            isEditorDark = !isEditorDark;

            if (isEditorDark) {
                monaco.editor.setTheme('java-custom'); // 注专  砖爪专
            } else {
                monaco.editor.setTheme('vs'); // 注专 专 转 砖 拽
            }
        }



    </script>


    <div id="kiosk-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 999999; justify-content: center; align-items: center; flex-direction: column; text-align: center;">
        <h1 style="color: red; font-size: 30px;">锔 爪转 住 !</h1>
        <p style="color: white; font-size: 18px;">专 专 爪 注. 注 专 住   砖.</p>
        <button onclick="toggleGlobalFullScreen()" style="padding: 15px 30px; font-size: 20px; background: #a8c7fa; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">专 住  </button>
    </div>
</body>
</html>
